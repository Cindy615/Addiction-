<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç™®é˜²æ²»ç§‘å„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fbfbf2;
        }
        .container-fluid {
            min-height: calc(100vh - 4rem);
        }
        .scroll-container {
            max-height: calc(100vh - 12rem);
            overflow-y: auto;
        }
        .member-container::-webkit-scrollbar {
            display: none;
        }
        .member-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .tab-button.active {
            background-color: #5b6b51;
            color: white;
            box-shadow: 0 4px 6px rgba(91, 107, 81, 0.3);
        }
        .tab-button {
            background-color: #c3b4a3;
            color: #0d3136;
            font-weight: 600;
        }
        .tab-button:hover {
            background-color: #a99a8a;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-content-lg {
            max-width: 800px;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #0d3136;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        
        #password-screen, #dashboard-container {
             background-color: #fbfbf2;
        }
         aside.bg-white, #mainContent.bg-white, .modal-content, #password-screen > div {
            background-color: #FFFFFF;
         }

        h1, h2, h3, .text-gray-800, .text-gray-900 {
            color: #0d3136;
        }
        p, span, label, .text-gray-500, .text-gray-600, .text-gray-700 {
            color: #5b6b51;
        }
        .text-primary-title { color: #0d3136; }
        .text-link-title { color: #0d3136; }
        .text-link-title:hover { color: #3f7585; }

         .input, .select-filter {
             border: 1px solid #c3b4a3;
             padding: 8px 12px;
             border-radius: 8px;
             background-color: #FFFFFF;
             height: 42px;
         }
         .input:focus, .select-filter:focus {
             outline: 2px solid transparent;
             outline-offset: 2px;
             border-color: #5b6b51;
             box-shadow: 0 0 0 2px rgba(91, 107, 81, 0.5);
         }
         .btn {
             padding: 10px 20px;
             border-radius: 8px;
             font-weight: 600;
             transition: all 0.2s;
         }
         
         .filter-btn {
             font-weight: 700;
             padding-top: 0.5rem;
             padding-bottom: 0.5rem;
             padding-left: 1rem;
             padding-right: 1rem;
             border-radius: 0.5rem;
             transition: all 0.2s;
             width: 100%;
         }
         @media (min-width: 768px) {
             .filter-btn {
                 width: auto;
             }
         }
         .filter-btn-active {
             background-color: #5b6b51;
             color: white;
             box-shadow: 0 4px 6px rgba(91, 107, 81, 0.3);
         }
         .filter-btn-inactive {
             background-color: #FFFFFF;
             border: 1px solid #c3b4a3;
             color: #5b6b51;
         }
         .filter-btn-inactive:hover {
             background-color: #f7f5f2;
         }
         
         .animate-spin { color: #5b6b51; }

        .btn-primary { background-color: #3f7585; color: white; }
        .btn-primary:hover { background-color: #2a5a6a; }
        .btn-secondary { background-color: #FFFFFF; border: 1px solid #c3b4a3; color: #5b6b51; }
        .btn-secondary:hover { background-color: #f7f5f2; }
        .btn-danger { background-color: #D05A6E; color: white; }
        .btn-danger:hover { background-color: #b84a5e; }
        .btn-warning { background-color: #c3b4a3; color: #0d3136; }
        .btn-warning:hover { background-color: #a99a8a; }
        .btn-special { background-color: #3f7585; color: white; }
        .btn-special:hover { background-color: #2a5a6a; }

        .job-color-1, .job-color-2, .job-color-3, .job-color-4, .job-color-5, .job-color-default {
            background-color: #f7f5f2; 
            border-left: 4px solid #c3b4a3; 
            color: #0d3136; 
        }
        .job-color-1 { border-left-color: #5b6b51; }
        .job-color-2 { border-left-color: #3f7585; }
        .job-color-4 { border-left-color: #5b6b51; }
        .job-color-5 { border-left-color: #3f7585; }

        .priority-high { background-color: #D05A6E; color: white; }
        .priority-medium { background-color: #c3b4a3; color: #0d3136; }
        .priority-low { background-color: #5b6b51; color: white; }

        .status-inprogress { background-color: #3f7585; color: white; }
        .status-done { background-color: #5b6b51; color: white; }
        .status-done-late { background-color: #a99a8a; color: #0d3136; }
        .status-overdue { background-color: #D05A6E; color: white; }
        .status-planning { background-color: #c3b4a3; color: #0d3136; }
        .status-paused { background-color: #a99a8a; color: #0d3136; }

        .case-status-v { background-color: #5b6b51; color: white; }
        .case-status-n { background-color: #D05A6E; color: white; }
        .case-status-a { background-color: #c3b4a3; color: #0d3136; }
        .case-status-default { background-color: #a99a8a; color: #0d3136; }

        .case-bg-high { background-color: #f9ebee; }
        .case-bg-medium { background-color: #f5f2ef; }
         .case-bg-default { background-color: #FFFFFF; }

        .monitor-border-level-1 { border-left: 4px solid #22c55e; }
        .monitor-border-level-2 { border-left: 4px solid #eab308; }
        .monitor-border-level-3 { border-left: 4px solid #f43f5e; }
        .monitor-border-level-4 { border-left: 4px solid #7f1d1d; }
        .monitor-border-closed { border-left: 4px solid #9ca3af; }
        .monitor-border-default { border-left: 4px solid #dcdcdc; }

        /* Calendar Styles (Enhanced) */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb; /* Grid lines color */
            border: 1px solid #e5e7eb;
        }
        .calendar-day-header {
            font-weight: 600;
            color: #0d3136;
            text-align: center;
            padding: 12px 0;
            font-size: 0.875rem;
            background-color: #f3f4f6;
        }
        .calendar-day {
            min-height: 120px;
            background-color: #FFFFFF;
            position: relative;
            transition: background-color 0.2s;
        }
        .calendar-day:hover {
            background-color: #fafafa;
        }
        .calendar-day-empty {
            min-height: 120px;
            background-color: #f9fafb;
        }
        .day-content {
            padding: 8px;
            height: 100%;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }
        .day-header {
            display: flex;
            justify-content: center; /* Center the number */
            align-items: center;
            margin-bottom: 6px;
        }
        .day-number {
            font-weight: 500;
            color: #374151;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 0.85rem;
        }
        .day-number.today {
            background-color: #3f7585; /* Brand Blue/Green */
            color: white;
            font-weight: bold;
        }
        
        /* Event Chip Style - Google Calendar Like */
        .event-chip {
            font-size: 0.75rem;
            padding: 2px 6px;
            margin-bottom: 2px;
            border-radius: 4px;
            background-color: #e0f2fe; /* Light Blue */
            color: #0369a1; /* Dark Blue Text */
            border-left: 3px solid #0284c7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1.3;
        }
        .event-chip:hover {
            opacity: 0.9;
            background-color: #bae6fd;
            transform: translateY(-1px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .event-chip-time {
            font-weight: 700;
            margin-right: 4px;
            font-size: 0.7rem;
        }

        /* Badge Styles for Monitoring */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        .badge-level-1 { background-color: #dcfce7; color: #15803d; } 
        .badge-level-2 { background-color: #fef9c3; color: #a16207; } 
        .badge-level-3 { background-color: #fee2e2; color: #b91c1c; } 
        .badge-level-4 { background-color: #7f1d1d; color: #ffffff; } 
        .badge-closed { background-color: #e5e7eb; color: #374151; } 

        .badge-container {
            display: flex;
            flex-wrap: wrap;
            align-content: flex-end;
        }

        .progress-bar-inner { background-color: #3f7585; }
        .checklist-item-wrapper { background-color: #f7f5f2; }
        .modal-close-btn { color: #c3b4a3; }
        .modal-close-btn:hover { color: #5b6b51; }
    </style>
</head>
<body class="p-6 md:p-10">
    
    <div id="connection-error-banner" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-[9999] shadow-lg">
        <div class="max-w-4xl mx-auto flex items-start">
            <svg class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div class="flex-1">
                <h3 class="font-bold text-lg">é€£ç·šç™¼ç”Ÿå•é¡Œ</h3>
                <p class="mt-1">ç³»çµ±ç„¡æ³•å¾ Google è©¦ç®—è¡¨è®€å–è³‡æ–™ã€‚</p>
                <div class="mt-3 bg-red-800 p-3 rounded text-sm">
                    <a id="debug-link" href="#" target="_blank" class="inline-block bg-white text-red-700 px-4 py-2 rounded font-bold hover:bg-gray-100 transition-colors">ğŸ‘‰ é»æ­¤é–‹å•Ÿ API è¨ºæ–·é€£çµ</a>
                </div>
                <button onclick="document.getElementById('connection-error-banner').classList.add('hidden')" class="mt-3 text-sm underline hover:text-red-200">é—œé–‰æç¤º</button>
            </div>
        </div>
    </div>

    <div id="password-screen" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-xl shadow-2xl text-center w-full max-w-sm">
            <img src="https://i.ibb.co/xSy5QZ10/LOGO-1.png" alt="Logo" class="w-auto h-20 mx-auto mb-4">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">è«‹è¼¸å…¥å¯†ç¢¼</h1>
            <p class="text-gray-500 mb-6">è«‹è¼¸å…¥å¯†ç¢¼ä»¥å­˜å–å„€è¡¨æ¿ã€‚</p>
            <form id="password-form">
                <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 text-center" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                <button type="submit" class="w-full btn btn-primary py-2 px-4 shadow-md">é€²å…¥</button>
                <p id="password-error" class="text-red-500 text-sm mt-4 h-5"></p>
            </form>
        </div>
    </div>

    <div id="dashboard-container" class="hidden max-w-full mx-auto">
        <div class="flex flex-col items-center mb-6 gap-4">
            <div class="flex items-center">
                <img src="https://i.ibb.co/xSy5QZ10/LOGO-1.png" alt="å¥‡ç¾é†«é™¢æˆç™®é˜²æ²»ç§‘ LOGO" class="w-auto h-16 shadow-lg">
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center">æˆç™®é˜²æ²»ç§‘å„€è¡¨æ¿</h1>
            <div class="flex flex-wrap items-center md:flex-row gap-4">
                <div class="flex gap-2 flex-wrap justify-center">
                    <button id="welcomeBtn" data-view="welcome" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">ä¸»é </button>
                    <button id="eventsBtn" data-view="events" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">åœ˜éšŠæœƒè­°</button>
                    <button id="projectsBtn" data-view="projects" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">åœ˜éšŠå°ˆæ¡ˆ</button>
                    <button id="todosBtn" data-view="todos" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">å¾…è¾¦äº‹é …</button>
                    <button id="casesBtn" data-view="cases" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">å€‹æ¡ˆè£œåŠ©è¿½è¹¤</button>
                    <button id="monitoringBtn" data-view="monitoring" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">é–€è¨ºç›£æ¸¬</button>
                </div>
            </div>
        </div>

        <div class="flex flex-col-reverse md:flex-row gap-6 container-fluid">
            <aside class="w-full md:w-80 bg-white rounded-xl shadow-lg p-6 member-container">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">åœ˜éšŠæˆå“¡</h2>
                <div id="memberList" class="space-y-2 mb-4">
                    <div class="text-center p-8 text-gray-500">è¼‰å…¥ä¸­...</div>
                </div>
            </aside>

            <div id="mainContent" class="flex-1 bg-white rounded-xl shadow-lg p-6 flex flex-col">
                <div class="flex items-center justify-between mb-4">
                    <p id="lastUpdated" class="text-sm text-gray-500">ä¸Šæ¬¡æ›´æ–°ï¼šè¼‰å…¥ä¸­...</p>
                    <div id="loadingIndicator" class="hidden flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-sm text-gray-500">æ›´æ–°ä¸­...</span>
                    </div>
                </div>
                
                <div id="pageContainer" class="flex-1 overflow-y-auto relative">
                    <div class="text-center p-8 text-gray-500">è³‡æ–™è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-notification" class="toast"></div>

    <!-- Modals -->

    <!-- Add/Edit Event Modal -->
    <div id="addEventModal" class="modal">
        <div class="modal-content modal-content-lg p-8">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 id="eventModalTitle" class="text-2xl font-bold">æ–°å¢/ç·¨è¼¯æœƒè­°</h3>
                <button onclick="window.closeModal('addEventModal')" class="modal-close-btn text-3xl font-bold">&times;</button>
            </div>
            <form id="addEventForm" class="space-y-6">
                <input type="hidden" id="editEventId">
                <div>
                    <label for="eventName" class="block text-sm font-medium">æœƒè­°åç¨± (å¿…å¡«)</label>
                    <input type="text" id="eventName" required class="mt-1 block w-full input" placeholder="ä¾‹å¦‚ï¼šåœ˜éšŠé€±æœƒ">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="eventDate" class="block text-sm font-medium">æ—¥æœŸ (å¿…å¡«)</label>
                        <input type="date" id="eventDate" required class="mt-1 block w-full input">
                    </div>
                    <div>
                        <label for="eventStartTime" class="block text-sm font-medium">é–‹å§‹æ™‚é–“</label>
                        <input type="time" id="eventStartTime" class="mt-1 block w-full input">
                    </div>
                    <div>
                        <label for="eventEndTime" class="block text-sm font-medium">çµæŸæ™‚é–“</label>
                        <input type="time" id="eventEndTime" class="mt-1 block w-full input">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="eventOrganizer" class="block text-sm font-medium">ä¸»è¾¦å–®ä½</label>
                        <input type="text" id="eventOrganizer" class="mt-1 block w-full input">
                    </div>
                    <div>
                        <label for="eventContact" class="block text-sm font-medium">è¯çµ¡äºº</label>
                        <input type="text" id="eventContact" class="mt-1 block w-full input">
                    </div>
                </div>
                <div>
                    <label for="eventNote" class="block text-sm font-medium">å‚™è¨» / è­°ç¨‹</label>
                    <textarea id="eventNote" rows="3" class="mt-1 block w-full input" placeholder="è«‹è¼¸å…¥æœƒè­°å…§å®¹æˆ–å‚™è¨»..."></textarea>
                </div>
                <div class="flex justify-end gap-4 pt-4 border-t">
                    <button type="button" id="formDeleteEventBtn" class="btn btn-danger mr-auto" style="display: none;">åˆªé™¤</button>
                    <button type="button" onclick="window.closeModal('addEventModal')" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Case Modal -->
    <div id="caseModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h3 id="caseModalTitle" class="text-2xl font-bold">å€‹æ¡ˆè©³æƒ…</h3>
                <button onclick="window.closeModal('caseModal')" class="modal-close-btn text-3xl font-bold">&times;</button>
            </div>
            <div class="space-y-2">
                <p><strong>å€‹æ¡ˆå§“å:</strong> <span id="caseModalCaseName"></span></p>
                <p><strong>èº«åˆ†åˆ¥:</strong> <span id="caseModalIdentity" class="px-2 py-0.5 rounded bg-indigo-100 text-indigo-800 text-sm font-bold"></span></p>
                <p><strong>ç—…æ­·è™Ÿ:</strong> <span id="caseModalRecordNumber"></span></p>
                <p><strong>å€‹ç®¡å¸« / ä¸»æ²»é†«å¸«:</strong> <span id="caseModalManagerDoctor"></span></p>
                <div class="bg-gray-50 p-3 rounded-md border border-gray-200 mt-2">
                    <p class="text-sm font-bold text-gray-700 mb-1">è¿‘æ³èªªæ˜ï¼š</p>
                    <p id="caseModalRecentStatus" class="text-sm text-gray-600 whitespace-pre-line">ç„¡</p>
                </div>
                <hr class="my-3">
                <p><strong>å·²ä½¿ç”¨ç¸½é¡:</strong> <span id="caseModalTotalUsed"></span></p>
                <p><strong>ç¸½é¡é¤˜é¡:</strong> <span id="caseModalTotalRemaining"></span></p>
                <hr class="my-3">
                <p><strong>å·²ä½¿ç”¨è—¥è²»:</strong> <span id="caseModalMedicationUsed"></span></p>
                <p><strong>è—¥è²»é¤˜é¡:</strong> <span id="caseModalMedicationRemaining"></span></p>
                <p><strong>è—¥ç‰©ç¨®é¡:</strong> <span id="caseModalMedicationType"></span></p>
                <p><strong>å¯å†é–‹å¹¾ç²’:</strong> <span id="caseModalPillsRemaining"></span></p>
            </div>
        </div>
    </div>
    
    <!-- Project Modals -->
    <div id="addProjectModal" class="modal"><div class="modal-content modal-content-lg p-8"><div class="flex justify-between items-center border-b pb-4 mb-6"><h3 id="projectModalTitle" class="text-2xl font-bold">æ–°å¢é …ç›®</h3><button onclick="window.closeModal('addProjectModal')" class="modal-close-btn text-3xl font-bold">&times;</button></div><form id="addProjectForm" class="space-y-6"><input type="hidden" id="editProjectId"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div><label for="projectName" class="block text-sm font-medium">é …ç›®åç¨± (å¿…å¡«)</label><input type="text" id="projectName" required class="mt-1 block w-full input"></div><div><label for="projectGroup" class="block text-sm font-medium">æ‰€å±¬å°çµ„ (å¿…å¡«)</label><select id="projectGroup" required class="mt-1 block w-full input"><option>é™¢å…§</option><option>é…’ç™®è¨ˆç•«</option><option>ç›£æ‰€è¨ˆç•«</option><option>è—¥ç™®æ•´åˆè¨ˆç•«1</option><option>è—¥ç™®æ•´åˆè¨ˆç•«2</option><option>ç¾æ²™å†¬è¨ˆç•«</option></select></div><div><label for="projectType" class="block text-sm font-medium">é¡å‹ (å¿…å¡«)</label><select id="projectType" required class="mt-1 block w-full input"><option>ä»»å‹™</option><option>å°ˆæ¡ˆ</option><option>ç ”ç©¶</option><option>æ¯”è³½</option></select></div></div><div><label for="projectDescription" class="block text-sm font-medium">é …ç›®å‚™è¨»èªªæ˜</label><textarea id="projectDescription" rows="3" class="mt-1 block w-full input" placeholder="è«‹è¼¸å…¥æ­¤é …ç›®çš„è©³ç´°èªªæ˜æˆ–å‚™è¨»..."></textarea></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-sm font-medium">ä¸»è¦è² è²¬äºº (å¯è¤‡é¸)</label><div id="projectLeadSelection" class="mt-1 h-32 overflow-y-auto p-2 border rounded-md bg-gray-50 space-y-2"></div></div><div><div class="flex justify-between items-center"><label class="block text-sm font-medium">å”åŒäººå“¡ (å¯è¤‡é¸)</label><div class="flex items-center"><input type="checkbox" id="selectAllTeam" class="h-4 w-4 rounded"><label for="selectAllTeam" class="ml-2 block text-sm">å…¨é¸</label></div></div><div id="projectTeamSelection" class="mt-1 h-32 overflow-y-auto p-2 border rounded-md bg-gray-50 space-y-2"></div></div></div><div><label class="block text-sm font-medium">æª¢æŸ¥é» (Checklist)</label><div class="flex items-center gap-2 mt-1"><input type="text" id="newChecklistItemInput" placeholder="æ–°å¢æª¢æŸ¥é»..." class="flex-1 block w-full input"><button type="button" id="addChecklistItemBtn" class="btn btn-special px-4 py-2">æ–°å¢</button></div><div id="checklistItemContainer" class="mt-2 space-y-2 h-24 overflow-y-auto p-2 border rounded-md"></div></div><div class="grid grid-cols-1 md:grid-cols-4 gap-6"><div><label for="projectStatus" class="block text-sm font-medium">ç‹€æ…‹ (å¿…å¡«)</label><select id="projectStatus" required class="mt-1 block w-full input"><option>è¦åŠƒä¸­</option><option>é€²è¡Œä¸­</option><option>å·²å®Œæˆ</option><option>æš«åœ</option><option>é€¾æœŸ</option></select></div><div><label for="projectPriority" class="block text-sm font-medium">å„ªå…ˆç´š</label><select id="projectPriority" class="mt-1 block w-full input"><option>ä½</option><option>ä¸­</option><option>é«˜</option></select></div><div><label for="startDate" class="block text-sm font-medium">é–‹å§‹æ—¥æœŸ (å¿…å¡«)</label><input type="date" id="startDate" required class="mt-1 block w-full input"></div><div><label for="endDate" class="block text-sm font-medium">æˆªæ­¢æ—¥æœŸ (å¿…å¡«)</label><input type="date" id="endDate" required class="mt-1 block w-full input"></div></div><div class="flex justify-end gap-4 pt-4 border-t"><button type="button" onclick="window.closeModal('addProjectModal')" class="btn btn-secondary">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">å„²å­˜</button></div></form></div></div>
    
    <div id="projectDetailModal" class="modal">
        <div class="modal-content modal-content-lg p-8">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 id="detailProjectName" class="text-2xl font-bold">å°ˆæ¡ˆè©³æƒ…</h3>
                <button onclick="window.closeModal('projectDetailModal')" class="modal-close-btn text-3xl font-bold">&times;</button>
            </div>
            <div id="detailProjectProgress" class="mb-6"></div>
            <div id="projectDetailContent" class="space-y-4"></div>
            <div id="detailProjectChecklist" class="mt-6 space-y-2"></div>
            <div class="flex justify-end gap-4 pt-6 border-t mt-6">
                <button id="deleteProjectBtn" class="btn btn-danger" style="display: none;">åˆªé™¤</button>
                <button id="editProjectBtn" class="btn btn-warning" style="display: none;">ç·¨è¼¯</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Delete Modal -->
    <div id="deleteConfirmModal" class="modal"><div class="modal-content p-8 text-center"><h3 class="text-xl font-bold mb-4">ç¢ºèªåˆªé™¤</h3><p class="text-gray-600 mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ<br>æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p><div class="flex justify-center gap-4"><button onclick="window.closeModal('deleteConfirmModal')" class="btn btn-secondary">å–æ¶ˆ</button><button id="confirmDeleteBtn" class="btn btn-danger">ç¢ºèªåˆªé™¤</button></div></div></div>

    <!-- Monitoring Modals -->
    <div id="addMonitoringModal" class="modal">
        <div class="modal-content modal-content-lg p-8">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 id="monitoringModalTitle" class="text-2xl font-bold">æ–°å¢/ç·¨è¼¯é–€è¨ºé …ç›®</h3>
                <button onclick="window.closeModal('addMonitoringModal')" class="modal-close-btn text-3xl font-bold">&times;</button>
            </div>
            <form id="addMonitoringForm" class="space-y-6">
                <input type="hidden" id="editMonitoringId">
                <div>
                    <label for="monitoringItemName" class="block text-sm font-medium">é–€è¨º (å¿…å¡«)</label>
                    <select id="monitoringItemName" required class="mt-1 block w-full input">
                        <option value="">è«‹é¸æ“‡ç­åˆ¥...</option>
                        <option value="Y798é…’ç™®(æ¨¹æ—)">Y798é…’ç™®(æ¨¹æ—)</option>
                        <option value="Y795è—¥ç™®(æ¨¹æ—)">Y795è—¥ç™®(æ¨¹æ—)</option>
                        <option value="779Wé…’ç™®(ç¸½é™¢)">779Wé…’ç™®(ç¸½é™¢)</option>
                        <option value="7790ç²¾ç¥ç§‘(ç¸½é™¢)">7790ç²¾ç¥ç§‘(ç¸½é™¢)</option>
                        <option value="7791ç²¾ç¥ç§‘(æ¨¹æ—)">7791ç²¾ç¥ç§‘(æ¨¹æ—)</option>
                        <option value="779Mç¾æ²™å†¬">779Mç¾æ²™å†¬</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="monitoringDate" class="block text-sm font-medium">æ—¥æœŸ (å¿…å¡«)</label>
                        <input type="date" id="monitoringDate" required class="mt-1 block w-full input">
                        <p id="monitoringDateHint" class="text-xs text-gray-500 mt-1">è«‹é¸æ“‡é–€è¨ºæ—¥æœŸã€‚</p>
                        <p id="monitoringDateError" class="text-xs text-red-500 mt-1 hidden"></p>
                    </div>
                    <div>
                        <label for="monitoringRegisteredCount" class="block text-sm font-medium">å·²æ›è™Ÿäººæ•¸</label>
                        <input type="number" id="monitoringRegisteredCount" class="mt-1 block w-full input" placeholder="0">
                    </div>
                    <div>
                        <label for="monitoringNewCases" class="block text-sm font-medium">æ–°æ¡ˆ</label>
                        <input type="number" id="monitoringNewCases" class="mt-1 block w-full input" placeholder="0">
                    </div>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="monitoringIsClosed" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="monitoringIsClosed" class="ml-3 block text-sm font-medium text-gray-700">æ­¤ç­åˆ¥åœè¨º</label>
                </div>
                <div class="flex justify-end gap-4 pt-4 border-t">
                    <button type="button" id="formDeleteMonitoringBtn" class="btn btn-danger mr-auto" style="display: none;">åˆªé™¤</button>
                    <button type="button" onclick="window.closeModal('addMonitoringModal')" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="monitoringDayDetailModal" class="modal">
        <div class="modal-content modal-content-lg p-8">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 id="monitoringDayDetailTitle" class="text-2xl font-bold">é–€è¨ºè©³æƒ…</h3>
                <button onclick="window.closeModal('monitoringDayDetailModal')" class="modal-close-btn text-3xl font-bold">&times;</button>
            </div>
            <div id="monitoringDayDetailContent" class="space-y-4 max-h-96 overflow-y-auto">
                <p>è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- Todo Modal -->
    <div id="addTodoModal" class="modal">
        <div class="modal-content modal-content-lg p-8">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 id="todoModalTitle" class="text-2xl font-bold">æ–°å¢å¾…è¾¦äº‹é …</h3>
                <button onclick="window.closeModal('addTodoModal')" class="modal-close-btn text-3xl font-bold">&times;</button>
            </div>
            <form id="addTodoForm" class="space-y-6">
                <input type="hidden" id="editTodoId">
                <div>
                    <label for="todoName" class="block text-sm font-medium">äº‹é …åç¨± (å¿…å¡«)</label>
                    <input type="text" id="todoName" required class="mt-1 block w-full input">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="todoStatus" class="block text-sm font-medium">ç‹€æ…‹</label>
                        <select id="todoStatus" class="mt-1 block w-full input">
                            <option>å¾…è¾¦</option>
                            <option>é€²è¡Œä¸­</option>
                            <option>å®Œæˆ</option>
                        </select>
                    </div>
                    <div>
                        <label for="todoPriority" class="block text-sm font-medium">å„ªå…ˆç´š</label>
                        <select id="todoPriority" class="mt-1 block w-full input">
                            <option>ä½</option>
                            <option>ä¸­</option>
                            <option>é«˜</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="todoAssigner" class="block text-sm font-medium">æŒ‡æ´¾äºº</label>
                        <select id="todoAssigner" class="mt-1 block w-full input">
                            <option value="">è«‹é¸æ“‡...</option>
                        </select>
                    </div>
                    <div>
                        <label for="todoAssignee" class="block text-sm font-medium">è² è²¬äºº</label>
                        <select id="todoAssignee" class="mt-1 block w-full input">
                            <option value="">è«‹é¸æ“‡...</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="todoDueDate" class="block text-sm font-medium">æˆªæ­¢æ—¥æœŸ</label>
                    <input type="date" id="todoDueDate" class="mt-1 block w-full input">
                </div>
                <div>
                    <label for="todoNote" class="block text-sm font-medium">å‚™è¨»</label>
                    <textarea id="todoNote" rows="3" class="mt-1 block w-full input"></textarea>
                </div>
                <div class="flex justify-end gap-4 pt-4 border-t">
                    <button type="button" id="formDeleteTodoBtn" class="btn btn-danger mr-auto" style="display: none;">åˆªé™¤</button>
                    <button type="button" onclick="window.closeModal('addTodoModal')" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbyQcvvWP3KznPjzXbPUvja8ByyTT4a2F0BwfN0yBekNJzsruVKtOEIycELcFVcuJMTy/exec';
        
        let allCasesData = [], allEventsData = [], allMembersData = [], allProjectsData = [], allMonitoringData = [], allTodosData = [];
        let currentView = 'welcome';
        let currentEventViewMode = 'calendar'; // 'calendar' or 'list'

        const jobTitleColors = { 'é†«å¸«': 'job-color-1', 'è‡¨åºŠå¿ƒç†å¸«': 'job-color-2', 'å€‹ç®¡å¸«': 'job-color-3', 'ç ”ç©¶åŠ©ç†': 'job-color-4', 'ç¤¾å·¥': 'job-color-5', 'default': 'job-color-default' };
        const priorityColors = { 'é«˜': 'priority-high', 'ä¸­': 'priority-medium', 'ä½': 'priority-low' };
        
        function formatCurrency(n) { return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(n); }
        
        function toISODateString(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr.split('T')[0] + 'T00:00:00');
                if (isNaN(date.getTime())) return '';
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                console.error("toISODateString è½‰æ›å¤±æ•—:", dateStr, e);
                return '';
            }
        }
        
        function getCalculatedProjectStatus(project) {
            let checkpoints = Array.isArray(project['æª¢æŸ¥é»']) ? project['æª¢æŸ¥é»'] : [];
            try {
                if (typeof project['æª¢æŸ¥é»'] === 'string' && project['æª¢æŸ¥é»']) {
                    checkpoints = JSON.parse(project['æª¢æŸ¥é»']);
                }
            } catch(e) { checkpoints = []; }
            
            const totalTasks = checkpoints.length;
            const completedTasks = checkpoints.filter(item => item.completed).length;
            const progress = (totalTasks > 0) ? (completedTasks / totalTasks) * 100 : 0;
            
            const endDate = new Date(project['æˆªæ­¢æ—¥æœŸ'] + 'T23:59:59');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let status = project['ç‹€æ…‹'];
            let colorClass = 'status-inprogress';
            let isCompleted = false;
            
            if (progress === 100) {
                status = 'å·²å®Œæˆ';
                colorClass = 'status-done';
                isCompleted = true;
                if (endDate < today) {
                    status = 'å·²å®Œæˆä½†é€¾æœŸ';
                    colorClass = 'status-done-late';
                }
            } else if (endDate < today) {
                status = 'é€¾æœŸ';
                colorClass = 'status-overdue';
            } else {
                if (status === 'è¦åŠƒä¸­') colorClass = 'status-planning';
                else if (status === 'æš«åœ') colorClass = 'status-paused';
            }
            
            return { 
                status: status, 
                colorClass: colorClass, 
                progress: progress, 
                isCompleted: isCompleted,
                totalTasks: totalTasks,
                completedTasks: completedTasks
            };
        }

        function renderWelcomeMonitoring() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const sevenDaysFromNow = new Date(today);
            sevenDaysFromNow.setDate(today.getDate() + 7);
            sevenDaysFromNow.setHours(23, 59, 59, 999);

            const upcomingMonitoring = allMonitoringData
                .filter(item => {
                    if (!item['æ—¥æœŸ']) return false;
                    const itemDate = new Date(item['æ—¥æœŸ'].split('T')[0] + 'T00:00:00');
                    return itemDate >= today && itemDate <= sevenDaysFromNow;
                })
                .sort((a, b) => new Date(a['æ—¥æœŸ']) - new Date(b['æ—¥æœŸ']));

            if (upcomingMonitoring.length === 0) {
                return '<div class="col-span-full text-center p-4 text-gray-500 bg-gray-50 rounded-lg">æœªä¾†ä¸€é€±æ²’æœ‰æ’å®šçš„é–€è¨ºç›£æ¸¬é …ç›®ã€‚</div>';
            }

            return upcomingMonitoring.map(item => {
                const isClosed = item['æ˜¯å¦åœè¨º'] === 'æ˜¯';
                const itemDate = formatSimpleDate(item['æ—¥æœŸ']);
                let cardBorderColor = 'monitor-border-default';
                let contentHtml = '';
                
                if (isClosed) {
                    cardBorderColor = 'monitor-border-closed';
                    contentHtml = `<p class="text-lg font-semibold text-gray-500">åœè¨º</p>`;
                } else {
                    const registered = parseInt(item['å·²æ›è™Ÿäººæ•¸'] || 0, 10);
                    if (registered >= 16) cardBorderColor = 'monitor-border-level-4';
                    else if (registered >= 11) cardBorderColor = 'monitor-border-level-3';
                    else if (registered >= 6) cardBorderColor = 'monitor-border-level-2';
                    else cardBorderColor = 'monitor-border-level-1';
                    
                    contentHtml = `<p class="text-2xl font-bold text-gray-800">${registered}</p>
                                   <p class="text-sm text-gray-500">å·²æ›è™Ÿ</p>`;
                }

                return `
                    <div class="bg-white ${cardBorderColor} rounded-xl shadow-lg p-4 flex items-center gap-4 cursor-pointer hover:shadow-xl" ondblclick="window.openEditMonitoringModal('${item.ID}')">
                        <div class="text-center w-16">
                            ${contentHtml}
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-600">${itemDate}</p>
                            <p class="text-sm font-medium text-gray-800">${item['é–€è¨º']}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderWelcomeProjects() {
            const inProgressProjects = allProjectsData
                .map(project => ({
                    project,
                    statusInfo: getCalculatedProjectStatus(project)
                }))
                .filter(item => !item.statusInfo.isCompleted)
                .sort((a, b) => new Date(a.project['æˆªæ­¢æ—¥æœŸ']) - new Date(b.project['æˆªæ­¢æ—¥æœŸ']));

            if (inProgressProjects.length === 0) {
                return '<div class="text-center p-4 text-gray-500 bg-gray-50 rounded-lg">ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„å°ˆæ¡ˆã€‚</div>';
            }

            return inProgressProjects.map(({ project, statusInfo }) => {
                const { status, colorClass, progress } = statusInfo;
                
                return `
                    <div class="bg-white rounded-xl shadow-lg p-4 cursor-pointer border border-gray-200 hover:shadow-xl transition-shadow" onclick="window.showProjectDetails('${project.ID}')" ondblclick="window.openEditProjectModal('${project.ID}')">
                        <div class="flex flex-col md:flex-row md:items-center gap-4">
                            <div class="flex-1">
                                <p class="text-lg font-bold text-link-title">${project['å°ˆæ¡ˆåç¨±']}</p>
                                <p class="text-sm text-gray-500"><strong>è² è²¬:</strong> ${project['ä¸»è¦è² è²¬'] || 'N/A'}</p>
                                <p class="text-sm text-gray-500"><strong>æˆªæ­¢:</strong> ${formatSimpleDate(project['æˆªæ­¢æ—¥æœŸ'])}</p>
                            </div>
                            <div class="w-full md:w-48">
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="font-semibold px-2 py-1 rounded ${colorClass}">${status}</span>
                                    <span class="text-gray-600">${progress.toFixed(0)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="progress-bar-inner h-2 rounded-full" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadInitialDashboardData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const lastUpdatedElement = document.getElementById('lastUpdated');
            loadingIndicator.classList.remove('hidden');
            lastUpdatedElement.textContent = 'æ›´æ–°ä¸­...';
            
            try {
                const [membersRaw, projectsRaw, monitoringRaw] = await Promise.all([
                    fetchData('åœ˜éšŠæˆå“¡'), 
                    fetchData('åœ˜éšŠå°ˆæ¡ˆ'),
                    fetchData('é–€è¨ºç›£æ¸¬')
                ]);
                
                allMembersData = (Array.isArray(membersRaw) ? membersRaw : []);
                allProjectsData = (Array.isArray(projectsRaw) ? projectsRaw : []);
                allMonitoringData = (Array.isArray(monitoringRaw) ? monitoringRaw : []);
                
                renderWelcomePage();
                renderMembersList(allProjectsData);
                
                const welcomeBtn = document.getElementById('welcomeBtn');
                if (welcomeBtn) {
                    welcomeBtn.classList.add('active');
                }
                
                lastUpdatedElement.textContent = `ä¸Šæ¬¡æ›´æ–°ï¼š${new Date().toLocaleTimeString('zh-TW')}`;
                
            } catch (error) {
                console.error(`ç„¡æ³•å–å¾—åˆå§‹å„€è¡¨æ¿è³‡æ–™:`, error);
                let errorMessage = `<div class="text-center p-8 text-red-500">ç„¡æ³•è¼‰å…¥åˆå§‹è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚(${error.message})</div>`;
                if (error.message && error.message.includes("æ‰¾ä¸åˆ°å·¥ä½œè¡¨")) {
                    const sheetNameMatch = error.message.match(/æ‰¾ä¸åˆ°å·¥ä½œè¡¨: (.+)/);
                    const sheetName = sheetNameMatch ? sheetNameMatch[1].trim() : "æœªçŸ¥";
                    errorMessage = `
                        <div class="text-center p-8 text-gray-700 bg-red-50 rounded-lg border border-red-200">
                            <h3 class="text-xl font-bold text-red-600 mb-3">è³‡æ–™è¼‰å…¥å¤±æ•—</h3>
                            <p>ç³»çµ±åœ¨æ‚¨çš„ Google Sheet è©¦ç®—è¡¨ä¸­ï¼Œæ‰¾ä¸åˆ°ä¸€å€‹åç¨±å®Œå…¨ç¬¦åˆã€Œ<strong class="text-red-700">${sheetName}</strong>ã€çš„å·¥ä½œè¡¨åˆ†é ã€‚</p>
                            <p class="mt-4 text-sm text-gray-600">è«‹æ‚¨é–‹å•Ÿå¾Œç«¯çš„ Google Sheet æª”æ¡ˆï¼Œä¸¦ç¢ºèªå°æ‡‰çš„å·¥ä½œè¡¨åˆ†é åç¨±æ˜¯å¦èˆ‡ä¸Šæ–¹é¡¯ç¤ºçš„å®Œå…¨ä¸€è‡´ã€‚</p>
                        </div>
                    `;
                } else if (error.message && error.message.includes('YOUR_SPREADSHEET_ID')) {
                    errorMessage = `
                        <div class="text-center p-8 text-gray-700 bg-red-50 rounded-lg border border-red-200">
                            <h3 class="text-xl font-bold text-red-600 mb-3">å¾Œç«¯è¨­å®šéŒ¯èª¤</h3>
                            <p>æ‚¨å°šæœªåœ¨ Google Apps Script (Code.gs) æª”æ¡ˆä¸­ï¼Œå°‡ <code class="bg-red-200 text-red-800 p-1 rounded">'YOUR_SPREADSHEET_ID'</code> æ›¿æ›æˆæ‚¨
                            <br>çš„ Google Sheet è©¦ç®—è¡¨ IDã€‚</p>
                            <p class="mt-4 text-sm text-gray-600">è«‹ä¿®æ­£æ‚¨çš„ Apps Script æª”æ¡ˆï¼Œç„¶å¾Œé‡æ–°éƒ¨ç½²ã€‚</p>
                        </div>
                    `;
                }
                
                const banner = document.getElementById('connection-error-banner');
                if (banner) banner.classList.remove('hidden');

                document.getElementById('pageContainer').innerHTML = errorMessage;
                document.getElementById('memberList').innerHTML = `<div class="text-red-500 p-4">æˆå“¡åˆ—è¡¨è¼‰å…¥å¤±æ•—</div>`;
                lastUpdatedElement.textContent = 'ä¸Šæ¬¡æ›´æ–°ï¼šè¼‰å…¥å¤±æ•—';
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function renderWelcomePage() {
            document.getElementById('pageContainer').innerHTML = `
                <div class="p-4 space-y-8">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">æœªä¾†ä¸€é€±é–€è¨º</h3>
                        <div id="welcomeMonitoringList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                            ${renderWelcomeMonitoring()}
                        </div>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">é€²è¡Œä¸­çš„å°ˆæ¡ˆ</h3>
                        <div id="welcomeProjectList" class="space-y-4">
                            ${renderWelcomeProjects()}
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * æ¸²æŸ“ "åœ˜éšŠæœƒè­°" é é¢ - æ›´æ–°ç‚ºæ—¥æ›†è¦–åœ– + åˆ—è¡¨è¦–åœ–åˆ‡æ›
         */
        function renderEventsPage() {
            const pageContainer = document.getElementById('pageContainer');
            
            // å¹´/æœˆ ç¯©é¸å™¨
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;

            const years = [...new Set(allEventsData
                .map(item => item['æ—¥æœŸ'] ? new Date(item['æ—¥æœŸ']).getFullYear() : null)
                .filter(year => year)
            )].sort((a, b) => b - a);

            if (!years.includes(currentYear)) years.unshift(currentYear);
            
            const yearOptions = years.map(year => `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year} å¹´</option>`).join('');
            const monthOptions = Array.from({length: 12}, (_, i) => i + 1).map(month => `<option value="${month}" ${month === currentMonth ? 'selected' : ''}>${month} æœˆ</option>`).join('');

            // åˆ¤æ–·æ˜¯å¦ç‚ºæ‰‹æ©Ÿè£ç½®ä¾†æ±ºå®šé è¨­è¦–åœ–
            if (window.innerWidth < 768 && currentEventViewMode === 'calendar') {
                 // æ‰‹æ©Ÿä¸Šé è¨­å»ºè­°ä½¿ç”¨åˆ—è¡¨ï¼Œä½†ä¸å¼·åˆ¶è¦†è“‹ä½¿ç”¨è€…çš„é¸æ“‡
            }

            pageContainer.innerHTML = `
                <div class="flex flex-col md:flex-row gap-4 mb-4 items-center justify-between">
                    <div class="flex items-center gap-4">
                        <h2 class="text-2xl font-bold text-gray-800">æœƒè­°è¡Œäº‹æ›†</h2>
                        <div class="flex bg-gray-200 rounded-lg p-1">
                            <button onclick="switchEventViewMode('calendar')" class="px-3 py-1 rounded-md text-sm font-bold transition-all ${currentEventViewMode === 'calendar' ? 'bg-white shadow text-gray-800' : 'text-gray-500 hover:text-gray-700'}">æ—¥æ›†</button>
                            <button onclick="switchEventViewMode('list')" class="px-3 py-1 rounded-md text-sm font-bold transition-all ${currentEventViewMode === 'list' ? 'bg-white shadow text-gray-800' : 'text-gray-500 hover:text-gray-700'}">åˆ—è¡¨</button>
                        </div>
                    </div>
                    
                    <div id="eventFilters" class="flex gap-2 items-center ${currentEventViewMode === 'list' ? 'hidden md:flex' : ''}">
                        <button id="prevEventMonthBtn" class="btn btn-secondary px-3" title="ä¸Šå€‹æœˆ">&lt;</button>
                        <select id="eventYearFilterSelect" class="event-filter-select select-filter">
                            <option value="all">æ‰€æœ‰å¹´ä»½</option>
                            ${yearOptions}
                        </select>
                        <select id="eventMonthFilterSelect" class="event-filter-select select-filter">
                            <option value="all">æ‰€æœ‰æœˆä»½</option>
                            ${monthOptions}
                        </select>
                        <button id="nextEventMonthBtn" class="btn btn-secondary px-3" title="ä¸‹å€‹æœˆ">&gt;</button>
                    </div>
                </div>
                
                <!-- Calendar View -->
                <div id="eventCalendarContainer" class="${currentEventViewMode === 'calendar' ? '' : 'hidden'}">
                    <div id="eventCalendarHeader" class="calendar-grid mb-2">
                        <div class="calendar-day-header rounded-tl-md">ä¸€</div>
                        <div class="calendar-day-header">äºŒ</div>
                        <div class="calendar-day-header">ä¸‰</div>
                        <div class="calendar-day-header">å››</div>
                        <div class="calendar-day-header">äº”</div>
                        <div class="calendar-day-header">å…­</div>
                        <div class="calendar-day-header text-red-500 rounded-tr-md">æ—¥</div>
                    </div>
                    <div id="eventCalendar" class="calendar-grid border-l border-t rounded-b-md overflow-hidden">
                        <!-- Calendar content -->
                    </div>
                </div>

                <!-- List View -->
                <div id="eventListContainer" class="${currentEventViewMode === 'list' ? '' : 'hidden'}">
                    <div id="eventList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- List content -->
                    </div>
                </div>

                <button onclick="window.openAddEventModal()" class="fixed bottom-12 right-12 bg-blue-600 text-white w-16 h-16 rounded-full flex items-center justify-center text-4xl shadow-lg hover:bg-blue-700 transition-all z-50 hover:scale-105 active:scale-95">+</button>
            `;

            // äº‹ä»¶ç¶å®š
            const yearSelect = document.getElementById('eventYearFilterSelect');
            const monthSelect = document.getElementById('eventMonthFilterSelect');
            if(yearSelect) yearSelect.addEventListener('change', applyEventFilters);
            if(monthSelect) monthSelect.addEventListener('change', applyEventFilters);
            
            const prevBtn = document.getElementById('prevEventMonthBtn');
            const nextBtn = document.getElementById('nextEventMonthBtn');
            if(prevBtn) prevBtn.addEventListener('click', () => changeEventMonth(-1));
            if(nextBtn) nextBtn.addEventListener('click', () => changeEventMonth(1));

            applyEventFilters();
        }

        window.switchEventViewMode = function(mode) {
            currentEventViewMode = mode;
            renderEventsPage(); // Re-render to update UI state
        };

        function changeEventMonth(offset) {
            const yearSelect = document.getElementById('eventYearFilterSelect');
            const monthSelect = document.getElementById('eventMonthFilterSelect');
            let year = parseInt(yearSelect.value);
            let month = parseInt(monthSelect.value);

            if (isNaN(year) || isNaN(month)) {
                const now = new Date();
                year = now.getFullYear();
                month = now.getMonth() + 1;
            }

            const newDate = new Date(year, month - 1 + offset, 1);
            const newYear = newDate.getFullYear();
            const newMonth = newDate.getMonth() + 1;

            let yearOption = yearSelect.querySelector(`option[value="${newYear}"]`);
            if (!yearOption) {
                yearOption = document.createElement('option');
                yearOption.value = newYear;
                yearOption.text = `${newYear} å¹´`;
                yearSelect.add(yearOption);
            }
            
            yearSelect.value = newYear;
            monthSelect.value = newMonth;
            applyEventFilters();
        }

        function applyEventFilters() {
            const yearFilter = document.getElementById('eventYearFilterSelect').value;
            const monthFilter = document.getElementById('eventMonthFilterSelect').value;
            
            // Render Calendar
            renderEventsCalendar(parseInt(yearFilter, 10), parseInt(monthFilter, 10), allEventsData);
            
            // Render List
            let listData = allEventsData;
            if (yearFilter !== 'all') {
                listData = listData.filter(e => e['æ—¥æœŸ'] && e['æ—¥æœŸ'].startsWith(yearFilter));
            }
            if (monthFilter !== 'all' && yearFilter !== 'all') {
                const monthStr = String(monthFilter).padStart(2, '0');
                listData = listData.filter(e => e['æ—¥æœŸ'] && e['æ—¥æœŸ'].startsWith(`${yearFilter}-${monthStr}`));
            }
            
            renderEventsList(listData);
        }

        function renderEventsList(data) {
            const listContainer = document.getElementById('eventList');
            if (!listContainer) return;
            
            if (!data || data.length === 0) {
                listContainer.innerHTML = '<div class="col-span-full text-center p-8 text-gray-500">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æœƒè­°ã€‚</div>';
                return;
            }

            const sortedData = [...data].sort((a, b) => new Date(a['æ—¥æœŸ']) - new Date(b['æ—¥æœŸ']));

            listContainer.innerHTML = sortedData.map(event => {
                const date = new Date(event['æ—¥æœŸ']);
                const dateStr = formatSimpleDate(event['æ—¥æœŸ']);
                const isPast = date < new Date().setHours(0,0,0,0);
                
                return `
                    <div class="bg-white rounded-xl shadow p-4 border-l-4 ${isPast ? 'border-gray-300' : 'border-blue-500'} cursor-pointer hover:shadow-lg transition-all" onclick="window.openEditEventModal('${event.ID}')">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg text-gray-800">${event['æœƒè­°']}</h3>
                            <span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600 font-medium">${dateStr}</span>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <p class="flex items-center gap-2 text-blue-600 font-medium">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                ${event['é–‹å§‹æ™‚é–“'] || '--:--'} - ${event['çµæŸæ™‚é–“'] || '--:--'}
                            </p>
                            <p class="truncate"><strong>ä¸»è¾¦:</strong> ${event['ä¸»è¾¦å–®ä½'] || 'æœªå¡«å¯«'}</p>
                            <p class="truncate text-gray-500">${event['å‚™è¨»'] || ''}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderEventsCalendar(year, month, data) {
            const listContainer = document.getElementById('eventCalendar');
            if (!listContainer) return;

            listContainer.innerHTML = '';
            
            if (isNaN(year) || isNaN(month)) {
                const now = new Date();
                year = now.getFullYear();
                month = now.getMonth() + 1;
            }

            let firstDay = new Date(year, month - 1, 1).getDay(); 
            firstDay = (firstDay === 0) ? 6 : (firstDay - 1); 
            const daysInMonth = new Date(year, month, 0).getDate();
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && (today.getMonth() + 1) === month;

            for (let i = 0; i < firstDay; i++) {
                listContainer.innerHTML += `<div class="calendar-day-empty hidden md:block border-r border-b border-gray-100"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const isoDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = isCurrentMonth && today.getDate() === day;
                
                const eventsForDay = data.filter(item => {
                    if (!item['æ—¥æœŸ']) return false;
                    return item['æ—¥æœŸ'].startsWith(isoDate);
                }).sort((a, b) => (a['é–‹å§‹æ™‚é–“'] || '').localeCompare(b['é–‹å§‹æ™‚é–“'] || ''));

                const eventsHtml = eventsForDay.map(event => {
                    return `
                        <div class="event-chip" onclick="event.stopPropagation(); window.openEditEventModal('${event.ID}')" title="${event['æœƒè­°']}">
                            <span class="event-chip-time">${event['é–‹å§‹æ™‚é–“'] || ''}</span>
                            ${event['æœƒè­°']}
                        </div>
                    `;
                }).join('');
                
                listContainer.innerHTML += `
                    <div class="calendar-day border-r border-b border-gray-200">
                        <div class="day-content" onclick="window.openAddEventModal('${isoDate}')">
                            <div class="day-header">
                                <span class="day-number ${isToday ? 'today' : ''}">${day}</span>
                            </div>
                            <div class="w-full flex-1 overflow-y-auto space-y-1">
                                ${eventsHtml}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function renderTodosPage() {
            const pageContainer = document.getElementById('pageContainer');
            pageContainer.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">å¾…è¾¦äº‹é …åˆ—è¡¨</h2>
                    <div class="flex gap-2">
                        <button onclick="window.filterTodos('all')" class="filter-btn filter-btn-active" id="filterAllTodos">å…¨éƒ¨</button>
                        <button onclick="window.filterTodos('pending')" class="filter-btn filter-btn-inactive" id="filterPendingTodos">å¾…è¾¦</button>
                        <button onclick="window.filterTodos('done')" class="filter-btn filter-btn-inactive" id="filterDoneTodos">å®Œæˆ</button>
                    </div>
                </div>
                <div id="todoList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                </div>
                <button onclick="window.openAddTodoModal()" class="fixed bottom-12 right-12 bg-blue-600 text-white w-16 h-16 rounded-full flex items-center justify-center text-4xl shadow-lg hover:bg-blue-700 transition-all">+</button>
            `;
            window.filterTodos('all');
        }

        window.filterTodos = function(filter) {
            document.getElementById('filterAllTodos').className = filter === 'all' ? 'filter-btn filter-btn-active' : 'filter-btn filter-btn-inactive';
            document.getElementById('filterPendingTodos').className = filter === 'pending' ? 'filter-btn filter-btn-active' : 'filter-btn filter-btn-inactive';
            document.getElementById('filterDoneTodos').className = filter === 'done' ? 'filter-btn filter-btn-active' : 'filter-btn filter-btn-inactive';

            let filteredData = allTodosData;
            if (filter === 'pending') {
                filteredData = allTodosData.filter(t => t['ç‹€æ…‹'] !== 'å®Œæˆ');
            } else if (filter === 'done') {
                filteredData = allTodosData.filter(t => t['ç‹€æ…‹'] === 'å®Œæˆ');
            }
            renderTodoList(filteredData);
        };

        function renderTodoList(data) {
            const listContainer = document.getElementById('todoList');
            if (!data || data.length === 0) {
                listContainer.innerHTML = '<div class="col-span-full text-center p-8 text-gray-500">ç›®å‰æ²’æœ‰å¾…è¾¦äº‹é …ã€‚</div>';
                return;
            }

            const sorted = [...data].sort((a, b) => {
                if (a['ç‹€æ…‹'] === b['ç‹€æ…‹']) {
                    return new Date(a['æˆªæ­¢æ—¥æœŸ'] || '9999-12-31') - new Date(b['æˆªæ­¢æ—¥æœŸ'] || '9999-12-31');
                }
                return a['ç‹€æ…‹'] === 'å®Œæˆ' ? 1 : -1;
            });

            listContainer.innerHTML = sorted.map(todo => {
                const isDone = todo['ç‹€æ…‹'] === 'å®Œæˆ';
                const priorityClass = priorityColors[todo['å„ªå…ˆç´š']] || 'priority-medium';
                const statusColor = isDone ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const assignerText = todo['æŒ‡æ´¾äºº'] ? `<span class="text-xs text-gray-400"> (ç”± ${todo['æŒ‡æ´¾äºº']} æŒ‡æ´¾)</span>` : '';
                
                return `
                    <div class="bg-white rounded-xl shadow p-4 border-l-4 ${isDone ? 'border-green-500' : 'border-yellow-500'} cursor-pointer hover:shadow-lg transition-all" onclick="window.openEditTodoModal('${todo.ID}')">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg ${isDone ? 'line-through text-gray-500' : 'text-gray-800'}">${todo['äº‹é …']}</h3>
                            <span class="text-xs px-2 py-1 rounded ${priorityClass}">${todo['å„ªå…ˆç´š'] || 'ä¸­'}</span>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <p class="flex justify-between"><span>ç‹€æ…‹:</span> <span class="px-2 py-0.5 rounded text-xs ${statusColor}">${todo['ç‹€æ…‹']}</span></p>
                            <p>è² è²¬äºº: ${todo['è² è²¬äºº'] || 'æœªæŒ‡å®š'} ${assignerText}</p>
                            <p>æˆªæ­¢æ—¥æœŸ: ${formatSimpleDate(todo['æˆªæ­¢æ—¥æœŸ'])}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCasesPage() {
            document.getElementById('pageContainer').innerHTML = `
                <div class="flex flex-col h-full">
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-4">
                        <div class="bg-gray-100 p-4 rounded-xl shadow"><p class="text-sm text-gray-500">ç¸½å€‹æ¡ˆæ•¸</p><p id="totalCases" class="text-2xl font-bold">0</p></div>
                    </div>
                    <div class="flex flex-col md:flex-row gap-2 mb-4">
                        <input type="text" id="searchInput" class="flex-1 w-full md:w-auto input" placeholder="æœå°‹å§“åã€å€‹ç®¡å¸«æˆ–ç—…æ­·è™Ÿ...">
                        <div class="flex gap-2">
                            <button id="allCasesFilterBtn" class="filter-btn filter-btn-active">å…¨éƒ¨å€‹æ¡ˆ</button>
                            <button id="medicationFilterBtn" class="filter-btn filter-btn-inactive">è—¥è²» > 15k</button>
                            <button id="totalFilterBtn" class="filter-btn filter-btn-inactive">ç¸½é¡ > 35k</button>
                        </div>
                    </div>
                    <div id="caseList" class="flex-1 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 overflow-y-auto">
                    </div>
                </div>
            `;
            updateCasesView();
        }

        function renderProjectsPage() {
            const pageContainer = document.getElementById('pageContainer');
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            
            const years = [...new Set(allProjectsData
                .map(item => item['æˆªæ­¢æ—¥æœŸ'] ? new Date(item['æˆªæ­¢æ—¥æœŸ']).getFullYear() : null)
                .filter(year => year)
            )].sort((a, b) => b - a);

            if (!years.includes(currentYear)) {
                years.unshift(currentYear);
            }
            
            const yearOptions = years.map(year => `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year} å¹´</option>`).join('');
            const monthOptions = Array.from({length: 12}, (_, i) => i + 1).map(month => `<option value="${month}" ${month === currentMonth ? 'selected' : ''}>${month} æœˆ</option>`).join('');
            
            pageContainer.innerHTML = `
                <div id="projectFilters" class="flex flex-col gap-4 mb-4">
                    <div class="flex gap-2 flex-wrap">
                        <button data-filter="all" class="project-filter-btn project-group-btn filter-btn filter-btn-active">å…¨éƒ¨å°ˆæ¡ˆ</button>
                        <button data-filter="é™¢å…§" class="project-filter-btn project-group-btn filter-btn filter-btn-inactive">é™¢å…§</button>
                        <button data-filter="é…’ç™®è¨ˆç•«" class="project-filter-btn project-group-btn filter-btn filter-btn-inactive">é…’ç™®</button>
                        <button data-filter="ç›£æ‰€è¨ˆç•«" class="project-filter-btn project-group-btn filter-btn filter-btn-inactive">ç›£æ‰€</button>
                        <button data-filter="ç¾æ²™å†¬è¨ˆç•«" class="project-filter-btn project-group-btn filter-btn filter-btn-inactive">ç¾æ²™å†¬</button>
                        <button data-filter="è—¥ç™®æ•´åˆè¨ˆç•«1" class="project-filter-btn project-group-btn filter-btn filter-btn-inactive">è—¥åˆ1</button>
                        <button data-filter="è—¥ç™®æ•´åˆè¨ˆç•«2" class="project-filter-btn project-group-btn filter-btn filter-btn-inactive">è—¥åˆ2</button>
                    </div>
                    <div class="flex gap-2 ml-auto">
                        <select id="projectYearFilterSelect" class="project-filter-select select-filter">
                            <option value="all">æ‰€æœ‰å¹´ä»½</option>
                            ${yearOptions}
                        </select>
                        <select id="projectMonthFilterSelect" class="project-filter-select select-filter">
                            <option value="all">æ‰€æœ‰æœˆä»½</option>
                            ${monthOptions}
                        </select>
                    </div>
                </div>
                
                <div id="projectList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                </div>
                <button id="addProjectItemBtn" onclick="window.openAddProjectModal()" class="fixed bottom-12 right-12 bg-blue-600 text-white w-16 h-16 rounded-full flex items-center justify-center text-4xl shadow-lg hover:bg-blue-700 transition-all">+</button>
            `;
            
            document.querySelectorAll('.project-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.project-group-btn').forEach(b => b.classList.replace('filter-btn-active', 'filter-btn-inactive'));
                    btn.classList.replace('filter-btn-inactive', 'filter-btn-active');
                    applyProjectFilters();
                });
            });
            
            document.querySelectorAll('.project-filter-select').forEach(select => {
                select.addEventListener('change', applyProjectFilters);
            });
            
            applyProjectFilters();
        }

        function applyProjectFilters() {
            const groupFilter = document.querySelector('.project-group-btn.filter-btn-active').dataset.filter;
            const yearFilter = document.getElementById('projectYearFilterSelect').value;
            const monthFilter = document.getElementById('projectMonthFilterSelect').value;

            let filteredData = allProjectsData;
            
            if (groupFilter !== 'all') {
                filteredData = filteredData.filter(item => item['æ‰€å±¬å°çµ„'] === groupFilter);
            }
            
            if (yearFilter !== 'all') {
                filteredData = filteredData.filter(item => {
                    if (!item['æˆªæ­¢æ—¥æœŸ']) return false;
                    return new Date(item['æˆªæ­¢æ—¥æœŸ']).getFullYear().toString() === yearFilter;
                });
            }
            
            if (monthFilter !== 'all') {
                filteredData = filteredData.filter(item => {
                    if (!item['æˆªæ­¢æ—¥æœŸ']) return false;
                    const { isCompleted } = getCalculatedProjectStatus(item);
                    const isStillActive = !isCompleted;
                    const dueDate = new Date(item['æˆªæ­¢æ—¥æœŸ'].split('T')[0] + 'T00:00:00'); 
                    const dueMonth = (dueDate.getMonth() + 1).toString();
                    return (dueMonth === monthFilter) || isStillActive;
                });
            }
            
            renderProjectList(filteredData);
        }

        function renderProjectList(data) {
            const listContainer = document.getElementById('projectList');
            if (!listContainer) return;

            let contentHtml = '';
            
            if (!data || data.length === 0) {
                contentHtml = '<div class="col-span-full text-center p-8 text-gray-500">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å°ˆæ¡ˆé …ç›®ã€‚</div>';
            } else {
                const sortedProjects = [...data].sort((a, b) => new Date(a['æˆªæ­¢æ—¥æœŸ']) - new Date(b['æˆªæ­¢æ—¥æœŸ']));
                
                sortedProjects.forEach((project) => {
                    const { status, colorClass, progress, totalTasks, completedTasks } = getCalculatedProjectStatus(project);
                    const priorityClass = priorityColors[project['å„ªå…ˆç´š']] || 'priority-medium';
                    let cardBorder = (status === 'é€¾æœŸ') ? 'border-2 border-red-500' : '';
                    
                    contentHtml += `
                        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col gap-4 cursor-pointer border border-gray-200 hover:shadow-xl transition-shadow ${cardBorder}" onclick="window.showProjectDetails('${project.ID}')" ondblclick="window.openEditProjectModal('${project.ID}')">
                            <div class="flex justify-between items-start gap-2">
                                <h3 class="text-xl font-bold text-link-title">${project['å°ˆæ¡ˆåç¨±'] || 'æœªå‘½å'}</h3>
                                <span class="text-xs font-semibold px-2 py-1 rounded ${priorityClass}">${project['å„ªå…ˆç´š'] || 'ä¸­'}</span>
                            </div>
                            <p class="text-sm text-gray-500">${project['æ‰€å±¬å°çµ„']} / ${project['ä»»å‹™é¡å‹']}</p>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="progress-bar-inner h-2.5 rounded-full" style="width: ${progress}%"></div>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="font-semibold px-2 py-1 rounded ${colorClass}">${status}</span>
                                <span>${completedTasks} / ${totalTasks} å®Œæˆ</span>
                            </div>
                            <div class="text-sm text-gray-500 pt-4 border-t mt-auto">
                                <p><strong>è² è²¬:</strong> ${project['ä¸»è¦è² è²¬'] || 'N/A'}</p>
                                <p><strong>æˆªæ­¢æ—¥æœŸ:</strong> ${formatSimpleDate(project['æˆªæ­¢æ—¥æœŸ'])}</p>
                            </div>
                        </div>`;
                });
            }
            listContainer.innerHTML = contentHtml;
        }

        function addChecklistItemToForm(item = {text: '', completed: false}) {
            const input = document.getElementById('newChecklistItemInput');
            const text = (item.text || input.value).trim();
            if (text) {
                const container = document.getElementById('checklistItemContainer');
                const newItem = document.createElement('div');
                newItem.className = 'checklist-item-wrapper flex items-center justify-between bg-gray-100 p-2 rounded';
                newItem.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" class="h-4 w-4 mr-3" ${item.completed ? 'checked' : ''}>
                        <span class="checklist-item-text">${text}</span>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-700 font-bold">&times;</button>
                `;
                newItem.querySelector('button').addEventListener('click', () => newItem.remove());
                container.appendChild(newItem);
                if (!item.text) input.value = '';
            }
        };

        window.onload = () => {
            const passwordScreen = document.getElementById('password-screen');
            const dashboardContainer = document.getElementById('dashboard-container');

            function initializeDashboard() {
                passwordScreen.style.display = 'none';
                dashboardContainer.classList.remove('hidden');

                loadInitialDashboardData();

                ['welcomeBtn', 'eventsBtn', 'projectsBtn', 'casesBtn', 'monitoringBtn', 'todosBtn'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) { 
                        btn.addEventListener('click', (e) => switchView(e.target.dataset.view));
                    }
                });

                // --- Event Form Submit ---
                document.getElementById('addEventForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formButton = this.querySelector('button[type="submit"]');
                    formButton.disabled = true;
                    formButton.textContent = 'å„²å­˜ä¸­...';

                    const eventId = document.getElementById('editEventId').value;
                    const isEditing = !!eventId;

                    const eventData = {
                        'ID': isEditing ? eventId : `evt_${Date.now()}`,
                        'æœƒè­°': document.getElementById('eventName').value,
                        'æ—¥æœŸ': document.getElementById('eventDate').value,
                        'é–‹å§‹æ™‚é–“': document.getElementById('eventStartTime').value,
                        'çµæŸæ™‚é–“': document.getElementById('eventEndTime').value,
                        'ä¸»è¾¦å–®ä½': document.getElementById('eventOrganizer').value,
                        'è¯çµ¡äºº': document.getElementById('eventContact').value,
                        'å‚™è¨»': document.getElementById('eventNote').value,
                        'ä¸Šæ¬¡æ›´æ–°æ™‚é–“': new Date().toISOString()
                    };

                    const payload = {
                        action: isEditing ? 'UPDATE_EVENT' : 'CREATE_EVENT',
                        sheetName: 'åœ˜éšŠæœƒè­°', 
                        data: eventData
                    };

                    try {
                        await sendDataToAppsScript(payload);
                        
                        if (isEditing) {
                            const index = allEventsData.findIndex(e => e.ID === eventId);
                            if (index !== -1) allEventsData[index] = eventData;
                            showToast('æœƒè­°å·²æ›´æ–°ï¼');
                        } else {
                            allEventsData.push(eventData);
                            showToast('æœƒè­°å·²æ–°å¢ï¼');
                        }
                        
                        applyEventFilters(); 
                        closeModal('addEventModal');
                        this.reset();
                        document.getElementById('editEventId').value = '';

                    } catch (error) {
                        console.error('å„²å­˜æœƒè­°å¤±æ•—:', error);
                        showToast(`å„²å­˜å¤±æ•—: ${error.message}`);
                    } finally {
                        formButton.disabled = false;
                        formButton.textContent = 'å„²å­˜';
                    }
                });

                document.getElementById('addTodoForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formButton = this.querySelector('button[type="submit"]');
                    formButton.disabled = true;
                    formButton.textContent = 'å„²å­˜ä¸­...';

                    const todoId = document.getElementById('editTodoId').value;
                    const isEditing = !!todoId;

                    const todoData = {
                        'ID': isEditing ? todoId : `todo_${Date.now()}`,
                        'äº‹é …': document.getElementById('todoName').value,
                        'ç‹€æ…‹': document.getElementById('todoStatus').value,
                        'å„ªå…ˆç´š': document.getElementById('todoPriority').value,
                        'æˆªæ­¢æ—¥æœŸ': document.getElementById('todoDueDate').value,
                        'è² è²¬äºº': document.getElementById('todoAssignee').value,
                        'æŒ‡æ´¾äºº': document.getElementById('todoAssigner').value,
                        'å‚™è¨»': document.getElementById('todoNote').value,
                        'ä¸Šæ¬¡æ›´æ–°æ™‚é–“': new Date().toISOString()
                    };

                    const payload = {
                        action: isEditing ? 'UPDATE_TODO' : 'CREATE_TODO',
                        sheetName: 'å¾…è¾¦äº‹é …', 
                        data: todoData
                    };

                    try {
                        await sendDataToAppsScript(payload);
                        
                        if (isEditing) {
                            const index = allTodosData.findIndex(t => t.ID === todoId);
                            if (index !== -1) allTodosData[index] = todoData;
                            showToast('å¾…è¾¦äº‹é …å·²æ›´æ–°ï¼');
                        } else {
                            allTodosData.push(todoData);
                            showToast('å¾…è¾¦äº‹é …å·²æ–°å¢ï¼');
                        }
                        
                        renderTodosPage(); 
                        closeModal('addTodoModal');
                        this.reset();
                        document.getElementById('editTodoId').value = '';

                    } catch (error) {
                        console.error('å„²å­˜å¾…è¾¦äº‹é …å¤±æ•—:', error);
                        showToast(`å„²å­˜å¤±æ•—: ${error.message}`);
                    } finally {
                        formButton.disabled = false;
                        formButton.textContent = 'å„²å­˜';
                    }
                });

                document.getElementById('addProjectForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formButton = this.querySelector('button[type="submit"]');
                    formButton.disabled = true;
                    formButton.textContent = 'å„²å­˜ä¸­...';

                    const selectedLeads = Array.from(document.querySelectorAll('#projectLeadSelection input:checked')).map(cb => cb.value).join(', ');
                    const selectedTeam = Array.from(document.querySelectorAll('#projectTeamSelection input:checked')).map(cb => cb.value).join(', ');
                    
                    const checklistItems = Array.from(document.querySelectorAll('#checklistItemContainer .checklist-item-wrapper')).map(itemDiv => ({
                        text: itemDiv.querySelector('.checklist-item-text').textContent,
                        completed: itemDiv.querySelector('input[type="checkbox"]').checked
                    }));

                    const projectId = document.getElementById('editProjectId').value;
                    const isEditing = !!projectId;

                    const projectData = {
                        'ID': isEditing ? projectId : `proj_${Date.now()}`,
                        'å°ˆæ¡ˆåç¨±': document.getElementById('projectName').value,
                        'æ‰€å±¬å°çµ„': document.getElementById('projectGroup').value,
                        'ä»»å‹™é¡å‹': document.getElementById('projectType').value,
                        'å‚™è¨»': document.getElementById('projectDescription').value,
                        'ä¸»è¦è² è²¬': selectedLeads,
                        'å”åŒè² è²¬': selectedTeam,
                        'ç‹€æ…‹': document.getElementById('projectStatus').value,
                        'å„ªå…ˆç´š': document.getElementById('projectPriority').value,
                        'é–‹å§‹æ—¥æœŸ': document.getElementById('startDate').value,
                        'æˆªæ­¢æ—¥æœŸ': document.getElementById('endDate').value,
                        'æª¢æŸ¥é»': JSON.stringify(checklistItems)
                    };
                    
                    const payload = {
                        action: isEditing ? 'UPDATE_PROJECT' : 'CREATE_PROJECT',
                        sheetName: 'åœ˜éšŠå°ˆæ¡ˆ',
                        data: projectData
                    };

                    try {
                        await sendDataToAppsScript(payload);
                        
                        if (isEditing) {
                            const index = allProjectsData.findIndex(p => p.ID === projectId);
                            if (index !== -1) {
                                allProjectsData[index] = { ...projectData, 'æª¢æŸ¥é»': checklistItems }; 
                            }
                            showToast('å°ˆæ¡ˆå·²æˆåŠŸæ›´æ–°ï¼');
                        } else {
                            allProjectsData.push({ ...projectData, 'æª¢æŸ¥é»': checklistItems });
                            showToast('å°ˆæ¡ˆå·²æˆåŠŸæ–°å¢ï¼');
                        }
                        
                        applyProjectFilters();
                        renderMembersList(allProjectsData);
                        
                        closeModal('addProjectModal');
                        this.reset();
                        document.getElementById('editProjectId').value = '';

                    } catch (error) {
                        console.error('å„²å­˜å°ˆæ¡ˆå¤±æ•—:', error);
                        showToast(`å„²å­˜å°ˆæ¡ˆå¤±æ•—: ${error.message}`);
                    } finally {
                        formButton.disabled = false;
                        formButton.textContent = 'å„²å­˜';
                    }
                });

                document.getElementById('addMonitoringForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formButton = this.querySelector('button[type="submit"]');
                    formButton.disabled = true;
                    formButton.textContent = 'å„²å­˜ä¸­...';

                    const dateError = document.getElementById('monitoringDateError');
                    dateError.classList.add('hidden');
                    
                    const monitoringId = document.getElementById('editMonitoringId').value;
                    const isEditing = !!monitoringId;
                    const today = new Date().toISOString();
                    const isClosed = document.getElementById('monitoringIsClosed').checked;

                    const monitoringData = {
                        'ID': isEditing ? monitoringId : `mon_${Date.now()}`,
                        'æ—¥æœŸ': document.getElementById('monitoringDate').value,
                        'é–€è¨º': document.getElementById('monitoringItemName').value,
                        'å·²æ›è™Ÿäººæ•¸': isClosed ? '' : (document.getElementById('monitoringRegisteredCount').value || 0),
                        'æ–°æ¡ˆ': isClosed ? '' : (document.getElementById('monitoringNewCases').value || 0),
                        'æ˜¯å¦åœè¨º': isClosed ? 'æ˜¯' : 'å¦',
                        'ä¸Šæ¬¡æ›´æ–°æ™‚é–“': today 
                    };
                    
                    const payload = {
                        action: isEditing ? 'UPDATE_MONITORING_ITEM' : 'CREATE_MONITORING_ITEM',
                        sheetName: 'é–€è¨ºç›£æ¸¬',
                        data: monitoringData
                    };

                    try {
                        const result = await sendDataToAppsScript(payload);
                        
                        if (isEditing) {
                            const index = allMonitoringData.findIndex(p => p.ID === monitoringId);
                            if (index !== -1) {
                                allMonitoringData[index] = monitoringData; 
                            }
                            showToast('é–€è¨ºé …ç›®å·²æˆåŠŸæ›´æ–°ï¼');
                        } else {
                            allMonitoringData.push(monitoringData);
                            showToast('é–€è¨ºé …ç›®å·²æˆåŠŸæ–°å¢ï¼');
                        }
                        
                        updateMonitoringView(); 
                        
                        closeModal('addMonitoringModal');
                        this.reset();
                        document.getElementById('editMonitoringId').value = '';
                        document.getElementById('monitoringIsClosed').checked = false;
                        document.getElementById('monitoringRegisteredCount').disabled = false;
                        document.getElementById('monitoringNewCases').disabled = false;

                    } catch (error) {
                        console.error('å„²å­˜é–€è¨ºé …ç›®å¤±æ•—:', error);
                        showToast(`å„²å­˜é–€è¨ºé …ç›®å¤±æ•—: ${error.message}`);
                    } finally {
                        formButton.disabled = false;
                        formButton.textContent = 'å„²å­˜';
                    }
                });

                document.getElementById('monitoringIsClosed').addEventListener('change', function() {
                    const isClosed = this.checked;
                    const countInput = document.getElementById('monitoringRegisteredCount');
                    const newCaseInput = document.getElementById('monitoringNewCases');
                    
                    countInput.disabled = isClosed;
                    newCaseInput.disabled = isClosed;
                    
                    if (isClosed) {
                        countInput.value = '';
                        newCaseInput.value = '';
                    }
                });
                
                document.getElementById('selectAllTeam').addEventListener('change', (e) => { document.querySelectorAll('#projectTeamSelection input').forEach(cb => cb.checked = e.target.checked); });
                document.getElementById('projectTeamSelection').addEventListener('change', (e) => { if (e.target.matches('input')) { document.getElementById('selectAllTeam').checked = Array.from(document.querySelectorAll('#projectTeamSelection input')).every(cb => cb.checked); } });
                document.getElementById('addChecklistItemBtn').addEventListener('click', () => addChecklistItemToForm());
                document.getElementById('newChecklistItemInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); addChecklistItemToForm(); } });
            }

            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                initializeDashboard();
            } else {
                passwordScreen.style.display = 'flex';
                dashboardContainer.classList.add('hidden');
            }

            document.getElementById('password-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const correctPassword = 'AUD.0507';
                const enteredPassword = document.getElementById('password-input').value;
                const errorElement = document.getElementById('password-error');

                if (enteredPassword === correctPassword) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    initializeDashboard();
                } else {
                    errorElement.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚';
                    document.getElementById('password-input').value = '';
                    setTimeout(() => { errorElement.textContent = ''; }, 3000);
                }
            });
        };

        function formatSimpleDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr.split('T')[0] + 'T00:00:00');
                if (isNaN(date.getTime())) return 'ç„¡æ•ˆæ—¥æœŸ';
                
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const weekday = weekdays[date.getDay()];
                
                return `${month}/${day} (é€±${weekday})`;
            } catch (e) {
                console.error("formatSimpleDate è½‰æ›å¤±æ•—:", dateStr, e);
                return 'æ—¥æœŸæ ¼å¼éŒ¯èª¤';
            }
        }

        function renderMembersList(projectData) {
            const memberListContainer = document.getElementById('memberList');
            memberListContainer.innerHTML = '';

            if (!allMembersData || allMembersData.length === 0) {
                memberListContainer.innerHTML = '<div class="text-center p-4 text-gray-500">ç„¡æ³•è¼‰å…¥æˆå“¡ã€‚</div>';
                return;
            }
            
            const sortedMembers = [...allMembersData].sort((a, b) => (a['æ’åº'] || 99) - (b['æ’åº'] || 99));

            sortedMembers.forEach(member => {
                const name = member['å§“å'];
                const title = member['è·ç¨±'];
                
                const projectCount = projectData.filter(p => {
                    const leads = (p['ä¸»è¦è² è²¬'] || '').split(',').map(s => s.trim());
                    const team = (p['å”åŒè² è²¬'] || '').split(',').map(s => s.trim());
                    return leads.includes(name) || team.includes(name);
                }).length;

                const colorClass = jobTitleColors[title] || jobTitleColors['default'];
                
                memberListContainer.innerHTML += `
                    <div class="${colorClass} p-4 rounded-lg shadow-sm">
                        <h4 class="font-bold text-lg">${name}</h4>
                        <p class="text-sm">${title}</p>
                        <p class="text-xs mt-1">(${projectCount} å€‹å°ˆæ¡ˆ)</p>
                    </div>
                `;
            });
        }

        async function fetchData(sheetName) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.remove('hidden');

            const debugLink = document.getElementById('debug-link');
            if (debugLink) {
                debugLink.href = `${appsScriptUrl}?action=GET_DATA&sheetName=${encodeURIComponent(sheetName)}`;
            }

            try {
                const response = await fetch(`${appsScriptUrl}?action=GET_DATA&sheetName=${encodeURIComponent(sheetName)}&_t=${new Date().getTime()}`, {
                    method: 'GET',
                    credentials: 'omit'
                });
                
                const text = await response.text();
                
                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤: ${response.status} (${text.slice(0, 100)}...)`);
                }

                try {
                    const result = JSON.parse(text);
                    if (result.status === 'error' || result.error) {
                         throw new Error(result.message || result.error || 'æœªçŸ¥çš„å¾Œç«¯éŒ¯èª¤');
                    }
                    return result.data;
                } catch (e) {
                    console.error("JSON è§£æå¤±æ•—ï¼ŒåŸå§‹å›æ‡‰:", text);
                    if (text.includes("Google Accounts")) {
                        throw new Error("æ¬Šé™éŒ¯èª¤ï¼šApps Script éƒ¨ç½²æ¬Šé™æœªè¨­ç‚ºã€Œä»»ä½•äºº (Anyone)ã€ã€‚");
                    } else if (text.includes("ScriptError")) {
                        throw new Error("è…³æœ¬éŒ¯èª¤ï¼šå¾Œç«¯ç¨‹å¼ç¢¼åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨ ID æˆ–åç¨±ã€‚");
                    } else {
                        throw new Error(`è³‡æ–™æ ¼å¼éŒ¯èª¤ (é JSON)ï¼Œè«‹é»æ“Šä¸Šæ–¹è¨ºæ–·é€£çµæŸ¥çœ‹è©³ç´°åŸå› ã€‚`);
                    }
                }

            } catch (error) {
                console.error(`fetchData å¤±æ•— (å·¥ä½œè¡¨: ${sheetName}):`, error);
                
                const banner = document.getElementById('connection-error-banner');
                if (banner) {
                    banner.classList.remove('hidden');
                    const debugLink = document.getElementById('debug-link');
                    debugLink.href = `${appsScriptUrl}?action=GET_DATA&sheetName=${encodeURIComponent(sheetName)}`;
                }
                
                throw error; 
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        async function sendDataToAppsScript(payload) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.remove('hidden');
            
            try {
                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    credentials: 'omit',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                });

                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                if (result.status === 'error') {
                    throw new Error(result.message || 'å¾Œç«¯è…³æœ¬åŸ·è¡Œå¤±æ•—');
                }
                
                return result;

            } catch (error) {
                console.error('sendDataToAppsScript å¤±æ•—:', error);
                
                if (error.message.includes('Failed to fetch')) {
                     throw new Error('ç„¡æ³•é€£ç·šè‡³å¾Œç«¯ã€‚è«‹ç¢ºèª Apps Script éƒ¨ç½²è¨­å®šä¸­çš„ã€Œèª°å¯ä»¥å­˜å–ã€æ˜¯å¦å·²è¨­ç‚ºã€Œä»»ä½•äººã€ã€‚');
                }
                
                throw error;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        async function switchView(viewName) {
            currentView = viewName;
            document.querySelectorAll('.tab-button').forEach(btn => {
                if (btn.dataset.view === viewName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            const pageContainer = document.getElementById('pageContainer');
            pageContainer.innerHTML = `<div class="text-center p-8 text-gray-500">è³‡æ–™è¼‰å…¥ä¸­...</div>`;

            try {
                if (viewName === 'welcome') {
                    renderWelcomePage();
                    renderMembersList(allProjectsData);
                } else if (viewName === 'events') {
                    if (allEventsData.length === 0) {
                        const rawData = await fetchData('åœ˜éšŠæœƒè­°');
                        allEventsData = (Array.isArray(rawData) ? rawData : []);
                    }
                    renderEventsPage();
                } else if (viewName === 'cases') {
                    if (allCasesData.length === 0) {
                        const rawData = await fetchData('é…’ç™®å€‹æ¡ˆè£œåŠ©ä½¿ç”¨è¿½è¹¤');
                        allCasesData = (Array.isArray(rawData) ? rawData : []);
                    }
                    renderCasesPage();
                } else if (viewName === 'projects') {
                    if (allProjectsData.length === 0) {
                         const rawData = await fetchData('åœ˜éšŠå°ˆæ¡ˆ');
                         allProjectsData = (Array.isArray(rawData) ? rawData : []);
                    }
                    renderProjectsPage(); 
                    renderMembersList(allProjectsData);
                } else if (viewName === 'monitoring') { 
                    if (allMonitoringData.length === 0) {
                        const rawData = await fetchData('é–€è¨ºç›£æ¸¬');
                        allMonitoringData = (Array.isArray(rawData) ? rawData : []);
                    }
                    updateMonitoringView();
                } else if (viewName === 'todos') {
                    if (allTodosData.length === 0) {
                        const rawData = await fetchData('å¾…è¾¦äº‹é …');
                        allTodosData = (Array.isArray(rawData) ? rawData : []);
                    }
                    renderTodosPage();
                }
            } catch (error) {
                console.error(`ç„¡æ³•åˆ‡æ›è¦–åœ–è‡³ ${viewName}:`, error);
                let errorMessage = `<div class="text-center p-8 text-red-500">ç„¡æ³•è¼‰å…¥ ${viewName} è³‡æ–™ã€‚(${error.message})</div>`;
                if (error.message && error.message.includes("æ‰¾ä¸åˆ°å·¥ä½œè¡¨")) {
                    const sheetNameMatch = error.message.match(/æ‰¾ä¸åˆ°å·¥ä½œè¡¨: (.+)/);
                    const sheetName = sheetNameMatch ? sheetNameMatch[1].trim() : "æœªçŸ¥";
                    errorMessage = `
                        <div class="text-center p-8 text-gray-700 bg-red-50 rounded-lg border border-red-200">
                            <h3 class="text-xl font-bold text-red-600 mb-3">è³‡æ–™è¼‰å…¥å¤±æ•—</h3>
                            <p>ç³»çµ±åœ¨æ‚¨çš„ Google Sheet è©¦ç®—è¡¨ä¸­ï¼Œæ‰¾ä¸åˆ°ä¸€å€‹åç¨±å®Œå…¨ç¬¦åˆã€Œ<strong class="text-red-700">${sheetName}</strong>ã€çš„å·¥ä½œè¡¨åˆ†é ã€‚</p>
                            <p class="mt-4 text-sm text-gray-600">è«‹æ‚¨é–‹å•Ÿå¾Œç«¯çš„ Google Sheet æª”æ¡ˆï¼Œä¸¦ç¢ºèªå°æ‡‰çš„å·¥ä½œè¡¨åˆ†é åç¨±æ˜¯å¦èˆ‡ä¸Šæ–¹é¡¯ç¤ºçš„å®Œå…¨ä¸€è‡´ã€‚</p>
                        </div>
                    `;
                }
                
                const banner = document.getElementById('connection-error-banner');
                if (banner) banner.classList.remove('hidden');

                document.getElementById('pageContainer').innerHTML = errorMessage;
                document.getElementById('memberList').innerHTML = `<div class="text-red-500 p-4">æˆå“¡åˆ—è¡¨è¼‰å…¥å¤±æ•—</div>`;
                lastUpdatedElement.textContent = 'ä¸Šæ¬¡æ›´æ–°ï¼šè¼‰å…¥å¤±æ•—';
            } finally {
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
            }
        }
        
        function updateCasesView() {
            if (currentView !== 'cases') return;

            let totalCases = allCasesData.length;
            let totalUsed = 0;
            let totalRemaining = 0;
            let totalBudget = 0; 

            allCasesData.forEach(item => {
                const used = parseFloat(item['å·²ä½¿ç”¨ç¸½é¡'] || 0);
                const remaining = parseFloat(item['ç¸½é¡åº¦é¤˜é¡'] || 0);
                totalUsed += used;
                totalRemaining += remaining;
                const budget = used + remaining; 
                if (budget > 0) {
                    totalBudget += budget;
                }
            });

            document.getElementById('totalCases').textContent = totalCases;

            const searchInput = document.getElementById('searchInput');
            if (!searchInput.dataset.listenerAttached) {
                searchInput.addEventListener('input', (e) => filterAndRenderCases(e.target.value, currentCaseFilter));
                document.getElementById('allCasesFilterBtn').addEventListener('click', () => filterAndRenderCases(searchInput.value, 'all'));
                document.getElementById('medicationFilterBtn').addEventListener('click', () => filterAndRenderCases(searchInput.value, 'medication'));
                document.getElementById('totalFilterBtn').addEventListener('click', () => filterAndRenderCases(searchInput.value, 'total'));
                searchInput.dataset.listenerAttached = 'true';
            }

            filterAndRenderCases('', 'all');
        }

        function renderCases(data) {
            const listContainer = document.getElementById('caseList');
            listContainer.innerHTML = '';
            
            if (!data || data.length === 0) {
                listContainer.innerHTML = '<div class="col-span-full text-center p-8 text-gray-500">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å€‹æ¡ˆè³‡æ–™ã€‚</div>';
                return;
            }

            const sorted = [...data].sort((a, b) => (b['å·²ä½¿ç”¨ç¸½é¡'] || 0) - (a['å·²ä½¿ç”¨ç¸½é¡'] || 0));
            
            sorted.forEach(item => {
                const totalUsed = item['å·²ä½¿ç”¨ç¸½é¡'] || 0;
                const medicationUsed = item['å·²ä½¿ç”¨è—¥è²»'] || 0;
                const identity = item['èº«åˆ†åˆ¥'] || ''; 
                const recentStatus = item['è¿‘æ³èªªæ˜'] || '';
                const medType = item['è—¥ç‰©ä½¿ç”¨'] || item['è—¥ç‰©ç¨®é¡'] || 'ç„¡';
                
                let bgColor = 'case-bg-default';
                if (totalUsed > 35000) bgColor = 'case-bg-high';
                else if (medicationUsed > 15000) bgColor = 'case-bg-medium';
                
                const rawStatus = item['ç‹€æ…‹'] || item['è¨»è¨˜'] || item['è¨»è¨˜ç‹€æ…‹'];
                const kColumnValue = rawStatus ? rawStatus.toString().trim() : '';
                
                let statusColor = 'case-status-default';
                let statusText = '?'; 

                if (kColumnValue.toUpperCase() === 'V') {
                    statusColor = 'case-status-v';
                    statusText = 'âœ“'; 
                } else if (kColumnValue) {
                    statusText = kColumnValue;
                }
                
                const caseJson = JSON.stringify(item).replace(/'/g, '&#39;');
                
                const pills = parseInt(item['å¯å†é–‹å¹¾ç²’']);
                const displayPills = isNaN(pills) ? (item['å¯å†é–‹å¹¾ç²’'] || 'N/A') : pills;
                
                const identityBadge = identity ? `<span class="text-xs font-semibold px-2 py-1 rounded bg-indigo-100 text-indigo-800 border border-indigo-200">${identity}</span>` : '';

                let cardContentHtml = '';

                const isSpecialIdentity = identity.includes('é‡è€ƒç…§') || identity.includes('ç·©èµ·è¨´');

                if (isSpecialIdentity) {
                    cardContentHtml = `
                        <div class="mt-auto pt-3 border-t border-gray-200">
                            <p class="text-xs font-bold text-gray-500 mb-1">è¿‘æ³èªªæ˜ï¼š</p>
                            <div class="text-sm text-gray-800 bg-white/50 p-2 rounded border border-gray-100 min-h-[3rem]">
                                ${recentStatus || '<span class="text-gray-400 italic">æœªå¡«å¯«</span>'}
                            </div>
                        </div>
                    `;
                } else {
                    const descHtml = recentStatus ? `
                        <div class="mt-2 pt-2 border-t border-dashed border-gray-300">
                            <p class="text-xs text-gray-500 truncate" title="${recentStatus}">èªªæ˜: ${recentStatus}</p>
                        </div>
                    ` : '';

                    cardContentHtml = `
                        <div class="text-sm text-gray-700 pt-3 border-t border-gray-200 mt-auto space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500">è—¥ç‰©ç¨®é¡:</span>
                                <span class="font-bold text-gray-800">${medType}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500">å¯å†é–‹å¹¾ç²’:</span>
                                <span class="font-bold text-gray-800 text-lg">${displayPills}</span>
                            </div>
                            ${descHtml}
                        </div>
                    `;
                }

                listContainer.innerHTML += `
                    <div class="${bgColor} rounded-xl shadow-lg p-6 flex flex-col gap-4 cursor-pointer border border-gray-200 hover:shadow-xl transition-shadow" onclick='window.showCaseDetails(${caseJson})'>
                        <div class="flex justify-between items-start gap-2">
                            <div class="flex flex-col gap-1">
                                <h3 class="text-xl font-bold text-link-title">${item['å€‹æ¡ˆå§“å'] || 'æœªå‘½å'}</h3>
                                <div class="flex flex-wrap gap-1">${identityBadge}</div>
                            </div>
                            <span class="text-xs font-bold px-2 py-1 rounded ${statusColor} min-w-[1.5rem] h-6 flex items-center justify-center flex-shrink-0">${statusText}</span>
                        </div>
                        <p class="text-sm text-gray-500">${item['å€‹ç®¡'] || 'N/A'} / ${item['ä¸»æ²»é†«å¸«'] || 'N/A'}</p>
                        ${cardContentHtml}
                    </div>
                `;
            });
        }
        
        function updateMonitoringView() {
            if (currentView !== 'monitoring') return;

            const pageContainer = document.getElementById('pageContainer');
            
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            
            const years = [...new Set(allMonitoringData
                .map(item => item['æ—¥æœŸ'] ? new Date(item['æ—¥æœŸ']).getFullYear() : null)
                .filter(year => year)
            )].sort((a, b) => b - a);

            if (!years.includes(currentYear)) {
                years.unshift(currentYear);
            }
            
            const yearOptions = years.map(year => `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year} å¹´</option>`).join('');
            const monthOptions = Array.from({length: 12}, (_, i) => i + 1).map(month => `<option value="${month}" ${month === currentMonth ? 'selected' : ''}>${month} æœˆ</option>`).join('');
            
            pageContainer.innerHTML = `
                <div id="monitoringFilters" class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="flex gap-2 flex-wrap">
                        <button data-filter="all" class="monitoring-filter-btn filter-btn filter-btn-active">å…¨éƒ¨é–€è¨º</button>
                        <button data-filter="Y798" class="monitoring-filter-btn filter-btn filter-btn-inactive">Y798é…’ç™®(æ¨¹æ—)</button>
                        <button data-filter="Y795" class="monitoring-filter-btn filter-btn filter-btn-inactive">Y795è—¥ç™®(æ¨¹æ—)</button>
                        <button data-filter="779W" class="monitoring-filter-btn filter-btn filter-btn-inactive">779Wé…’ç™®(ç¸½é™¢)</button>
                        <button data-filter="7790" class="monitoring-filter-btn filter-btn filter-btn-inactive">7790ç²¾ç¥ç§‘(ç¸½é™¢)</button>
                        <button data-filter="7791" class="monitoring-filter-btn filter-btn filter-btn-inactive">7791ç²¾ç¥ç§‘(æ¨¹æ—)</button>
                        <button data-filter="779M" class="monitoring-filter-btn filter-btn filter-btn-inactive">779Mç¾æ²™å†¬</button>
                    </div>
                    
                    <div class="flex gap-2 ml-auto items-center">
                        <button id="prevMonthBtn" class="btn btn-secondary px-3" title="ä¸Šå€‹æœˆ">&lt;</button>
                        <select id="monitoringYearFilterSelect" class="monitoring-filter-select select-filter">
                            <option value="all">æ‰€æœ‰å¹´ä»½</option>
                            ${yearOptions}
                        </select>
                        <select id="monitoringMonthFilterSelect" class="monitoring-filter-select select-filter">
                            <option value="all">æ‰€æœ‰æœˆä»½</option>
                            ${monthOptions}
                        </select>
                        <button id="nextMonthBtn" class="btn btn-secondary px-3" title="ä¸‹å€‹æœˆ">&gt;</button>
                    </div>
                </div>
                
                <div id="monitoringCalendarHeader" class="calendar-grid mb-2 hidden md:grid">
                    <div class="calendar-day-header">ä¸€</div>
                    <div class="calendar-day-header">äºŒ</div>
                    <div class="calendar-day-header">ä¸‰</div>
                    <div class="calendar-day-header">å››</div>
                    <div class="calendar-day-header">äº”</div>
                    <div class="calendar-day-header">å…­</div>
                    <div class="calendar-day-header">æ—¥</div>
                </div>
                <div id="monitoringCalendar" class="calendar-grid">
                </div>

                <div class="mt-6 p-4 bg-white rounded-lg border border-gray-200 shadow-sm inline-block min-w-[300px]">
                    <h4 class="font-bold text-gray-800 mb-3 text-sm border-b pb-2">é–€è¨ºæ›è™Ÿäººæ•¸å£…å¡ç¨‹åº¦åˆ†é¡ï¼š</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                        <div class="flex items-center">
                            <span class="badge badge-level-1 w-6 h-6 mr-2 !m-0"></span>
                            <span class="text-gray-600">ç¶ è‰²ï¼ˆæ­£å¸¸ï¼‰ï¼š0â€“5 äºº</span>
                        </div>
                        <div class="flex items-center">
                            <span class="badge badge-level-2 w-6 h-6 mr-2 !m-0"></span>
                            <span class="text-gray-600">é»ƒè‰²ï¼ˆç¨å¤šï¼‰ï¼š6â€“10 äºº</span>
                        </div>
                        <div class="flex items-center">
                            <span class="badge badge-level-3 w-6 h-6 mr-2 !m-0"></span>
                            <span class="text-gray-600">ç´…è‰²ï¼ˆå£…å¡ï¼‰ï¼š11â€“15 äºº</span>
                        </div>
                        <div class="flex items-center">
                            <span class="badge badge-level-4 w-6 h-6 mr-2 !m-0"></span>
                            <span class="text-gray-600">æ·±ç´…è‰²ï¼ˆæ¥µåº¦å£…å¡ï¼‰ï¼š16 äººä»¥ä¸Š</span>
                        </div>
                    </div>
                </div>

                <button id="addMonitoringItemBtn" onclick="window.openAddMonitoringModal()" class="fixed bottom-12 right-12 bg-blue-600 text-white w-16 h-16 rounded-full flex items-center justify-center text-4xl shadow-lg hover:bg-blue-700 transition-all">+</button>
            `;
            
            document.querySelectorAll('.monitoring-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.monitoring-filter-btn').forEach(b => b.classList.replace('filter-btn-active', 'filter-btn-inactive'));
                    btn.classList.replace('filter-btn-inactive', 'filter-btn-active');
                    applyMonitoringFilters();
                });
            });
            
            document.querySelectorAll('.monitoring-filter-select').forEach(select => {
                select.addEventListener('change', applyMonitoringFilters);
            });

            document.getElementById('prevMonthBtn').addEventListener('click', () => changeMonitoringMonth(-1));
            document.getElementById('nextMonthBtn').addEventListener('click', () => changeMonitoringMonth(1));
            
            applyMonitoringFilters();
        }

        function changeMonitoringMonth(offset) {
            const yearSelect = document.getElementById('monitoringYearFilterSelect');
            const monthSelect = document.getElementById('monitoringMonthFilterSelect');
            
            let year = parseInt(yearSelect.value);
            let month = parseInt(monthSelect.value);
            
            if (isNaN(year) || isNaN(month)) {
                const now = new Date();
                year = now.getFullYear();
                month = now.getMonth() + 1;
            }

            const newDate = new Date(year, month - 1 + offset, 1);
            const newYear = newDate.getFullYear();
            const newMonth = newDate.getMonth() + 1;

            let yearOption = yearSelect.querySelector(`option[value="${newYear}"]`);
            if (!yearOption) {
                yearOption = document.createElement('option');
                yearOption.value = newYear;
                yearOption.text = `${newYear} å¹´`;
                yearSelect.add(yearOption);
            }
            
            yearSelect.value = newYear;
            monthSelect.value = newMonth;
            
            applyMonitoringFilters();
        }

        function applyMonitoringFilters() {
            const clinicFilter = document.querySelector('.monitoring-filter-btn.filter-btn-active').dataset.filter;
            const yearFilter = document.getElementById('monitoringYearFilterSelect').value;
            const monthFilter = document.getElementById('monitoringMonthFilterSelect').value;

            let filteredData = allMonitoringData;
            
            if (clinicFilter !== 'all') {
                filteredData = filteredData.filter(item => item['é–€è¨º'] && item['é–€è¨º'].startsWith(clinicFilter));
            }
            
            renderMonitoringCalendar(parseInt(yearFilter, 10), parseInt(monthFilter, 10), filteredData);
        }

        function renderMonitoringCalendar(year, month, data) {
            const listContainer = document.getElementById('monitoringCalendar');
            if (!listContainer) return;

            listContainer.innerHTML = '';
            
            let firstDay = new Date(year, month - 1, 1).getDay();
            firstDay = (firstDay === 0) ? 6 : (firstDay - 1); 
            
            const daysInMonth = new Date(year, month, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                listContainer.innerHTML += `<div class="calendar-day-empty hidden md:block"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const isoDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const itemsForThisDay = data.filter(item => {
                    if (!item['æ—¥æœŸ']) return false;
                    return item['æ—¥æœŸ'].startsWith(isoDate);
                });

                const badgesHtml = itemsForThisDay.map(item => {
                    const registered = parseInt(item['å·²æ›è™Ÿäººæ•¸'] || 0, 10);
                    let badgeClass = '';
                    
                    if (item['æ˜¯å¦åœè¨º'] === 'æ˜¯') {
                        badgeClass = 'badge-closed';
                    } else if (registered >= 16) {
                        badgeClass = 'badge-level-4'; 
                    } else if (registered >= 11) {
                        badgeClass = 'badge-level-3'; 
                    } else if (registered >= 6) {
                        badgeClass = 'badge-level-2'; 
                    } else {
                        badgeClass = 'badge-level-1'; 
                    }

                    let badgeText = 'è¨º';
                    if (item['æ˜¯å¦åœè¨º'] === 'æ˜¯') badgeText = 'åœ';
                    else if (item['é–€è¨º'].includes('é…’')) badgeText = 'é…’';
                    else if (item['é–€è¨º'].includes('è—¥')) badgeText = 'è—¥';
                    else if (item['é–€è¨º'].includes('ç²¾ç¥')) badgeText = 'ç²¾';
                    
                    return `<span class="badge ${badgeClass}">${badgeText}</span>`;
                }).join('');
                
                listContainer.innerHTML += `
                    <div class="calendar-day">
                        <div class="day-content" onclick="window.showMonitoringDetailsForDay('${isoDate}')">
                            <span class="day-number">${day}</span>
                            <div class="badge-container">
                                ${badgesHtml}
                            </div>
                        </div>
                    </div>
                `;
            }
        }


        let currentCaseFilter = 'all'; 
        function filterAndRenderCases(searchTerm = '', filterType = 'all') {
             currentCaseFilter = filterType; 
             let filtered = allCasesData;
             searchTerm = searchTerm.toLowerCase();

            const medBtn = document.getElementById('medicationFilterBtn');
            const totalBtn = document.getElementById('totalFilterBtn');
            const allBtn = document.getElementById('allCasesFilterBtn');

            if (medBtn) medBtn.classList.replace('filter-btn-active', 'filter-btn-inactive');
            if (totalBtn) totalBtn.classList.replace('filter-btn-active', 'filter-btn-inactive');
            if (allBtn) allBtn.classList.replace('filter-btn-active', 'filter-btn-inactive');
            
            if (filterType === 'medication') {
                filtered = filtered.filter(item => (item['å·²ä½¿ç”¨è—¥è²»'] || 0) > 15000);
                if (medBtn) medBtn.classList.replace('filter-btn-inactive', 'filter-btn-active');
            } else if (filterType === 'total') {
                filtered = filtered.filter(item => (item['å·²ä½¿ç”¨ç¸½é¡'] || 0) > 35000);
                if (totalBtn) totalBtn.classList.replace('filter-btn-inactive', 'filter-btn-active');
            } else {
                if (allBtn) allBtn.classList.replace('filter-btn-inactive', 'filter-btn-active');
            }

            if (searchTerm) {
                filtered = filtered.filter(item => 
                    (item['å€‹æ¡ˆå§“å']?.toLowerCase().includes(searchTerm)) || 
                    (item['å€‹ç®¡']?.toLowerCase().includes(searchTerm)) || 
                    (String(item['ç—…æ­·è™Ÿ'])?.toLowerCase().includes(searchTerm))
                );
            }

            renderCases(filtered);
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(function(){ toast.classList.remove('show'); }, 4000);
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                window.closeModal(event.target.id);
            }
        };

        Object.assign(window, {
            showCaseDetails: function(caseItem) {
                document.getElementById('caseModalTitle').textContent = `å€‹æ¡ˆè©³ç´°è³‡æ–™`;
                document.getElementById('caseModalCaseName').textContent = caseItem['å€‹æ¡ˆå§“å'] || 'N/A';
                document.getElementById('caseModalRecordNumber').textContent = caseItem['ç—…æ­·è™Ÿ'] || 'N/A';
                
                const identity = caseItem['èº«åˆ†åˆ¥'] || '';
                const identityEl = document.getElementById('caseModalIdentity');
                if (identity) {
                    identityEl.textContent = identity;
                    identityEl.style.display = 'inline-block';
                } else {
                    identityEl.style.display = 'none';
                }

                document.getElementById('caseModalRecentStatus').textContent = caseItem['è¿‘æ³èªªæ˜'] || 'ç„¡';

                document.getElementById('caseModalManagerDoctor').textContent = `${caseItem['å€‹ç®¡'] || 'N/A'} / ${caseItem['ä¸»æ²»é†«å¸«'] || 'N/A'}`;
                document.getElementById('caseModalTotalUsed').textContent = formatCurrency(caseItem['å·²ä½¿ç”¨ç¸½é¡']);
                document.getElementById('caseModalTotalRemaining').textContent = formatCurrency(caseItem['ç¸½é¡åº¦é¤˜é¡']);
                document.getElementById('caseModalMedicationUsed').textContent = formatCurrency(caseItem['å·²ä½¿ç”¨è—¥è²»']);
                document.getElementById('caseModalMedicationRemaining').textContent = formatCurrency(caseItem['è—¥è²»é¤˜é¡']);
                document.getElementById('caseModalMedicationType').textContent = caseItem['è—¥ç‰©ä½¿ç”¨'] || 'N/A';
                
                const pills = parseInt(caseItem['å¯å†é–‹å¹¾ç²’']);
                const displayPills = isNaN(pills) ? (caseItem['å¯å†é–‹å¹¾ç²’'] || 'N/A') : pills;
                document.getElementById('caseModalPillsRemaining').textContent = displayPills;
                
                document.getElementById('caseModal').style.display = 'flex';
            },

            populateMemberSelection: function(leadNames = [], teamNames = []) {
                const leadContainer = document.getElementById('projectLeadSelection');
                const teamContainer = document.getElementById('projectTeamSelection');
                leadContainer.innerHTML = ''; teamContainer.innerHTML = '';
                if (!allMembersData || allMembersData.length === 0) { leadContainer.innerHTML = teamContainer.innerHTML = '<p>ç„¡æ³•è¼‰å…¥æˆå“¡åˆ—è¡¨ã€‚</p>'; return; }
                allMembersData.forEach(member => {
                    const name = member['å§“å']?.trim(); if (!name) return;
                    const leadChecked = leadNames.includes(name) ? 'checked' : '';
                    const teamChecked = teamNames.includes(name) ? 'checked' : '';
                    leadContainer.innerHTML += `<div class="flex items-center"><input id="lead_${name}" value="${name}" type="checkbox" ${leadChecked} class="h-4 w-4"><label for="lead_${name}" class="ml-3">${name}</label></div>`;
                    teamContainer.innerHTML += `<div class="flex items-center"><input id="team_${name}" value="${name}" type="checkbox" ${teamChecked} class="h-4 w-4"><label for="team_${name}" class="ml-3">${name}</label></div>`;
                });
            },
            
            populateTodoMemberSelects: function(assigneeVal = '', assignerVal = '') {
                const assigneeSelect = document.getElementById('todoAssignee');
                const assignerSelect = document.getElementById('todoAssigner');
                
                let optionsHtml = '<option value="">è«‹é¸æ“‡...</option>';
                
                if (allMembersData && allMembersData.length > 0) {
                     const sorted = [...allMembersData].sort((a, b) => (a['æ’åº'] || 99) - (b['æ’åº'] || 99));
                     sorted.forEach(member => {
                         const name = member['å§“å']?.trim();
                         if (name) {
                             optionsHtml += `<option value="${name}">${name}</option>`;
                         }
                     });
                }
                
                assigneeSelect.innerHTML = optionsHtml;
                assignerSelect.innerHTML = optionsHtml;
                
                assigneeSelect.value = assigneeVal;
                assignerSelect.value = assignerVal;
            },

            showProjectDetails: function(projectId) {
                const project = allProjectsData.find(p => p.ID === projectId); if (!project) return;
                document.getElementById('detailProjectName').textContent = project['å°ˆæ¡ˆåç¨±'];
                
                const { status, colorClass, progress, totalTasks, completedTasks } = getCalculatedProjectStatus(project);
                
                const progressHtml = `
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-sm font-semibold text-gray-700">å®Œæˆé€²åº¦</span>
                        <span class="text-sm font-bold text-gray-700" id="modalProgressText">${Math.round(progress)}% (${completedTasks}/${totalTasks})</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="modalProgressBar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                `;
                document.getElementById('detailProjectProgress').innerHTML = progressHtml;
                
                document.getElementById('projectDetailContent').innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm"><p><strong>é¡å‹:</strong> ${project['ä»»å‹™é¡å‹']}</p><p><strong>æ‰€å±¬å°çµ„:</strong> ${project['æ‰€å±¬å°çµ„']}</p><p><strong>ç‹€æ…‹:</strong> ${project['ç‹€æ…‹']}</p><p><strong>å„ªå…ˆç´š:</strong> ${project['å„ªå…ˆç´š']}</p><p><strong>é–‹å§‹æ—¥æœŸ:</strong> ${formatSimpleDate(project['é–‹å§‹æ—¥æœŸ'])}</p><p><strong>æˆªæ­¢æ—¥æœŸ:</strong> ${formatSimpleDate(project['æˆªæ­¢æ—¥æœŸ'])}</p><p class="col-span-2"><strong>ä¸»è¦è² è²¬äºº:</strong> ${project['ä¸»è¦è² è²¬']}</p><p class="col-span-2"><strong>å”åŒäººå“¡:</strong> ${project['å”åŒè² è²¬']}</p><p class="col-span-2"><strong>å‚™è¨»:</strong> ${project['å‚™è¨»'] || 'ç„¡'}</p></div>`;
                
                const checklistContainer = document.getElementById('detailProjectChecklist');
                checklistContainer.innerHTML = '';
                
                let checkpoints = project['æª¢æŸ¥é»'];
                if (typeof checkpoints === 'string') {
                    try {
                        checkpoints = JSON.parse(checkpoints);
                    } catch (e) {
                        checkpoints = [];
                    }
                }
                if (!Array.isArray(checkpoints)) checkpoints = [];

                if (checkpoints && checkpoints.length > 0) {
                     let checklistHtml = '<h4 class="text-lg font-semibold mb-2">æª¢æŸ¥é»</h4>';
                     checkpoints.forEach((item, itemIndex) => { 
                         checklistHtml += `
                         <div class="flex items-center mb-2 hover:bg-gray-50 p-1 rounded">
                            <input type="checkbox" id="check_${projectId}_${itemIndex}" onchange="window.updateChecklistItemStatus('${projectId}', ${itemIndex}, this.checked)" class="h-5 w-5 cursor-pointer text-blue-600 focus:ring-blue-500 border-gray-300 rounded" ${item.completed ? 'checked' : ''}>
                            <label for="check_${projectId}_${itemIndex}" class="ml-3 cursor-pointer select-none ${item.completed ? 'line-through text-gray-500' : 'text-gray-700'}">${item.text}</label>
                         </div>`; 
                     });
                    checklistContainer.innerHTML = checklistHtml;
                } else {
                    checklistContainer.innerHTML = '<p class="text-sm text-gray-400 italic">ç„¡æª¢æŸ¥é»</p>';
                }
                
                const editBtn = document.getElementById('editProjectBtn');
                const deleteBtn = document.getElementById('deleteProjectBtn');
                editBtn.style.display = 'inline-block';
                deleteBtn.style.display = 'inline-block';
                editBtn.onclick = () => window.openEditProjectModal(projectId);
                deleteBtn.onclick = () => window.openDeleteConfirmModal(projectId, 'project');

                document.getElementById('projectDetailModal').style.display = 'flex';
            },

            showMonitoringDetailsForDay: function(isoDate) {
                const modal = document.getElementById('monitoringDayDetailModal');
                const title = document.getElementById('monitoringDayDetailTitle');
                const content = document.getElementById('monitoringDayDetailContent');
                
                const formattedDate = formatSimpleDate(isoDate);
                title.textContent = `${formattedDate} é–€è¨ºè©³æƒ…`;

                const itemsForThisDay = allMonitoringData.filter(item => {
                    if (!item['æ—¥æœŸ']) return false;
                    return item['æ—¥æœŸ'].startsWith(isoDate);
                }).sort((a, b) => (a['é–€è¨º'] || '').localeCompare(b['é–€è¨º']));

                if (itemsForThisDay.length === 0) {
                    content.innerHTML = '<p class="text-gray-500">æœ¬æ—¥ç„¡ï¼ˆæˆ–ç„¡ç¬¦åˆç¯©é¸çš„ï¼‰é–€è¨ºè³‡æ–™ã€‚</p>';
                    modal.style.display = 'flex';
                    return;
                }

                content.innerHTML = itemsForThisDay.map(item => {
                    const isClosed = item['æ˜¯å¦åœè¨º'] === 'æ˜¯';
                    const registered = parseInt(item['å·²æ›è™Ÿäººæ•¸'] || 0, 10);
                    const newCases = parseInt(item['æ–°æ¡ˆ'] || 0, 10);
                    let cardBorderColor = 'monitor-border-default';

                    if (isClosed) {
                        cardBorderColor = 'monitor-border-closed';
                    } else if (registered >= 16) {
                        cardBorderColor = 'monitor-border-level-4';
                    } else if (registered >= 11) {
                        cardBorderColor = 'monitor-border-level-3';
                    } else if (registered >= 6) {
                        cardBorderColor = 'monitor-border-level-2';
                    } else {
                        cardBorderColor = 'monitor-border-level-1';
                    }
                    
                    return `
                        <div class="bg-white ${cardBorderColor} rounded-xl shadow-lg p-6 flex flex-col gap-4 cursor-pointer border border-gray-200 hover:shadow-xl transition-shadow">
                            <div class="flex justify-between items-start gap-2">
                                <h3 class="text-xl font-bold text-link-title hover:text-blue-600 cursor-pointer flex items-center gap-2" 
                                    onclick="window.closeModal('monitoringDayDetailModal'); window.openEditMonitoringModal('${item.ID}')" 
                                    title="é»æ“Šç·¨è¼¯è³‡æ–™">
                                    ${item['é–€è¨º']}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 hover:text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>
                                </h3>
                            </div>
                            
                            ${isClosed ? `
                                <div class="text-center p-4">
                                    <p class="text-2xl font-bold text-gray-500">æœ¬æ—¥åœè¨º</p>
                                </div>
                            ` : `
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div>
                                        <p class="text-3xl font-bold text-gray-800">${registered}</p>
                                        <p class="text-sm text-gray-500">å·²æ›è™Ÿäººæ•¸</p>
                                    </div>
                                    <div>
                                        <p class="text-3xl font-bold text-gray-800">${newCases}</p>
                                        <p class="text-sm text-gray-500">æ–°æ¡ˆ</p>
                                    </div>
                                </div>
                            `}
                            
                            <div class="text-xs text-gray-400 pt-2 border-t mt-auto">
                                <p>ä¸Šæ¬¡æ›´æ–°: ${item['ä¸Šæ¬¡æ›´æ–°æ™‚é–“'] ? new Date(item['ä¸Šæ¬¡æ›´æ–°æ™‚é–“']).toLocaleString('zh-TW') : 'N/A'}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                
                modal.style.display = 'flex';
            },

            openAddProjectModal: function() {
                document.getElementById('addProjectForm').reset();
                document.getElementById('editProjectId').value = '';
                document.getElementById('projectModalTitle').textContent = 'æ–°å¢é …ç›®';
                document.getElementById('checklistItemContainer').innerHTML = '';
                window.populateMemberSelection();
                document.getElementById('addProjectModal').style.display = 'flex';
            },

            openEditProjectModal: function(projectId) {
                const project = allProjectsData.find(p => p.ID === projectId);
                if (!project) { showToast('æ‰¾ä¸åˆ°å°ˆæ¡ˆè³‡æ–™'); return; }

                closeModal('projectDetailModal');
                const form = document.getElementById('addProjectForm');
                form.reset();

                document.getElementById('projectModalTitle').textContent = 'ç·¨è¼¯é …ç›®';
                document.getElementById('editProjectId').value = projectId;

                document.getElementById('projectName').value = project['å°ˆæ¡ˆåç¨±'] || '';
                document.getElementById('projectGroup').value = project['æ‰€å±¬å°çµ„'] || 'é™¢å…§';
                document.getElementById('projectType').value = project['ä»»å‹™é¡å‹'] || 'ä»»å‹™';
                document.getElementById('projectDescription').value = project['å‚™è¨»'] || '';
                document.getElementById('projectStatus').value = project['ç‹€æ…‹'] || 'é€²è¡Œä¸­';
                document.getElementById('projectPriority').value = project['å„ªå…ˆç´š'] || 'ä¸­';
                document.getElementById('startDate').value = toISODateString(project['é–‹å§‹æ—¥æœŸ'] || '');
                document.getElementById('endDate').value = toISODateString(project['æˆªæ­¢æ—¥æœŸ'] || '');

                const leads = (project['ä¸»è¦è² è²¬'] || '').split(',').map(s => s.trim());
                const team = (project['å”åŒè² è²¬'] || '').split(',').map(s => s.trim());
                window.populateMemberSelection(leads, team);

                const checklistContainer = document.getElementById('checklistItemContainer');
                checklistContainer.innerHTML = '';
                
                let checkpoints = project['æª¢æŸ¥é»'];
                if (typeof checkpoints === 'string') {
                    try {
                        checkpoints = JSON.parse(checkpoints);
                    } catch (e) {
                        checkpoints = [];
                    }
                }
                if (!Array.isArray(checkpoints)) checkpoints = [];
                
                if (checkpoints) {
                    checkpoints.forEach(item => addChecklistItemToForm(item));
                }

                document.getElementById('addProjectModal').style.display = 'flex';
            },

            openDeleteConfirmModal: function(id, type) {
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                if (type === 'project') {
                    confirmBtn.onclick = () => window.executeDeleteProject(id);
                } else if (type === 'monitoring') {
                    confirmBtn.onclick = () => window.executeDeleteMonitoringItem(id);
                } else if (type === 'todo') {
                    confirmBtn.onclick = () => window.executeDeleteTodo(id);
                } else if (type === 'event') {
                    confirmBtn.onclick = () => window.executeDeleteEvent(id);
                }
                document.getElementById('deleteConfirmModal').style.display = 'flex';
            },
            
            executeDeleteProject: async function(projectId) {
                closeModal('deleteConfirmModal');
                showToast('æ­£åœ¨åˆªé™¤...');
                const payload = { action: 'DELETE_PROJECT', id: projectId, sheetName: 'åœ˜éšŠå°ˆæ¡ˆ' };
                
                try {
                    await sendDataToAppsScript(payload);
                    allProjectsData = allProjectsData.filter(p => p.ID !== projectId);
                    applyProjectFilters();
                    renderMembersList(allProjectsData);
                    closeModal('projectDetailModal');
                    showToast('å°ˆæ¡ˆå·²æˆåŠŸåˆªé™¤ï¼');
                } catch (error) {
                    showToast(`åˆªé™¤å¤±æ•—: ${error.message}`);
                }
            },

            executeDeleteMonitoringItem: async function(monitoringId) {
                closeModal('deleteConfirmModal');
                showToast('æ­£åœ¨åˆªé™¤...');
                const payload = { action: 'DELETE_MONITORING_ITEM', id: monitoringId, sheetName: 'é–€è¨ºç›£æ¸¬' };
                
                try {
                    await sendDataToAppsScript(payload);
                    allMonitoringData = allMonitoringData.filter(m => m.ID !== monitoringId);
                    applyMonitoringFilters(); 
                    closeModal('addMonitoringModal'); 
                    showToast('é–€è¨ºé …ç›®å·²æˆåŠŸåˆªé™¤ï¼');
                } catch (error) {
                    showToast(`åˆªé™¤å¤±æ•—: ${error.message}`);
                }
            },
            
            executeDeleteEvent: async function(eventId) {
                closeModal('deleteConfirmModal');
                showToast('æ­£åœ¨åˆªé™¤...');
                const payload = { action: 'DELETE_EVENT', id: eventId, sheetName: 'åœ˜éšŠæœƒè­°' };
                
                try {
                    await sendDataToAppsScript(payload);
                    allEventsData = allEventsData.filter(e => e.ID !== eventId);
                    applyEventFilters(); 
                    closeModal('addEventModal');
                    showToast('æœƒè­°å·²æˆåŠŸåˆªé™¤ï¼');
                } catch (error) {
                    showToast(`åˆªé™¤å¤±æ•—: ${error.message}`);
                }
            },

            openAddMonitoringModal: function() {
                document.getElementById('addProjectForm').reset();
                document.getElementById('editMonitoringId').value = '';
                document.getElementById('monitoringModalTitle').textContent = 'æ–°å¢é–€è¨ºé …ç›®';
                
                document.getElementById('monitoringIsClosed').checked = false;
                document.getElementById('monitoringRegisteredCount').disabled = false;
                document.getElementById('monitoringNewCases').disabled = false;
                document.getElementById('monitoringDateError').classList.add('hidden');

                const deleteBtn = document.getElementById('formDeleteMonitoringBtn');
                if (deleteBtn) {
                    deleteBtn.style.display = 'none';
                }

                document.getElementById('addMonitoringModal').style.display = 'flex';
            },

            openEditMonitoringModal: function(monitoringId) {
                const item = allMonitoringData.find(m => m.ID === monitoringId);
                if (!item) { showToast('æ‰¾ä¸åˆ°é–€è¨ºè³‡æ–™'); return; }

                const form = document.getElementById('addMonitoringForm');
                form.reset();

                document.getElementById('monitoringModalTitle').textContent = 'ç·¨è¼¯é–€è¨ºé …ç›®';
                document.getElementById('editMonitoringId').value = monitoringId;

                document.getElementById('monitoringItemName').value = item['é–€è¨º'] || '';
                document.getElementById('monitoringDate').value = toISODateString(item['æ—¥æœŸ'] || '');
                document.getElementById('monitoringRegisteredCount').value = item['å·²æ›è™Ÿäººæ•¸'] || 0;
                document.getElementById('monitoringNewCases').value = item['æ–°æ¡ˆ'] || 0;
                
                const isClosed = item['æ˜¯å¦åœè¨º'] === 'æ˜¯';
                const checkbox = document.getElementById('monitoringIsClosed');
                const countInput = document.getElementById('monitoringRegisteredCount');
                const newInput = document.getElementById('monitoringNewCases');
                
                checkbox.checked = isClosed;
                countInput.disabled = isClosed;
                newInput.disabled = isClosed;
                
                if (isClosed) {
                    countInput.value = '';
                    newInput.value = '';
                }
                
                document.getElementById('monitoringDateError').classList.add('hidden');

                let deleteBtn = document.getElementById('formDeleteMonitoringBtn');
                deleteBtn.style.display = 'inline-block';
                deleteBtn.onclick = () => window.openDeleteConfirmModal(monitoringId, 'monitoring');

                document.getElementById('addMonitoringModal').style.display = 'flex';
            },

            updateChecklistItemStatus: async function(projectId, itemIndex, isChecked) {
                const projectIndex = allProjectsData.findIndex(p => p.ID === projectId);
                if (projectIndex === -1) return;

                let project = allProjectsData[projectIndex];
                
                let checkpointsRaw = project['æª¢æŸ¥é»'];
                if (typeof checkpointsRaw === 'string') {
                    try { checkpointsRaw = JSON.parse(checkpointsRaw); } catch(e) { checkpointsRaw = []; }
                }
                let checkpoints = Array.isArray(checkpointsRaw) ? [...checkpointsRaw] : [];

                if (checkpoints[itemIndex]) {
                    checkpoints[itemIndex] = { ...checkpoints[itemIndex], completed: isChecked };
                    project['æª¢æŸ¥é»'] = checkpoints; 
                    
                    const payload = {
                        action: 'UPDATE_PROJECT',
                        sheetName: 'åœ˜éšŠå°ˆæ¡ˆ', 
                        data: { ...project, 'æª¢æŸ¥é»': JSON.stringify(checkpoints) }
                    };
                    
                    const { progress, totalTasks, completedTasks } = getCalculatedProjectStatus(project);
                    const progressBar = document.getElementById('modalProgressBar');
                    const progressText = document.getElementById('modalProgressText');
                    if (progressBar && progressText) {
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${Math.round(progress)}% (${completedTasks}/${totalTasks})`;
                    }
                    
                    const label = document.querySelector(`label[for='check_${projectId}_${itemIndex}']`);
                    if(label) {
                         if(isChecked) {
                             label.classList.add('line-through', 'text-gray-500');
                             label.classList.remove('text-gray-700');
                         } else {
                             label.classList.remove('line-through', 'text-gray-500');
                             label.classList.add('text-gray-700');
                         }
                    }

                    try {
                        await sendDataToAppsScript(payload);
                        showToast('æª¢æŸ¥é»ç‹€æ…‹å·²æ›´æ–°ï¼');
                        allProjectsData[projectIndex] = project; 
                        applyProjectFilters();
                        
                    } catch (error) {
                        showToast(`æ›´æ–°å¤±æ•—: ${error.message}`);
                        checkpoints[itemIndex].completed = !isChecked;
                        project['æª¢æŸ¥é»'] = checkpoints;
                        allProjectsData[projectIndex] = project;

                        const checkbox = document.getElementById(`check_${projectId}_${itemIndex}`);
                        if (checkbox) checkbox.checked = !isChecked;
                        
                        const label = document.querySelector(`label[for='check_${projectId}_${itemIndex}']`);
                        if(label) {
                             if(!isChecked) {
                                 label.classList.add('line-through', 'text-gray-500');
                                 label.classList.remove('text-gray-700');
                             } else {
                                 label.classList.remove('line-through', 'text-gray-500');
                                 label.classList.add('text-gray-700');
                             }
                        }
                        
                        const { progress: oldProgress, totalTasks: oldTotal, completedTasks: oldCompleted } = getCalculatedProjectStatus(project);
                        if (progressBar && progressText) {
                            progressBar.style.width = `${oldProgress}%`;
                            progressText.textContent = `${Math.round(oldProgress)}% (${oldCompleted}/${oldTotal})`;
                        }
                    }
                }
            },

            openAddEventModal: function(dateStr) {
                document.getElementById('addEventForm').reset();
                document.getElementById('editEventId').value = '';
                document.getElementById('eventModalTitle').textContent = 'æ–°å¢æœƒè­°';
                
                if (dateStr) {
                    document.getElementById('eventDate').value = dateStr;
                }
                
                const deleteBtn = document.getElementById('formDeleteEventBtn');
                if (deleteBtn) deleteBtn.style.display = 'none';

                document.getElementById('addEventModal').style.display = 'flex';
            },

            openEditEventModal: function(eventId) {
                const event = allEventsData.find(e => e.ID === eventId);
                if (!event) { showToast('æ‰¾ä¸åˆ°æœƒè­°è³‡æ–™'); return; }

                const form = document.getElementById('addEventForm');
                form.reset();

                document.getElementById('eventModalTitle').textContent = 'ç·¨è¼¯æœƒè­°';
                document.getElementById('editEventId').value = eventId;

                document.getElementById('eventName').value = event['æœƒè­°'] || '';
                document.getElementById('eventDate').value = toISODateString(event['æ—¥æœŸ'] || '');
                document.getElementById('eventStartTime').value = event['é–‹å§‹æ™‚é–“'] || '';
                document.getElementById('eventEndTime').value = event['çµæŸæ™‚é–“'] || '';
                document.getElementById('eventOrganizer').value = event['ä¸»è¾¦å–®ä½'] || '';
                document.getElementById('eventContact').value = event['è¯çµ¡äºº'] || '';
                document.getElementById('eventNote').value = event['å‚™è¨»'] || '';

                const deleteBtn = document.getElementById('formDeleteEventBtn');
                deleteBtn.style.display = 'inline-block';
                deleteBtn.onclick = () => window.openDeleteConfirmModal(eventId, 'event');

                document.getElementById('addEventModal').style.display = 'flex';
            }
        });
        
        function openAddTodoModal() {
            document.getElementById('addTodoForm').reset();
            document.getElementById('editTodoId').value = '';
            document.getElementById('todoModalTitle').textContent = 'æ–°å¢å¾…è¾¦äº‹é …';
            
            window.populateTodoMemberSelects();
            
            document.getElementById('formDeleteTodoBtn').style.display = 'none';
            
            document.getElementById('addTodoModal').style.display = 'flex';
        }

        function openEditTodoModal(todoId) {
            const todo = allTodosData.find(t => t.ID === todoId);
            if (!todo) { showToast('æ‰¾ä¸åˆ°å¾…è¾¦äº‹é …'); return; }

            const form = document.getElementById('addTodoForm');
            form.reset();

            document.getElementById('todoModalTitle').textContent = 'ç·¨è¼¯å¾…è¾¦äº‹é …';
            document.getElementById('editTodoId').value = todoId;
            
            window.populateTodoMemberSelects(todo['è² è²¬äºº'], todo['æŒ‡æ´¾äºº']);

            document.getElementById('todoName').value = todo['äº‹é …'] || '';
            document.getElementById('todoStatus').value = todo['ç‹€æ…‹'] || 'å¾…è¾¦';
            document.getElementById('todoPriority').value = todo['å„ªå…ˆç´š'] || 'ä¸­';
            document.getElementById('todoDueDate').value = toISODateString(todo['æˆªæ­¢æ—¥æœŸ'] || '');
            document.getElementById('todoNote').value = todo['å‚™è¨»'] || '';

            const deleteBtn = document.getElementById('formDeleteTodoBtn');
            deleteBtn.style.display = 'inline-block';
            deleteBtn.onclick = () => window.openDeleteConfirmModal(todoId, 'todo');

            document.getElementById('addTodoModal').style.display = 'flex';
        }

        function openDeleteConfirmModal(id, type) {
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            if (type === 'project') {
                confirmBtn.onclick = () => window.executeDeleteProject(id);
            } else if (type === 'monitoring') {
                confirmBtn.onclick = () => window.executeDeleteMonitoringItem(id);
            } else if (type === 'todo') {
                confirmBtn.onclick = () => window.executeDeleteTodo(id);
            } else if (type === 'event') {
                confirmBtn.onclick = () => window.executeDeleteEvent(id);
            }
            document.getElementById('deleteConfirmModal').style.display = 'flex';
        }

        async function executeDeleteTodo(todoId) {
            closeModal('deleteConfirmModal');
            showToast('æ­£åœ¨åˆªé™¤...');
            const payload = { action: 'DELETE_TODO', id: todoId, sheetName: 'å¾…è¾¦äº‹é …' };
            
            try {
                await sendDataToAppsScript(payload);
                allTodosData = allTodosData.filter(t => t.ID !== todoId);
                renderTodosPage(); 
                closeModal('addTodoModal');
                showToast('å¾…è¾¦äº‹é …å·²æˆåŠŸåˆªé™¤ï¼');
            } catch (error) {
                showToast(`åˆªé™¤å¤±æ•—: ${error.message}`);
            }
        }

    </script>
</body>
</html>
