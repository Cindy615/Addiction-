<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成癮防治科儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fbfbf2; /* 變更: 使用者指定背景色 */
        }
        .container-fluid {
            min-height: calc(100vh - 4rem);
        }
        .scroll-container {
            max-height: calc(100vh - 12rem);
            overflow-y: auto;
        }
        .member-container::-webkit-scrollbar {
            display: none;
        }
        .member-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* 變更: Tab 按鈕 (Active) */
        .tab-button.active {
            background-color: #5b6b51; /* 變更: 森綠 */
            color: white;
            box-shadow: 0 4px 6px rgba(91, 107, 81, 0.3); /* 變更: 陰影 */
        }
        /* 變更: Tab 按鈕 (Inactive) */
        .tab-button {
            background-color: #c3b4a3;
            color: #0d3136;
            font-weight: 600;
        }
        .tab-button:hover {
            background-color: #a99a8a;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-content-lg {
            max-width: 800px;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #0d3136; /* 變更: 墨黑 */
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        
        /* --- 確保 CSS 樣式是乾淨的 --- */
        #password-screen {
            background-color: #fbfbf2; /* 變更: 使用者指定背景色 */
        }
        #dashboard-container {
             background-color: #fbfbf2; /* 變更: 儀表板主體背景 */
        }
         /* 變更: 卡片/密碼彈窗背景 (維持白色以保持對比) */
         aside.bg-white, #mainContent.bg-white, .modal-content, #password-screen > div {
            background-color: #FFFFFF;
         }

         /* --- 變更: 文字顏色 --- */
        h1, h2, h3, .text-gray-800, .text-gray-900 {
            color: #0d3136;
        }
        p, span, label, .text-gray-500, .text-gray-600, .text-gray-700 {
            color: #5b6b51;
        }
        .text-primary-title {
            color: #0d3136; /* For card titles */
        }
        .text-link-title { color: #0d3136; }
        .text-link-title:hover { color: #3f7585; }

         /* --- Form input a11y & styling --- */
         .input, .select-filter { /* 變更: 統一篩選器樣式 */
             border: 1px solid #c3b4a3; /* 變更: 沙色 */
             padding: 8px 12px;
             border-radius: 8px;
             background-color: #FFFFFF;
             height: 42px; /* 統一高度 */
         }
         .input:focus, .select-filter:focus {
             outline: 2px solid transparent;
             outline-offset: 2px;
             border-color: #5b6b51; /* 變更: 森綠 */
             box-shadow: 0 0 0 2px rgba(91, 107, 81, 0.5); /* 變更: 陰影 */
         }
         .btn {
             padding: 10px 20px;
             border-radius: 8px;
             font-weight: 600;
             transition: all 0.2s;
         }
         
         /* 變更: 篩選按鈕樣式 */
         .filter-btn {
             font-weight: 700;
             padding-top: 0.5rem;
             padding-bottom: 0.5rem;
             padding-left: 1rem;
             padding-right: 1rem;
             border-radius: 0.5rem;
             transition: all 0.2s;
             width: 100%; /* Mobile first */
         }
         @media (min-width: 768px) {
             .filter-btn {
                 width: auto; /* Desktop */
             }
         }
         .filter-btn-active {
             background-color: #5b6b51; /* 變更: 森綠 */
             color: white;
             box-shadow: 0 4px 6px rgba(91, 107, 81, 0.3); /* 變更: 陰影 */
         }
         .filter-btn-inactive {
             background-color: #FFFFFF; /* 變更: 白色 */
             border: 1px solid #c3b4a3; /* 變更: 沙色邊框 */
             color: #5b6b51; /* 變更: 森綠文字 */
         }
         .filter-btn-inactive:hover {
             background-color: #f7f5f2; /* 變更: 淡淡的沙色 */
         }
         
         /* --- 變更: 新增主題色 --- */
         
         /* 讀取中 */
         .animate-spin {
             color: #5b6b51;
         }

         /* 通用按鈕 */
        .btn-primary { background-color: #3f7585; color: white; }
        .btn-primary:hover { background-color: #2a5a6a; }
        .btn-secondary { background-color: #FFFFFF; border: 1px solid #c3b4a3; color: #5b6b51; }
        .btn-secondary:hover { background-color: #f7f5f2; }
        .btn-danger { background-color: #D05A6E; color: white; }
        .btn-danger:hover { background-color: #b84a5e; }
        .btn-warning { background-color: #c3b4a3; color: #0d3136; }
        .btn-warning:hover { background-color: #a99a8a; }
        .btn-special { background-color: #3f7585; color: white; } /* for add checklist */
        .btn-special:hover { background-color: #2a5a6a; }

        /* 成員列表 */
        .job-color-1, .job-color-2, .job-color-3, .job-color-4, .job-color-5, .job-color-default {
            background-color: #f7f5f2; 
            border-left: 4px solid #c3b4a3; 
            color: #0d3136; 
        }
        .job-color-1 { border-left-color: #5b6b51; }
        .job-color-2 { border-left-color: #3f7585; }
        .job-color-4 { border-left-color: #5b6b51; }
        .job-color-5 { border-left-color: #3f7585; }

        /* 優先級 */
        .priority-high { background-color: #D05A6E; color: white; }
        .priority-medium { background-color: #c3b4a3; color: #0d3136; }
        .priority-low { background-color: #5b6b51; color: white; }

        /* 專案狀態 */
        .status-inprogress { background-color: #3f7585; color: white; }
        .status-done { background-color: #5b6b51; color: white; }
        .status-done-late { background-color: #a99a8a; color: #0d3136; }
        .status-overdue { background-color: #D05A6E; color: white; }
        .status-planning { background-color: #c3b4a3; color: #0d3136; }
        .status-paused { background-color: #a99a8a; color: #0d3136; }

        /* 個案狀態 */
        .case-status-v { background-color: #5b6b51; color: white; }
        .case-status-n { background-color: #D05A6E; color: white; }
        .case-status-a { background-color: #c3b4a3; color: #0d3136; }
        .case-status-default { background-color: #a99a8a; color: #0d3136; }

        /* 個案背景 */
        .case-bg-high { background-color: #f9ebee; } /* 胭脂紅的淡色 */
        .case-bg-medium { background-color: #f5f2ef; } /* 沙色的淡色 */
         .case-bg-default { background-color: #FFFFFF; }

        /* 門診監測邊框 */
        .monitor-border-high { border-left: 4px solid #D05A6E; }
        .monitor-border-medium { border-left: 4px solid #FC9F4D; } /* 變更: 使用者指定橘黃色 */
        .monitor-border-low { border-left: 4px solid #86C166; } /* 變更: 依照使用者要求更新色碼 */
        .monitor-border-closed { border-left: 4px solid #a99a8a; }
        .monitor-border-default { border-left: 4px solid #dcdcdc; }

        /* --- 變更: 新增日曆樣式 --- */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day-header {
            font-weight: 600;
            color: #0d3136; /* 墨黑 */
            text-align: center;
            padding: 8px 0;
            font-size: 0.875rem;
        }
        .calendar-day {
            min-height: 100px;
            padding: 4px;
            background-color: #f7f5f2; /* 淡淡的沙色 */
            border-radius: 4px;
            font-size: 0.875rem;
            color: #5b6b51; /* 森綠 */
        }
        .calendar-day-empty {
            min-height: 100px;
            background-color: transparent;
        }
        .day-content {
            padding: 8px;
            height: 100%;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .day-content:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .day-number {
            font-weight: 600;
            align-self: flex-end;
        }
        .day-clinic-count {
            font-size: 0.75rem;
        }
        /* 變更: 門診監測 "背景" 顏色 (用於日曆) */
        .monitor-bg-high { background-color: #f9ebee; color: #D05A6E; } /* 胭脂紅的淡色 */
        .monitor-bg-medium { background-color: #fff8f0; color: #FC9F4D; } /* 橘黃的淡色 */
        .monitor-bg-low { background-color: #f0f8ec; color: #86C166; } /* 草綠的淡色 */
        .monitor-bg-closed { background-color: #e8e6e3; color: #a99a8a; } /* 停診的淡色 */
        .monitor-bg-default { background-color: #FFFFFF; } /* 預設白色 */


        /* 進度條 */
        .progress-bar-inner { background-color: #3f7585; }

        /* 彈窗 */
        .checklist-item-wrapper { background-color: #f7f5f2; }
        .modal-close-btn { color: #c3b4a3; }
        .modal-close-btn:hover { color: #5b6b51; }


    </style>
</head>
<body class="p-6 md:p-10">
    
    <!-- Password Protection Screen -->
    <div id="password-screen" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-xl shadow-2xl text-center w-full max-w-sm">
            <!-- 變更: 使用者上傳的 Logo (移除固定寬度) -->
            <img src="https://i.ibb.co/xSy5QZ10/LOGO-1.png" alt="Logo" class="w-auto h-20 mx-auto mb-4">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">請輸入密碼</h1>
            <p class="text-gray-500 mb-6">請輸入密碼以存取儀表板。</p>
            <form id="password-form">
                <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 text-center" placeholder="••••••••">
                <button type="submit" class="w-full btn btn-primary py-2 px-4 shadow-md"> <!-- 變更: 使用 btn-primary -->
                    進入
                </button>
                <p id="password-error" class="text-red-500 text-sm mt-4 h-5"></p>
            </form>
        </div>
    </div>

    <div id="dashboard-container" class="hidden max-w-full mx-auto">
        <!-- 頂部標題與導航列 -->
        
        <!-- 變更: 標題下移 -->
        <!-- <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-6">成癮防治科儀表板</h1> -->

        <!-- 變更: Logo 和按鈕置中 -->
        <div class="flex flex-col items-center mb-6 gap-4">
            <!-- Logo (變更: 移至最上方) -->
            <div class="flex items-center">
                <img src="https://i.ibb.co/xSy5QZ10/LOGO-1.png" alt="奇美醫院成癮防治科 LOGO" class="w-auto h-16 shadow-lg"> <!-- 變更: 移除 rounded-full -->
            </div>
            
            <!-- 變更: 標題移至 Logo 下方 (並移除 mb-6) -->
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center">成癮防治科儀表板</h1>

            <!-- 按鈕 -->
            <div class="flex flex-wrap items-center md:flex-row gap-4">
                <div class="flex gap-2 flex-wrap justify-center"> <!-- Added flex-wrap and justify-center for better mobile stacking -->
                    <button id="welcomeBtn" data-view="welcome" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">主頁</button> <!-- 變更: 移除 tailwind bg-blue-600 -->
                    <button id="eventsBtn" data-view="events" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">團隊會議</button> <!-- 變 K: 移除 tailwind bg-gray-400 -->
                    <button id="projectsBtn" data-view="projects" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">團隊專案</button> <!-- 變更: 移除 tailwind bg-gray-400 -->
                    <button id="casesBtn" data-view="cases" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">個案補助追蹤</button> <!-- 變更: 移除 tailwind bg-gray-400 -->
                    <button id="monitoringBtn" data-view="monitoring" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">門診監測</button> <!-- 變更: 移除 tailwind bg-gray-400 -->
                </div>
            </div>
        </div>

        <!-- 主要內容區與左側邊欄 -->
        <div class="flex flex-col-reverse md:flex-row gap-6 container-fluid">
            <!-- 左側邊欄：團隊成員 -->
            <aside class="w-full md:w-80 bg-white rounded-xl shadow-lg p-6 member-container">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">團隊成員</h2>
                <div id="memberList" class="space-y-2 mb-4">
                    <div class="text-center p-8 text-gray-500">載入中...</div>
                </div>
            </aside>

            <!-- 主要內容區 -->
            <div id="mainContent" class="flex-1 bg-white rounded-xl shadow-lg p-6 flex flex-col">
                <div class="flex items-center justify-between mb-4">
                    <p id="lastUpdated" class="text-sm text-gray-500">上次更新：載入中...</p>
                    <div id="loadingIndicator" class="hidden flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-sm text-gray-500">更新中...</span>
                    </div>
                </div>
                
                <div id="pageContainer" class="flex-1 overflow-y-auto relative">
                    <div class="text-center p-8 text-gray-500">資料載入中...</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-notification" class="toast"></div>

    <!-- Modals -->
    <div id="eventModal" class="modal"><div class="modal-content"><div class="flex justify-between items-center border-b pb-2 mb-4"><h3 id="modalTitle" class="text-2xl font-bold">事件詳情</h3><button onclick="window.closeModal('eventModal')" class="modal-close-btn text-3xl font-bold">&times;</button></div><div class="space-y-2"><p><strong>事件名稱:</strong> <span id="modalEventName"></span></p><p><strong>日期:</strong> <span id="modalDate"></span></p><p><strong>開始時間:</strong> <span id="modalStartTime"></span></p><p><strong>結束時間:</strong> <span id="modalEndTime"></span></p><p><strong>主辦單位:</strong> <span id="modalOrganizer"></span></p><p><strong>聯絡人:</strong> <span id="modalContact"></span></p></div></div></div>
    <div id="caseModal" class="modal"><div class="modal-content"><div class="flex justify-between items-center border-b pb-2 mb-4"><h3 id="caseModalTitle" class="text-2xl font-bold">個案詳情</h3><button onclick="window.closeModal('caseModal')" class="modal-close-btn text-3xl font-bold">&times;</button></div><div class="space-y-2"><p><strong>個案姓名:</strong> <span id="caseModalCaseName"></span></p><p><strong>病歷號:</strong> <span id="caseModalRecordNumber"></span></p><p><strong>個管師 / 主治醫師:</strong> <span id="caseModalManagerDoctor"></span></p><hr class="my-3"><p><strong>已使用總額:</strong> <span id="caseModalTotalUsed"></span></p><p><strong>總額餘額:</strong> <span id="caseModalTotalRemaining"></span></p><hr class="my-3"><p><strong>已使用藥費:</strong> <span id="caseModalMedicationUsed"></span></p><p><strong>藥費餘額:</strong> <span id="caseModalMedicationRemaining"></span></p><p><strong>藥物種類:</strong> <span id="caseModalMedicationType"></span></p><p><strong>可再開幾粒:</strong> <span id="caseModalPillsRemaining"></span></p></div></div></div>
    <div id="addProjectModal" class="modal"><div class="modal-content modal-content-lg p-8"><div class="flex justify-between items-center border-b pb-4 mb-6"><h3 id="projectModalTitle" class="text-2xl font-bold">新增項目</h3><button onclick="window.closeModal('addProjectModal')" class="modal-close-btn text-3xl font-bold">&times;</button></div><form id="addProjectForm" class="space-y-6"><input type="hidden" id="editProjectId"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div><label for="projectName" class="block text-sm font-medium">項目名稱 (必填)</label><input type="text" id="projectName" required class="mt-1 block w-full input"></div><div><label for="projectGroup" class="block text-sm font-medium">所屬小組 (必填)</label><select id="projectGroup" required class="mt-1 block w-full input"><option>院內</option><option>酒癮計畫</option><option>監所計畫</option><option>藥癮整合計畫1</option><option>藥癮整合計畫2</option><option>美沙冬計畫</option></select></div><div><label for="projectType" class="block text-sm font-medium">類型 (必填)</label><select id="projectType" required class="mt-1 block w-full input"><option>任務</option><option>專案</option><option>研究</option><option>比賽</option></select></div></div><div><label for="projectDescription" class="block text-sm font-medium">項目備註說明</label><textarea id="projectDescription" rows="3" class="mt-1 block w-full input" placeholder="請輸入此項目的詳細說明或備註..."></textarea></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-sm font-medium">主要負責人 (可複選)</label><div id="projectLeadSelection" class="mt-1 h-32 overflow-y-auto p-2 border rounded-md bg-gray-50 space-y-2"></div></div><div><div class="flex justify-between items-center"><label class="block text-sm font-medium">協同人員 (可複選)</label><div class="flex items-center"><input type="checkbox" id="selectAllTeam" class="h-4 w-4 rounded"><label for="selectAllTeam" class="ml-2 block text-sm">全選</label></div></div><div id="projectTeamSelection" class="mt-1 h-32 overflow-y-auto p-2 border rounded-md bg-gray-50 space-y-2"></div></div></div><div><label class="block text-sm font-medium">檢查點 (Checklist)</label><div class="flex items-center gap-2 mt-1"><input type="text" id="newChecklistItemInput" placeholder="新增檢查點..." class="flex-1 block w-full input"><button type="button" id="addChecklistItemBtn" class="btn btn-special px-4 py-2">新增</button></div><div id="checklistItemContainer" class="mt-2 space-y-2 h-24 overflow-y-auto p-2 border rounded-md"></div></div><div class="grid grid-cols-1 md:grid-cols-4 gap-6"><div><label for="projectStatus" class="block text-sm font-medium">狀態 (必填)</label><select id="projectStatus" required class="mt-1 block w-full input"><option>規劃中</option><option>進行中</option><option>已完成</option><option>暫停</option><option>逾期</option></select></div><div><label for="projectPriority" class="block text-sm font-medium">優先級</label><select id="projectPriority" class="mt-1 block w-full input"><option>低</option><option>中</option><option>高</option></select></div><div><label for="startDate" class="block text-sm font-medium">開始日期 (必填)</label><input type="date" id="startDate" required class="mt-1 block w-full input"></div><div><label for="endDate" class="block text-sm font-medium">截止日期 (必填)</label><input type="date" id="endDate" required class="mt-1 block w-full input"></div></div><div class="flex justify-end gap-4 pt-4 border-t"><button type="button" onclick="window.closeModal('addProjectModal')" class="btn btn-secondary">取消</button><button type="submit" class="btn btn-primary">儲存</button></div></form></div></div>
    <div id="projectDetailModal" class="modal"><div class="modal-content modal-content-lg p-8"><div class="flex justify-between items-center border-b pb-4 mb-6"><h3 id="detailProjectName" class="text-2xl font-bold">專案詳情</h3><button onclick="window.closeModal('projectDetailModal')" class="modal-close-btn text-3xl font-bold">&times;</button></div><div id="projectDetailContent" class="space-y-4"></div><div id="detailProjectChecklist" class="mt-6 space-y-2"></div><div class="flex justify-end gap-4 pt-6 border-t mt-6"><button id="deleteProjectBtn" class="btn btn-danger" style="display: none;">刪除</button><button id="editProjectBtn" class="btn btn-warning" style="display: none;">編輯</button></div></div></div>
    <div id="deleteConfirmModal" class="modal"><div class="modal-content p-8 text-center"><h3 class="text-xl font-bold mb-4">確認刪除</h3><p class="text-gray-600 mb-6">您確定要刪除此項目嗎？<br>此操作無法復原。</p><div class="flex justify-center gap-4"><button onclick="window.closeModal('deleteConfirmModal')" class="btn btn-secondary">取消</button><button id="confirmDeleteBtn" class="btn btn-danger">確認刪除</button></div></div></div>

    <!-- NEW: Monitoring Modal -->
    <div id="addMonitoringModal" class="modal">
        <div class="modal-content modal-content-lg p-8">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 id="monitoringModalTitle" class="text-2xl font-bold">新增/編輯門診項目</h3>
                <button onclick="window.closeModal('addMonitoringModal')" class="modal-close-btn text-3xl font-bold">&times;</button>
            </div>
            <form id="addMonitoringForm" class="space-y-6">
                <input type="hidden" id="editMonitoringId">
                
                <div>
                    <label for="monitoringItemName" class="block text-sm font-medium">門診 (必填)</label>
                    <select id="monitoringItemName" required class="mt-1 block w-full input">
                        <option value="">請選擇班別...</option>
                        <!-- 變更: 移除 (週一/二 下午) 等文字 -->
                        <option value="Y798酒癮(樹林)">Y798酒癮(樹林)</option>
                        <option value="Y795藥癮(樹林)">Y795藥癮(樹林)</option>
                        <option value="779W酒癮(總院)">779W酒癮(總院)</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="monitoringDate" class="block text-sm font-medium">日期 (必填)</label>
                        <input type="date" id="monitoringDate" required class="mt-1 block w-full input">
                        <!-- 變更: 更新提示文字 -->
                        <p id="monitoringDateHint" class="text-xs text-gray-500 mt-1">請選擇門診日期。</p>
                        <p id="monitoringDateError" class="text-xs text-red-500 mt-1 hidden"></p>
                    </div>
                    <div>
                        <label for="monitoringRegisteredCount" class="block text-sm font-medium">已掛號人數</label>
                        <input type="number" id="monitoringRegisteredCount" class="mt-1 block w-full input" placeholder="0">
                    </div>
                    <div>
                        <label for="monitoringNewCases" class="block text-sm font-medium">新案</label>
                        <input type="number" id="monitoringNewCases" class="mt-1 block w-full input" placeholder="0">
                    </div>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="monitoringIsClosed" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="monitoringIsClosed" class="ml-3 block text-sm font-medium text-gray-700">此班別停診</label>
                </div>

                <div class="flex justify-end gap-4 pt-4 border-t">
                    <!-- 變更: 加上刪除按鈕 (預設隱藏) -->
                    <button type="button" id="formDeleteMonitoringBtn" class="btn btn-danger mr-auto" style="display: none;">刪除</button>
                    <button type="button" onclick="window.closeModal('addMonitoringModal')" class="btn btn-secondary">取消</button>
                    <button type="submit" class="btn btn-primary">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 變更: 新增 "門診監測日曆詳情" 彈窗 -->
    <div id="monitoringDayDetailModal" class="modal">
        <div class="modal-content modal-content-lg p-8">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 id="monitoringDayDetailTitle" class="text-2xl font-bold">門診詳情</h3>
                <button onclick="window.closeModal('monitoringDayDetailModal')" class="modal-close-btn text-3xl font-bold">&times;</button>
            </div>
            <!-- 內容將由 JS 動態填入 -->
            <div id="monitoringDayDetailContent" class="space-y-4 max-h-96 overflow-y-auto">
                <p>載入中...</p>
            </div>
        </div>
    </div>


    <script>
        // *** 變更: 已更新為您最新的部署網址 ***
        const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbzcaF7zkMYTEWiSA4RS7PfIg0a_ByNgfUrV0YxPH17op5kpMap_ZvMUqVA3lr0zgOUO/exec';
        
        let allCasesData = [], allEventsData = [], allMembersData = [], allProjectsData = [], allMonitoringData = []; // NEW: allMonitoringData
        let currentView = 'welcome';

        // --- 常數與格式化工具 ---
        const jobTitleColors = { '醫師': 'job-color-1', '臨床心理師': 'job-color-2', '個管師': 'job-color-3', '研究助理': 'job-color-4', '社工': 'job-color-5', 'default': 'job-color-default' }; /* 變更: JS 常數 */
        const priorityColors = { '高': 'priority-high', '中': 'priority-medium', '低': 'priority-low' }; /* 變更: JS 常數 */
        
        function formatCurrency(n) { return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(n); }
        
        /**
         * 將日期字串轉換為 YYYY-MM-DD 格式以供 <input type="date"> 使用
         * @param {string} dateStr - 任何可被 Date.parse 解析的日期字串 (例如 YYYY/MM/DD)
         */
        function toISODateString(dateStr) {
            if (!dateStr) return '';
            try {
                // 確保我們處理的是 T00:00:00，避免時區問題
                const date = new Date(dateStr.split('T')[0] + 'T00:00:00');
                if (isNaN(date.getTime())) return ''; // 處理無效日期
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                console.error("toISODateString 轉換失敗:", dateStr, e);
                return '';
            }
        }
        
        /**
         * 變更: 新增輔助函式，計算專案的 "實際" 狀態 (包含進度)
         * @param {object} project - 專案物件
         * @returns {{status: string, colorClass: string, progress: number, isCompleted: boolean, totalTasks: number, completedTasks: number}}
         */
        function getCalculatedProjectStatus(project) {
            // 計算進度
            let checkpoints = Array.isArray(project['檢查點']) ? project['檢查點'] : [];
            try {
                if (typeof project['檢查點'] === 'string' && project['檢查點']) {
                    checkpoints = JSON.parse(project['檢查點']);
                }
            } catch(e) { checkpoints = []; }
            
            const totalTasks = checkpoints.length;
            const completedTasks = checkpoints.filter(item => item.completed).length;
            const progress = (totalTasks > 0) ? (completedTasks / totalTasks) * 100 : 0;
            
            // 狀態邏輯
            const endDate = new Date(project['截止日期'] + 'T23:59:59'); // 包含當天
            const today = new Date();
            today.setHours(0, 0, 0, 0); // 設為今天凌晨
            
            let status = project['狀態'];
            let colorClass = 'status-inprogress';
            let isCompleted = false;
            
            if (progress === 100) {
                status = '已完成';
                colorClass = 'status-done';
                isCompleted = true;
                if (endDate < today) {
                    status = '已完成但逾期';
                    colorClass = 'status-done-late';
                }
            } else if (endDate < today) {
                status = '逾期';
                colorClass = 'status-overdue';
            } else {
                if (status === '規劃中') colorClass = 'status-planning';
                else if (status === '暫停') colorClass = 'status-paused';
                // 預設為 '進行中' (inprogress)
            }
            
            return { 
                status: status, 
                colorClass: colorClass, 
                progress: progress, 
                isCompleted: isCompleted,
                totalTasks: totalTasks,
                completedTasks: completedTasks
            };
        }

        /**
         * 變更: (輔助函式) 渲染主頁的 "未來一週門診"
         */
        function renderWelcomeMonitoring() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const sevenDaysFromNow = new Date(today);
            sevenDaysFromNow.setDate(today.getDate() + 7); // 包含今天，往後推7天
            sevenDaysFromNow.setHours(23, 59, 59, 999);

            const upcomingMonitoring = allMonitoringData
                .filter(item => {
                    if (!item['日期']) return false;
                    const itemDate = new Date(item['日期'].split('T')[0] + 'T00:00:00');
                    return itemDate >= today && itemDate <= sevenDaysFromNow;
                })
                .sort((a, b) => new Date(a['日期']) - new Date(b['日期'])); // 依日期排序

            if (upcomingMonitoring.length === 0) {
                return '<div class="col-span-full text-center p-4 text-gray-500 bg-gray-50 rounded-lg">未來一週沒有排定的門診監測項目。</div>';
            }

            return upcomingMonitoring.map(item => {
                const isClosed = item['是否停診'] === '是';
                const itemDate = formatSimpleDate(item['日期']);
                let cardBorderColor = 'monitor-border-default';
                let contentHtml = '';
                
                if (isClosed) {
                    cardBorderColor = 'monitor-border-closed';
                    contentHtml = `<p class="text-lg font-semibold text-gray-500">停診</p>`;
                } else {
                    const registered = parseInt(item['已掛號人數'] || 0, 10);
                    if (registered > 10) cardBorderColor = 'monitor-border-high';
                    else if (registered > 5) cardBorderColor = 'monitor-border-medium';
                    else cardBorderColor = 'monitor-border-low';
                    
                    contentHtml = `<p class="text-2xl font-bold text-gray-800">${registered}</p>
                                   <p class="text-sm text-gray-500">已掛號</p>`;
                }

                return `
                    <div class="bg-white ${cardBorderColor} rounded-xl shadow-lg p-4 flex items-center gap-4 cursor-pointer hover:shadow-xl" ondblclick="window.openEditMonitoringModal('${item.ID}')">
                        <div class="text-center w-16">
                            ${contentHtml}
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-600">${itemDate}</p>
                            <p class="text-sm font-medium text-gray-800">${item['門診']}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * 變更: (輔助函式) 渲染主頁的 "進行中專案"
         */
        function renderWelcomeProjects() {
            const inProgressProjects = allProjectsData
                .map(project => ({
                    project,
                    statusInfo: getCalculatedProjectStatus(project) // 使用新的輔助函式
                }))
                .filter(item => !item.statusInfo.isCompleted) // 篩選 "未完成" 的
                .sort((a, b) => new Date(a.project['截止日期']) - new Date(b.project['截止日期'])); // 依截止日期排序

            if (inProgressProjects.length === 0) {
                return '<div class="text-center p-4 text-gray-500 bg-gray-50 rounded-lg">目前沒有進行中的專案。</div>';
            }

            return inProgressProjects.map(({ project, statusInfo }) => {
                const { status, colorClass, progress } = statusInfo;
                
                return `
                    <div class="bg-white rounded-xl shadow-lg p-4 cursor-pointer border border-gray-200 hover:shadow-xl transition-shadow" onclick="window.showProjectDetails('${project.ID}')" ondblclick="window.openEditProjectModal('${project.ID}')">
                        <div class="flex flex-col md:flex-row md:items-center gap-4">
                            <!-- 專案名稱 -->
                            <div class="flex-1">
                                <p class="text-lg font-bold text-link-title">${project['專案名稱']}</p>
                                <p class="text-sm text-gray-500"><strong>負責:</strong> ${project['主要負責'] || 'N/A'}</p>
                                <p class="text-sm text-gray-500"><strong>截止:</strong> ${formatSimpleDate(project['截止日期'])}</p>
                            </div>
                            
                            <!-- 狀態 -->
                            <div class="w-full md:w-48">
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="font-semibold px-2 py-1 rounded ${colorClass}">${status}</span>
                                    <span class="text-gray-600">${progress.toFixed(0)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="progress-bar-inner h-2 rounded-full" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }


        /**
         * 載入儀表板所需的初始資料 (成員 + 專案)
         */
        async function loadInitialDashboardData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const lastUpdatedElement = document.getElementById('lastUpdated');
            loadingIndicator.classList.remove('hidden');
            lastUpdatedElement.textContent = '更新中...';
            
            try {
                // 變更: 並行獲取成員、專案和 "門診監測" 資料
                const [membersRaw, projectsRaw, monitoringRaw] = await Promise.all([
                    fetchData('團隊成員'), 
                    fetchData('團隊專案'),
                    fetchData('門診監測') // 變更: 新增
                ]);
                
                // FIX: 確保在 .filter() 之前，變數必定是陣列 (Array)，避免 fetchData 回傳 undefined 時出錯
                // *** 變更: 依照您的要求，移除 .filter() 過濾 ***
                allMembersData = (Array.isArray(membersRaw) ? membersRaw : []); // .filter(m => m['姓名']); // 過濾空行
                allProjectsData = (Array.isArray(projectsRaw) ? projectsRaw : []); // .filter(p => p['專案名稱']); // 過濾空行
                allMonitoringData = (Array.isArray(monitoringRaw) ? monitoringRaw : []); // .filter(m => m['門診'] && m['日期']); // 變更: 新增
                
                // 渲染主頁 (Welcome)
                renderWelcomePage();
                renderMembersList(allProjectsData);
                
                // 變更: 初始載入時，手動設置 'welcomeBtn' 為 active
                const welcomeBtn = document.getElementById('welcomeBtn');
                if (welcomeBtn) {
                    welcomeBtn.classList.add('active');
                }
                
                lastUpdatedElement.textContent = `上次更新：${new Date().toLocaleTimeString('zh-TW')}`;
                
            } catch (error) {
                console.error(`無法取得初始儀表板資料:`, error);
                let errorMessage = `<div class="text-center p-8 text-red-500">無法載入初始資料，請稍後再試。(${error.message})</div>`;
                // 顯示更精確的錯誤訊息
                if (error.message && error.message.includes("找不到工作表")) {
                    const sheetNameMatch = error.message.match(/找不到工作表: (.+)/);
                    const sheetName = sheetNameMatch ? sheetNameMatch[1].trim() : "未知";
                    errorMessage = `
                        <div class="text-center p-8 text-gray-700 bg-red-50 rounded-lg border border-red-200">
                            <h3 class="text-xl font-bold text-red-600 mb-3">資料載入失敗</h3>
                            <p>系統在您的 Google Sheet 試算表中，找不到一個名稱完全符合「<strong class="text-red-700">${sheetName}</strong>」的工作表分頁。</p>
                            <p class="mt-4 text-sm text-gray-600">請您開啟後端的 Google Sheet 檔案，並確認對應的工作表分頁名稱是否與上方顯示的完全一致。</p>
                        </div>
                    `;
                } else if (error.message && error.message.includes('YOUR_SPREADSHEET_ID')) {
                    errorMessage = `
                        <div class="text-center p-8 text-gray-700 bg-red-50 rounded-lg border border-red-200">
                            <h3 class="text-xl font-bold text-red-600 mb-3">後端設定錯誤</h3>
                            <p>您尚未在 Google Apps Script (Code.gs) 檔案中，將 <code class="bg-red-200 text-red-800 p-1 rounded">'YOUR_SPREADSHEET_ID'</code> 替換成您
                            <br>的 Google Sheet 試算表 ID。</p>
                            <p class="mt-4 text-sm text-gray-600">請修正您的 Apps Script 檔案，然後重新部署。</p>
                        </div>
                    `;
                }
                document.getElementById('pageContainer').innerHTML = errorMessage;
                document.getElementById('memberList').innerHTML = `<div class="text-red-500 p-4">成員列表載入失敗</div>`; // 確保成員列表也顯示錯誤
                lastUpdatedElement.textContent = '上次更新：載入失敗';
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // --- NEW: 各頁面渲染函式 ---

        /**
         * 渲染 "主頁" 內容
         */
        function renderWelcomePage() {
            document.getElementById('pageContainer').innerHTML = `
                <div class="p-4 space-y-8"> <!-- 變更: 增加 space-y -->
                    <!-- 變更: 移除 "歡迎回來" 區塊 -->
                    
                    <!-- 變更: "近期門診" 區塊 -->
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">未來一週門診</h3>
                        <div id="welcomeMonitoringList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                            ${renderWelcomeMonitoring()} <!-- 呼叫新的輔助函式 -->
                        </div>
                    </div>

                    <!-- 變更: 新增 "進行中專案" 區塊 -->
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">進行中的專案</h3>
                        <div id="welcomeProjectList" class="space-y-4">
                            ${renderWelcomeProjects()} <!-- 呼叫新的輔助函式 -->
                        </div>
                    </div>
                </div>
            `;
            // 主頁顯示時，左側的成員列表也會被渲染
        }

        /**
         * 渲染 "團隊會議" 頁面
         */
        function renderEventsPage() {
            const pageContainer = document.getElementById('pageContainer');
            let contentHtml = '';
            
            if (!allEventsData || allEventsData.length === 0) {
                contentHtml = '<div class="text-center p-8 text-gray-500">目前沒有任何會議或事件。</div>';
            } else {
                contentHtml = '<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">';
                // 依日期排序
                const sortedEvents = [...allEventsData].sort((a, b) => new Date(a['日期']) - new Date(b['日期']));
                
                sortedEvents.forEach((event) => {
                    const eventJson = JSON.stringify(event).replace(/'/g, '&#39;');
                    contentHtml += `
                        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col gap-4 cursor-pointer border border-gray-200 hover:shadow-xl transition-shadow" onclick='window.showEventDetails(${eventJson})'>
                            <h3 class="text-xl font-bold text-link-title">${event['會議'] || '未命名'}</h3> <!-- 變更: 使用 class -->
                            <div class="text-sm text-gray-700 space-y-1">
                                <!-- 變更: 使用 formatSimpleDate 格式化日期 -->
                                <p><strong>日期:</strong> ${formatSimpleDate(event['日期'])}</p>
                                <p><strong>時間:</strong> ${event['開始時間'] || 'N/A'} - ${event['結束時間'] || 'N/A'}</p>
                                <p><strong>主辦:</strong> ${event['主辦單位'] || 'N/A'}</p>
                                <p><strong>聯絡人:</strong> ${event['聯絡人'] || 'N/A'}</p>
                            </div>
                        </div>`;
                });
                contentHtml += '</div>';
            }
            pageContainer.innerHTML = contentHtml;
        }

        /**
         * 渲染 "個案補助追蹤" 頁面 (包含統計和列表)
         */
        function renderCasesPage() {
            document.getElementById('pageContainer').innerHTML = `
                <div class="flex flex-col h-full">
                    <!-- 統計數字 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-4">
                        <div class="bg-gray-100 p-4 rounded-xl shadow"><p class="text-sm text-gray-500">總個案數</p><p id="totalCases" class="text-2xl font-bold">0</p></div>
                        <div class="bg-gray-100 p-4 rounded-xl shadow"><p class="text-sm text-gray-500">總已使用金額</p><p id="totalUsed" class="text-2xl font-bold">NT$0</p></div>
                        <div class="bg-gray-100 p-4 rounded-xl shadow"><p class="text-sm text-gray-500">總剩餘金額</p><p id="totalRemaining" class="text-2xl font-bold">NT$0</p></div>
                        <div class="bg-gray-100 p-4 rounded-xl shadow"><p class="text-sm text-gray-500">平均使用率</p><p id="avgUtilization" class="text-2xl font-bold">0%</p></div>
                    </div>
                    <!-- 過濾器與搜尋 -->
                    <div class="flex flex-col md:flex-row gap-2 mb-4">
                        <input type="text" id="searchInput" class="flex-1 w-full md:w-auto input" placeholder="搜尋姓名、個管師或病歷號...">
                        <div class="flex gap-2">
                            <button id="allCasesFilterBtn" class="filter-btn filter-btn-active">全部個案</button>
                            <button id="medicationFilterBtn" class="filter-btn filter-btn-inactive">藥費 > 15k</button>
                            <button id="totalFilterBtn" class="filter-btn filter-btn-inactive">總額 > 35k</button>
                        </div>
                    </div>
                    <!-- 個案列表 -->
                    <div id="caseList" class="flex-1 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 overflow-y-auto">
                        <!-- 內容將由 renderCases 填入 -->
                    </div>
                </div>
            `;
            // 頁面渲染後，更新統計和列表
            updateCasesView();
        }

        /**
         * 變更: 渲染 "團隊專案" 頁面 (包含篩選器)
         */
        function renderProjectsPage() {
            const pageContainer = document.getElementById('pageContainer');
            
            // --- 年/月 篩選器邏輯 ---
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // 1-12
            
            const years = [...new Set(allProjectsData
                .map(item => item['截止日期'] ? new Date(item['截止日期']).getFullYear() : null)
                .filter(year => year)
            )].sort((a, b) => b - a);

            if (!years.includes(currentYear)) {
                years.unshift(currentYear);
            }
            
            const yearOptions = years.map(year => 
                `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year} 年</option>`
            ).join('');
            
            const monthOptions = Array.from({length: 12}, (_, i) => i + 1).map(month =>
                `<option value="${month}" ${month === currentMonth ? 'selected' : ''}>${month} 月</option>`
            ).join('');
            
            // --- 渲染頁面框架 ---
            pageContainer.innerHTML = `
                <div id="projectFilters" class="flex flex-col gap-4 mb-4">
                    <!-- 變更: 新增所屬小組篩選按鈕 -->
                    <div class="flex gap-2 flex-wrap">
                        <button data-filter="all" class="project-filter-btn project-group-btn filter-btn filter-btn-active">全部專案</button>
                        <button data-filter="院內" class="project-filter-btn project-group-btn filter-btn filter-btn-inactive">院內</button>
                        <button data-filter="酒癮計畫" class="project-filter-btn project-group-btn filter-btn filter-btn-inactive">酒癮</button>
                        <button data-filter="監所計畫" class="project-filter-btn project-group-btn filter-btn filter-btn-inactive">監所</button>
                        <button data-filter="美沙冬計畫" class="project-filter-btn project-group-btn filter-btn filter-btn-inactive">美沙冬</button>
                        <button data-filter="藥癮整合計畫1" class="project-filter-btn project-group-btn filter-btn filter-btn-inactive">藥合1</button>
                        <button data-filter="藥癮整合計畫2" class="project-filter-btn project-group-btn filter-btn filter-btn-inactive">藥合2</button>
                    </div>
                    <!-- 年/月 篩選 (下拉選單) -->
                    <div class="flex gap-2 ml-auto">
                        <select id="projectYearFilterSelect" class="project-filter-select select-filter">
                            <option value="all">所有年份</option>
                            ${yearOptions}
                        </select>
                        <select id="projectMonthFilterSelect" class="project-filter-select select-filter">
                            <option value="all">所有月份</option>
                            ${monthOptions}
                        </select>
                    </div>
                </div>
                
                <div id="projectList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- 內容將由 renderProjectList 填入 -->
                </div>
                <button id="addProjectItemBtn" onclick="window.openAddProjectModal()" class="fixed bottom-12 right-12 bg-blue-600 text-white w-16 h-16 rounded-full flex items-center justify-center text-4xl shadow-lg hover:bg-blue-700 transition-all">+</button>
            `;
            
            // --- 綁定事件 ---
            
            // 綁定 "所屬小組" 按鈕事件
            document.querySelectorAll('.project-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.project-group-btn').forEach(b => b.classList.replace('filter-btn-active', 'filter-btn-inactive'));
                    btn.classList.replace('filter-btn-inactive', 'filter-btn-active');
                    applyProjectFilters();
                });
            });
            
            // 綁定 "年/月" 下拉選單事件
            document.querySelectorAll('.project-filter-select').forEach(select => {
                select.addEventListener('change', applyProjectFilters);
            });
            
            // --- 初始渲染 ---
            applyProjectFilters();
        }

        /**
         * 變更: "團隊專案" 頁面的統一過濾函式
         */
        function applyProjectFilters() {
            // 1. 取得所有篩選器的值
            const groupFilter = document.querySelector('.project-group-btn.filter-btn-active').dataset.filter;
            const yearFilter = document.getElementById('projectYearFilterSelect').value;
            const monthFilter = document.getElementById('projectMonthFilterSelect').value;

            // 2. 逐步過濾資料
            let filteredData = allProjectsData;
            
            // 小組
            if (groupFilter !== 'all') {
                filteredData = filteredData.filter(item => item['所屬小組'] === groupFilter);
            }
            
            // 年份 (依 "截止日期")
            if (yearFilter !== 'all') {
                filteredData = filteredData.filter(item => {
                    if (!item['截止日期']) return false;
                    return new Date(item['截止日期']).getFullYear().toString() === yearFilter;
                });
            }
            
            // ----------------------------------------------------
            // 變更: 月份篩選邏輯
            // ----------------------------------------------------
            if (monthFilter !== 'all') {
                filteredData = filteredData.filter(item => {
                    if (!item['截止日期']) return false; // 沒有截止日期的不顯示

                    // --- 變更: 使用新的輔助函式 ---
                    const { isCompleted } = getCalculatedProjectStatus(item);
                    const isStillActive = !isCompleted;
                    
                    // --- 檢查截止日期 ---
                    // 確保使用 T00:00:00 進行比較，避免時區錯誤
                    const dueDate = new Date(item['截止日期'].split('T')[0] + 'T00:00:00'); 
                    const dueMonth = (dueDate.getMonth() + 1).toString();
                    
                    // 篩選邏輯:
                    // 1. 如果專案的截止月份 = 篩選的月份 (顯示)
                    // 2. OR 如果專案 "仍活躍" (未完成) (顯示)
                    return (dueMonth === monthFilter) || isStillActive;
                });
            }
            
            // 3. 渲染列表
            renderProjectList(filteredData);
        }

        /**
         * 變更: 渲染 "團隊專案" 卡片列表
         */
        function renderProjectList(data) {
            const listContainer = document.getElementById('projectList');
            if (!listContainer) return; // 安全檢查

            let contentHtml = '';
            
            if (!data || data.length === 0) {
                contentHtml = '<div class="col-span-full text-center p-8 text-gray-500">沒有符合條件的專案項目。</div>';
            } else {
                // 依截止日期排序
                const sortedProjects = [...data].sort((a, b) => new Date(a['截止日期']) - new Date(b['截止日期']));
                
                sortedProjects.forEach((project) => {
                    // 變更: 使用新的輔助函式取代重複的邏輯
                    const { status, colorClass, progress, totalTasks, completedTasks } = getCalculatedProjectStatus(project);
                    
                    // 狀態邏輯
                    const priorityClass = priorityColors[project['優先級']] || 'priority-medium'; /* 變更: 使用 class */
                    let cardBorder = (status === '逾期') ? 'border-2 border-red-500' : ''; // 逾期紅色外框
                    
                    // *** 🐞 Bug 修正: 將 ${statusColor} 改為 ${colorClass} ***
                    contentHtml += `
                        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col gap-4 cursor-pointer border border-gray-200 hover:shadow-xl transition-shadow ${cardBorder}" onclick="window.showProjectDetails('${project.ID}')" ondblclick="window.openEditProjectModal('${project.ID}')">
                            <div class="flex justify-between items-start gap-2">
                                <h3 class="text-xl font-bold text-link-title">${project['專案名稱'] || '未命名'}</h3> <!-- 變更: 使用 class -->
                                <span class="text-xs font-semibold px-2 py-1 rounded ${priorityClass}">${project['優先級'] || '中'}</span>
                            </div>
                            <p class="text-sm text-gray-500">${project['所屬小組']} / ${project['任務類型']}</p>
                            
                            <!-- 進度條 -->
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="progress-bar-inner h-2.5 rounded-full" style="width: ${progress}%"></div> <!-- 變更: 使用 class -->
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="font-semibold px-2 py-1 rounded ${colorClass}">${status}</span>
                                <span>${completedTasks} / ${totalTasks} 完成</span>
                            </div>
                            
                            <div class="text-sm text-gray-500 pt-4 border-t mt-auto">
                                <p><strong>負責:</strong> ${project['主要負責'] || 'N/A'}</p>
                                <!-- 變更: 使用 formatSimpleDate 格式化日期 -->
                                <p><strong>截止日期:</strong> ${formatSimpleDate(project['截止日期'])}</p>
                            </div>
                        </div>`;
                });
            }
            
            listContainer.innerHTML = contentHtml;
        }


        // --- 專案檢查點 (Checklist) 相關函式 ---

        /**
         * 在 "新增/編輯專案" 彈窗中加入一個檢查點項目
         * @param {object} item - {text: string, completed: boolean}
         */
        function addChecklistItemToForm(item = {text: '', completed: false}) {
            const input = document.getElementById('newChecklistItemInput');
            const text = (item.text || input.value).trim();
            if (text) {
                const container = document.getElementById('checklistItemContainer');
                const newItem = document.createElement('div');
                newItem.className = 'checklist-item-wrapper flex items-center justify-between bg-gray-100 p-2 rounded';
                newItem.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" class="h-4 w-4 mr-3" ${item.completed ? 'checked' : ''}>
                        <span class="checklist-item-text">${text}</span>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-700 font-bold">&times;</button>
                `;
                // 綁定刪除按鈕
                newItem.querySelector('button').addEventListener('click', () => newItem.remove());
                container.appendChild(newItem);
                if (!item.text) input.value = ''; // 如果是手動新增，清空輸入框
            }
        };

        // --- 網頁載入與事件綁定 (主程式) ---

        window.onload = () => {
            const passwordScreen = document.getElementById('password-screen');
            const dashboardContainer = document.getElementById('dashboard-container');

            /**
             * 儀表板初始化函式
             */
            function initializeDashboard() {
                passwordScreen.style.display = 'none';
                dashboardContainer.classList.remove('hidden');

                // 載入初始資料 (成員 + 專案)
                loadInitialDashboardData(); // <--- FIX: 呼叫我們新增的函式

                // 綁定頂部頁籤按鈕
                ['welcomeBtn', 'eventsBtn', 'projectsBtn', 'casesBtn', 'monitoringBtn'].forEach(id => { // NEW: Added monitoringBtn
                    const btn = document.getElementById(id);
                    if (btn) { // Add check in case button doesn't exist yet
                        btn.addEventListener('click', (e) => switchView(e.target.dataset.view));
                    }
                });

                // 綁定 "新增/編輯專案" 表單的提交事件
                document.getElementById('addProjectForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formButton = this.querySelector('button[type="submit"]');
                    formButton.disabled = true;
                    formButton.textContent = '儲存中...';

                    // 收集成員
                    const selectedLeads = Array.from(document.querySelectorAll('#projectLeadSelection input:checked')).map(cb => cb.value).join(', ');
                    const selectedTeam = Array.from(document.querySelectorAll('#projectTeamSelection input:checked')).map(cb => cb.value).join(', ');
                    
                    // 收集檢查點並轉換為 JSON 字串
                    const checklistItems = Array.from(document.querySelectorAll('#checklistItemContainer .checklist-item-wrapper')).map(itemDiv => ({
                        text: itemDiv.querySelector('.checklist-item-text').textContent,
                        completed: itemDiv.querySelector('input[type="checkbox"]').checked
                    }));

                    const projectId = document.getElementById('editProjectId').value;
                    const isEditing = !!projectId;

                    // 準備要傳送到後端的資料包
                    const projectData = {
                        'ID': isEditing ? projectId : `proj_${Date.now()}`,
                        '專案名稱': document.getElementById('projectName').value,
                        '所屬小組': document.getElementById('projectGroup').value,
                        '任務類型': document.getElementById('projectType').value,
                        '備註': document.getElementById('projectDescription').value,
                        '主要負責': selectedLeads,
                        '協同負責': selectedTeam,
                        '狀態': document.getElementById('projectStatus').value,
                        '優先級': document.getElementById('projectPriority').value,
                        '開始日期': document.getElementById('startDate').value,
                        '截止日期': document.getElementById('endDate').value,
                        '檢查點': JSON.stringify(checklists) // 儲存為 JSON 字串
                    };
                    
                    const payload = {
                        action: isEditing ? 'UPDATE_PROJECT' : 'CREATE_PROJECT',
                        sheetName: '團隊專案', // 告訴後端要操作哪個 sheet
                        data: projectData
                    };

                    try {
                        await sendDataToAppsScript(payload);
                        
                        // 操作成功，即時更新前端的資料快取
                        if (isEditing) {
                            const index = allProjectsData.findIndex(p => p.ID === projectId);
                            if (index !== -1) {
                                // 更新本地快取，注意檢查點儲存的是物件陣列，不是字串
                                allProjectsData[index] = { ...projectData, '檢查點': checklistItems }; 
                            }
                            showToast('專案已成功更新！');
                        } else {
                            // 新增到本地快取
                            allProjectsData.push({ ...projectData, '檢查點': checklistItems });
                            showToast('專案已成功新增！');
                        }
                        
                        // 變更: 重新渲染專案頁面和成員列表 (以更新專案計數)
                        applyProjectFilters(); // 呼叫篩選函式
                        renderMembersList(allProjectsData);
                        
                        closeModal('addProjectModal');
                        this.reset();
                        document.getElementById('editProjectId').value = '';

                    } catch (error) {
                        console.error('儲存專案失敗:', error);
                        showToast(`儲存專案失敗: ${error.message}`);
                    } finally {
                        formButton.disabled = false;
                        formButton.textContent = '儲存';
                    }
                });

                // NEW: 綁定 "新增/編輯門診" 表單的提交事件
                document.getElementById('addMonitoringForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formButton = this.querySelector('button[type="submit"]');
                    formButton.disabled = true;
                    formButton.textContent = '儲存中...';

                    // --- 變更: 移除日期驗證 ---
                    const dateError = document.getElementById('monitoringDateError');
                    dateError.classList.add('hidden'); // 確保錯誤訊息是隱藏的
                    
                    const monitoringId = document.getElementById('editMonitoringId').value;
                    const isEditing = !!monitoringId;
                    const today = new Date().toISOString(); // 用於上次更新時間
                    const isClosed = document.getElementById('monitoringIsClosed').checked; // NEW: Get checkbox value

                    // 準備要傳送到後端的資料包
                    const monitoringData = {
                        'ID': isEditing ? monitoringId : `mon_${Date.now()}`,
                        '日期': document.getElementById('monitoringDate').value,
                        '門診': document.getElementById('monitoringItemName').value,
                        '已掛號人數': isClosed ? '' : (document.getElementById('monitoringRegisteredCount').value || 0), // UPDATED
                        '新案': isClosed ? '' : (document.getElementById('monitoringNewCases').value || 0), // UPDATED
                        '是否停診': isClosed ? '是' : '否', // NEW
                        '上次更新時間': today 
                    };
                    
                    const payload = {
                        action: isEditing ? 'UPDATE_MONITORING_ITEM' : 'CREATE_MONITORING_ITEM',
                        sheetName: '門診監測', // 告訴後端要操作哪個 sheet
                        data: monitoringData
                    };

                    try {
                        const result = await sendDataToAppsScript(payload);
                        
                        // 操作成功，即時更新前端的資料快取
                        if (isEditing) {
                            const index = allMonitoringData.findIndex(p => p.ID === monitoringId);
                            if (index !== -1) {
                                allMonitoringData[index] = monitoringData; 
                            }
                            showToast('門診項目已成功更新！');
                        } else {
                            allMonitoringData.push(monitoringData);
                            showToast('門診項目已成功新增！');
                        }
                        
                        // 重新渲染門診頁面
                        updateMonitoringView(); 
                        
                        closeModal('addMonitoringModal');
                        this.reset();
                        document.getElementById('editMonitoringId').value = '';
                        // NEW: 手動重設停診按鈕
                        document.getElementById('monitoringIsClosed').checked = false;
                        document.getElementById('monitoringRegisteredCount').disabled = false;
                        document.getElementById('monitoringNewCases').disabled = false;

                    } catch (error) {
                        console.error('儲存門診項目失敗:', error);
                        showToast(`儲存門診項目失敗: ${error.message}`);
                    } finally {
                        formButton.disabled = false;
                        formButton.textContent = '儲存';
                    }
                });

                // NEW: "停診" 核取方塊的連動事件
                document.getElementById('monitoringIsClosed').addEventListener('change', function() {
                    const isClosed = this.checked;
                    const countInput = document.getElementById('monitoringRegisteredCount');
                    const newCaseInput = document.getElementById('monitoringNewCases');
                    
                    countInput.disabled = isClosed;
                    newCaseInput.disabled = isClosed;
                    
                    if (isClosed) {
                        countInput.value = ''; // 清空
                        newCaseInput.value = ''; // 清空
                    }
                });
                
                // 變更: 移除 "門診選擇" 的連動事件 (該事件用於更新日期提示)

                // 綁定 "新增/編輯專案" 彈窗中的其他事件
                document.getElementById('selectAllTeam').addEventListener('change', (e) => { document.querySelectorAll('#projectTeamSelection input').forEach(cb => cb.checked = e.target.checked); });
                document.getElementById('projectTeamSelection').addEventListener('change', (e) => { if (e.target.matches('input')) { document.getElementById('selectAllTeam').checked = Array.from(document.querySelectorAll('#projectTeamSelection input')).every(cb => cb.checked); } });
                document.getElementById('addChecklistItemBtn').addEventListener('click', () => addChecklistItemToForm());
                document.getElementById('newChecklistItemInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); addChecklistItemToForm(); } });
            }

            // --- 密碼驗證 ---
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                initializeDashboard();
            } else {
                passwordScreen.style.display = 'flex';
                dashboardContainer.classList.add('hidden');
            }

            document.getElementById('password-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const correctPassword = 'AUD.0507'; // 變更: 更新密碼
                const enteredPassword = document.getElementById('password-input').value;
                const errorElement = document.getElementById('password-error');

                if (enteredPassword === correctPassword) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    initializeDashboard();
                } else {
                    errorElement.textContent = '密碼錯誤，請重試。';
                    document.getElementById('password-input').value = '';
                    setTimeout(() => { errorElement.textContent = ''; }, 3000);
                }
            });
        };

        // --- 遺失的核心函式 ---
        // (在上次更新中被意外移除，現在加回來)
        
        /**
         * 格式化日期字串 (YYYY/MM/DD) 為 "MM月DD日 (週X)"
         * @param {string} dateStr - YYYY/MM/DD 或 YYYY-MM-DD 格式的日期字串
         */
        function formatSimpleDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                // 確保我們處理的是 T00:00:00，避免時區問題
                // FIX: 移除 'new' 後面的多餘引號 "
                const date = new Date(dateStr.split('T')[0] + 'T00:00:00');
                if (isNaN(date.getTime())) return '無效日期';
                
                // 取得 MM/DD
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                
                // 取得星期
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                const weekday = weekdays[date.getDay()];
                
                return `${month}/${day} (週${weekday})`;
            } catch (e) {
                console.error("formatSimpleDate 轉換失敗:", dateStr, e);
                return '日期格式錯誤';
            }
        }


        /**
         * 渲染左側 "團隊成員" 列表
         * @param {Array} projectData - 專案資料 (用於計算專案數量)
         */
        function renderMembersList(projectData) {
            const memberListContainer = document.getElementById('memberList');
            memberListContainer.innerHTML = ''; // 清空

            if (!allMembersData || allMembersData.length === 0) {
                memberListContainer.innerHTML = '<div class="text-center p-4 text-gray-500">無法載入成員。</div>';
                return;
            }
            
            // 依據 '排序' 欄位排序
            const sortedMembers = [...allMembersData].sort((a, b) => (a['排序'] || 99) - (b['排序'] || 99));

            sortedMembers.forEach(member => {
                const name = member['姓名'];
                const title = member['職稱'];
                
                // 計算專案數量
                const projectCount = projectData.filter(p => {
                    const leads = (p['主要負責'] || '').split(',').map(s => s.trim());
                    const team = (p['協同負責'] || '').split(',').map(s => s.trim());
                    return leads.includes(name) || team.includes(name);
                }).length;

                const colorClass = jobTitleColors[title] || jobTitleColors['default'];
                
                memberListContainer.innerHTML += `
                    <div class="${colorClass} p-4 rounded-lg shadow-sm"> <!-- 變更: 使用 class -->
                        <h4 class="font-bold text-lg">${name}</h4>
                        <p class="text-sm">${title}</p>
                        <p class="text-xs mt-1">(${projectCount} 個專案)</p>
                    </div>
                `;
            });
        }


        /**
         * 核心 API 呼叫函式: 從 Apps Script 取得資料
         * @param {string} sheetName - 要讀取的 Google Sheet 工作表名稱
         */
        async function fetchData(sheetName) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.remove('hidden');

            try {
                const response = await fetch(`${appsScriptUrl}?action=GET_DATA&sheetName=${encodeURIComponent(sheetName)}`);
                
                if (!response.ok) {
                    let errorMsg = `HTTP 錯誤: ${response.status} ${response.statusText}`;
                    try {
                        // 嘗試解析後端回傳的 JSON 錯誤訊息 (如果有的話)
                        const errorData = await response.json();
                        if (errorData.error) {
                            if (errorData.error.includes("找不到工作表")) {
                                errorMsg = `找不到工作表: ${sheetName}`;
                            } else if (errorData.error.includes("YOUR_SPREADSHEET_ID")) {
                                errorMsg = `後端設定錯誤: 尚未設定 SPREADSHEET_ID`;
                            } else {
                                errorMsg = errorData.error;
                            }
                        }
                    } catch (e) {
                        // 回傳的不是 JSON，使用原始 HTTP 錯誤
                    }
                    throw new Error(errorMsg);
                }

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                return result.data;

            } catch (error) {
                console.error(`fetchData 失敗 (工作表: ${sheetName}):`, error);
                // 將錯誤往上拋出，讓呼叫者 (例如 switchView) 處理
                throw error; 
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        /**
         * 核心 API 呼叫函式: 傳送資料到 Apps Script (新增/更新/刪除)
         * @param {object} payload - 要 POST 到後端的資料
         */
        async function sendDataToAppsScript(payload) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.remove('hidden');
            
            try {
                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // Apps Script doPost 接收 text/plain
                    },
                });

                if (!response.ok) {
                    throw new Error(`HTTP 錯誤: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                if (result.status === 'error') {
                    throw new Error(result.message || '後端腳本執行失敗');
                }
                
                return result; // 回傳 { status: 'success', ... }

            } catch (error) {
                console.error('sendDataToAppsScript 失敗:', error);
                throw error; // 往上拋出
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }


        /**
         * 切換主要內容視圖
         * @param {string} viewName - 視圖名稱 (例如 'welcome', 'events', 'cases')
         */
        async function switchView(viewName) {
            currentView = viewName;
            // 更新分頁按鈕樣式
            document.querySelectorAll('.tab-button').forEach(btn => {
                if (btn.dataset.view === viewName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            const pageContainer = document.getElementById('pageContainer');
            pageContainer.innerHTML = `<div class="text-center p-8 text-gray-500">資料載入中...</div>`;

            try {
                if (viewName === 'welcome') {
                    renderWelcomePage();
                    renderMembersList(allProjectsData); // 確保成員列表被渲染
                } else if (viewName === 'events') {
                    // *** 效能優化 ***
                    if (allEventsData.length === 0) {
                        const rawData = await fetchData('團隊會議');
                        // *** 變更: 依照您的要求，移除 .filter() 過濾 ***
                        allEventsData = (Array.isArray(rawData) ? rawData : []); // .filter(e => e['會議']);
                    }
                    renderEventsPage();
                } else if (viewName === 'cases') {
                    // *** 效能優化 ***
                    if (allCasesData.length === 0) {
                        const rawData = await fetchData('酒癮個案補助使用追蹤');
                        // *** 變更: 依照您的要求，移除 .filter() 過濾 ***
                        allCasesData = (Array.isArray(rawData) ? rawData : []); // .filter(c => c['個案姓名']);
                    }
                    renderCasesPage();
                } else if (viewName === 'projects') {
                    // *** 效能優化 ***
                    // 專案資料在初始載入時已取得 (allProjectsData)，通常不需要重抓
                    // 除非您需要強制刷新
                    if (allProjectsData.length === 0) { // Failsafe
                         const rawData = await fetchData('團隊專案');
                         // *** 變更: 依照您的要求，移除 .filter() 過濾 ***
                         allProjectsData = (Array.isArray(rawData) ? rawData : []); // .filter(p => p['專案名稱']);
                    }
                    renderProjectsPage(); 
                    renderMembersList(allProjectsData);
                } else if (viewName === 'monitoring') { 
                    // *** 效能優化 ***
                    // 門診資料在初始載入時已取得 (allMonitoringData)
                    if (allMonitoringData.length === 0) { // Failsafe
                        const rawData = await fetchData('門診監測');
                        // *** 變更: 依照您的要求，移除 .filter() 過濾 ***
                        allMonitoringData = (Array.isArray(rawData) ? rawData : []); // .filter(m => m['門診'] && m['日期']); 
                    }
                    updateMonitoringView(); // 呼叫新的函式
                }
            } catch (error) {
                console.error(`無法切換視圖至 ${viewName}:`, error);
                let errorMessage = `<div class="text-center p-8 text-red-500">無法載入 ${viewName} 資料。(${error.message})</div>`;
                // 顯示更精確的錯誤訊息
                if (error.message && error.message.includes("找不到工作表")) {
                    const sheetNameMatch = error.message.match(/找不到工作表: (.+)/);
                    const sheetName = sheetNameMatch ? sheetNameMatch[1].trim() : "未知";
                    errorMessage = `
                        <div class="text-center p-8 text-gray-700 bg-red-50 rounded-lg border border-red-200">
                            <h3 class="text-xl font-bold text-red-600 mb-3">資料載入失敗</h3>
                            <p>系統在您的 Google Sheet 試算表中，找不到一個名稱完全符合「<strong class="text-red-700">${sheetName}</strong>」的工作表分頁。</p>
                            <p class="mt-4 text-sm text-gray-600">請您開啟後端的 Google Sheet 檔案，並確認對應的工作表分頁名稱是否與上方顯示的完全一致。</p>
                        </div>
                    `;
                }
                pageContainer.innerHTML = errorMessage;
            }
        }
        
        // --- "個案補助追蹤" 相關函式 ---

        /**
         * 重新整理 "個案補助追蹤" 頁面的統計和列表 (用於載入和過濾)
         */
        function updateCasesView() {
            if (currentView !== 'cases') return;

            // 1. 更新統計資料
            let totalCases = allCasesData.length;
            let totalUsed = 0;
            let totalRemaining = 0;
            let totalBudget = 0; // 用於計算平均使用率

            allCasesData.forEach(item => {
                const used = parseFloat(item['已使用總額'] || 0);
                const remaining = parseFloat(item['總額度餘額'] || 0);
                totalUsed += used;
                totalRemaining += remaining;
                // 假設 總額度 = 已使用 + 餘額
                const budget = used + remaining; 
                if (budget > 0) {
                    totalBudget += budget;
                }
            });

            const avgUtilization = (totalBudget > 0) ? (totalUsed / totalBudget) * 100 : 0;
            
            document.getElementById('totalCases').textContent = totalCases;
            document.getElementById('totalUsed').textContent = formatCurrency(totalUsed);
            document.getElementById('totalRemaining').textContent = formatCurrency(totalRemaining);
            document.getElementById('avgUtilization').textContent = `${avgUtilization.toFixed(1)}%`;

            // 2. 綁定搜尋和過濾事件 (如果尚未綁定)
            const searchInput = document.getElementById('searchInput');
            if (!searchInput.dataset.listenerAttached) { // 避免重複綁定
                searchInput.addEventListener('input', (e) => filterAndRenderCases(e.target.value, currentCaseFilter));
                document.getElementById('allCasesFilterBtn').addEventListener('click', () => filterAndRenderCases(searchInput.value, 'all'));
                document.getElementById('medicationFilterBtn').addEventListener('click', () => filterAndRenderCases(searchInput.value, 'medication'));
                document.getElementById('totalFilterBtn').addEventListener('click', () => filterAndRenderCases(searchInput.value, 'total'));
                searchInput.dataset.listenerAttached = 'true';
            }

            // 3. 初始渲染 (全部資料)
            filterAndRenderCases('', 'all');
        }

        /**
         * 渲染 "個案補助追蹤" 的卡片列表
         * @param {Array} data - 要渲染的個案資料
         */
        function renderCases(data) {
            const listContainer = document.getElementById('caseList');
            listContainer.innerHTML = ''; // 清空
            
            if (!data || data.length === 0) {
                listContainer.innerHTML = '<div class="col-span-full text-center p-8 text-gray-500">沒有符合條件的個案資料。</div>';
                return;
            }

            const sorted = [...data].sort((a, b) => (b['已使用總額'] || 0) - (a['已使用總額'] || 0)); // 依已使用總額排序
            
            sorted.forEach(item => {
                const totalUsed = item['已使用總額'] || 0;
                const medicationUsed = item['已使用藥費'] || 0;
                
                let bgColor = 'case-bg-default';
                if (totalUsed > 35000) bgColor = 'case-bg-high';
                else if (medicationUsed > 15000) bgColor = 'case-bg-medium';
                
                // 狀態燈號
                const status = item['狀態'] || '';
                let statusColor = 'case-status-default';
                if (status === 'V') statusColor = 'case-status-v';
                else if (status === 'N') statusColor = 'case-status-n';
                else if (status === 'A') statusColor = 'case-status-a';
                
                const caseJson = JSON.stringify(item).replace(/'/g, '&#39;');

                listContainer.innerHTML += `
                    <div class="${bgColor} rounded-xl shadow-lg p-6 flex flex-col gap-4 cursor-pointer border border-gray-200 hover:shadow-xl transition-shadow" onclick='window.showCaseDetails(${caseJson})'>
                        <div class="flex justify-between items-start gap-2">
                            <h3 class="text-xl font-bold text-link-title">${item['個案姓名'] || '未命名'}</h3> <!-- 變更: 使用 class -->
                            <span class="text-xs font-semibold px-2 py-1 rounded ${statusColor}">${status || '?'}</span>
                        </div>
                        <p class="text-sm text-gray-500">${item['個管'] || 'N/A'} / ${item['主治醫師'] || 'N/A'}</p>
                        
                        <div class="text-sm text-gray-700 pt-4 border-t mt-auto space-y-2">
                            <div class="flex justify-between">
                                <span>已使用總額:</span>
                                <span class="font-bold">${formatCurrency(totalUsed)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>總額度餘額:</span>
                                <span class="font-bold">${formatCurrency(item['總額度餘額'] || 0)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>已使用藥費:</span>
                                <span class="font-bold">${formatCurrency(medicationUsed)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>可再開幾粒:</span>
                                <span class="font-bold">${item['可再開幾粒'] || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        // --- "門診監測" 相關函式 ---

        /**
         * 變更: 渲染 "門診監測" 頁面 (包含篩選器)
         */
        function updateMonitoringView() {
            if (currentView !== 'monitoring') return;

            const pageContainer = document.getElementById('pageContainer');
            
            // --- 年/月 篩選器邏輯 ---
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // 1-12
            
            // 從 allMonitoringData 動態產生年份選項
            const years = [...new Set(allMonitoringData
                .map(item => item['日期'] ? new Date(item['日期']).getFullYear() : null)
                .filter(year => year)
            )].sort((a, b) => b - a);

            if (!years.includes(currentYear)) {
                years.unshift(currentYear);
            }
            
            const yearOptions = years.map(year => 
                `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year} 年</option>`
            ).join('');
            
            const monthOptions = Array.from({length: 12}, (_, i) => i + 1).map(month =>
                `<option value="${month}" ${month === currentMonth ? 'selected' : ''}>${month} 月</option>`
            ).join('');
            
            // --- 渲染頁面框架 ---
            pageContainer.innerHTML = `
                <div id="monitoringFilters" class="flex flex-col md:flex-row gap-4 mb-4">
                    <!-- 變更: 新增門診篩選按鈕 -->
                    <div class="flex gap-2 flex-wrap">
                        <button data-filter="all" class="monitoring-filter-btn filter-btn filter-btn-active">全部門診</button>
                        <button data-filter="Y798" class="monitoring-filter-btn filter-btn filter-btn-inactive">Y798酒癮(樹林)</button>
                        <button data-filter="Y795" class="monitoring-filter-btn filter-btn filter-btn-inactive">Y795藥癮(樹林)</button>
                        <button data-filter="779W" class="monitoring-filter-btn filter-btn filter-btn-inactive">779W酒癮(總院)</button>
                    </div>
                    <!-- 年/月 篩選 (下拉選單) -->
                    <div class="flex gap-2 ml-auto">
                        <select id="monitoringYearFilterSelect" class="monitoring-filter-select select-filter">
                            <option value="all">所有年份</option>
                            ${yearOptions}
                        </select>
                        <select id="monitoringMonthFilterSelect" class="monitoring-filter-select select-filter">
                            <option value="all">所有月份</option>
                            ${monthOptions}
                        </select>
                    </div>
                </div>
                
                <!-- 變更: 移除舊的 #monitoringList, 改為日曆 -->
                <div id="monitoringCalendarHeader" class="calendar-grid mb-2 hidden md:grid">
                    <!-- 變更: 調整星期順序 -->
                    <div class="calendar-day-header">一</div>
                    <div class="calendar-day-header">二</div>
                    <div class="calendar-day-header">三</div>
                    <div class="calendar-day-header">四</div>
                    <div class="calendar-day-header">五</div>
                    <div class="calendar-day-header">六</div>
                    <div class="calendar-day-header">日</div>
                </div>
                <div id="monitoringCalendar" class="calendar-grid">
                    <!-- 內容將由 applyMonitoringFilters 填入 -->
                </div>
                <!-- 變更: 確保按鈕 ID 唯一 -->
                <button id="addMonitoringItemBtn" onclick="window.openAddMonitoringModal()" class="fixed bottom-12 right-12 bg-blue-600 text-white w-16 h-16 rounded-full flex items-center justify-center text-4xl shadow-lg hover:bg-blue-700 transition-all">+</button>
            `;
            
            // --- 綁定事件 ---
            
            // 綁定 "門診" 按鈕事件
            document.querySelectorAll('.monitoring-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.monitoring-filter-btn').forEach(b => b.classList.replace('filter-btn-active', 'filter-btn-inactive'));
                    btn.classList.replace('filter-btn-inactive', 'filter-btn-active');
                    applyMonitoringFilters();
                });
            });
            
            // 綁定 "年/月" 下拉選單事件
            document.querySelectorAll('.monitoring-filter-select').forEach(select => {
                select.addEventListener('change', applyMonitoringFilters);
            });
            
            // --- 初始渲染 ---
            applyMonitoringFilters();
        }

        /**
         * 變更: "門診監測" 頁面的統一過濾函式
         */
        function applyMonitoringFilters() {
            // 1. 取得所有篩選器的值
            const clinicFilter = document.querySelector('.monitoring-filter-btn.filter-btn-active').dataset.filter;
            const yearFilter = document.getElementById('monitoringYearFilterSelect').value;
            const monthFilter = document.getElementById('monitoringMonthFilterSelect').value;

            // 2. 逐步過濾資料
            let filteredData = allMonitoringData;
            
            // 門診 (僅用於 "日曆" 上的預覽)
            // 附註: 點擊詳情時，我們會顯示 "當天所有" 門診，忽略此篩選
            if (clinicFilter !== 'all') {
                // 使用 startsWith 確保 'Y798酒癮(樹林)' 能被 'Y798' 抓到
                filteredData = filteredData.filter(item => item['門診'] && item['門診'].startsWith(clinicFilter));
            }
            
            // 3. 渲染日曆
            renderMonitoringCalendar(parseInt(yearFilter, 10), parseInt(monthFilter, 10), filteredData);
        }

        /**
         * 變更: 移除 renderMonitoringList, 改為 renderMonitoringCalendar
         * @param {number} year - 完整年份 (e.g., 2025)
         * @param {number} month - 月份 (1-12)
         * @param {Array} data - "預先" 篩選過的門診資料
         */
        function renderMonitoringCalendar(year, month, data) {
            const listContainer = document.getElementById('monitoringCalendar');
            if (!listContainer) return;

            listContainer.innerHTML = '';
            
            // 變更: 調整 firstDay，讓星期一為 0, 星期日為 6
            let firstDay = new Date(year, month - 1, 1).getDay(); // 0 (Sun) - 6 (Sat)
            firstDay = (firstDay === 0) ? 6 : (firstDay - 1); // 0 (Mon) ... 6 (Sun)
            
            const daysInMonth = new Date(year, month, 0).getDate(); // 這個月總共有幾天

            // 1. 填補月份開始前的空白
            for (let i = 0; i < firstDay; i++) {
                listContainer.innerHTML += `<div class="calendar-day-empty hidden md:block"></div>`;
            }

            // 2. 填入當月所有日期
            for (let day = 1; day <= daysInMonth; day++) {
                const isoDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // 找出 "這一天" 的 "所有" 門診 (從 "預篩選" 的資料中)
                const itemsForThisDay = data.filter(item => {
                    if (!item['日期']) return false;
                    return item['日期'].startsWith(isoDate);
                });

                let bgColorClass = 'monitor-bg-default'; // 預設
                let clinicCount = itemsForThisDay.length;
                let daySummaryHtml = '';

                if (clinicCount > 0) {
                    let maxRegistered = 0;
                    let isClosed = false;

                    itemsForThisDay.forEach(item => {
                        if (item['是否停診'] === '是') {
                            isClosed = true;
                        }
                        const registered = parseInt(item['已掛號人數'] || 0, 10);
                        if (registered > maxRegistered) {
                            maxRegistered = registered;
                        }
                    });

                    if (isClosed) {
                        bgColorClass = 'monitor-bg-closed';
                        daySummaryHtml = `<span class="day-clinic-count">停診</span>`;
                    } else if (maxRegistered > 10) {
                        bgColorClass = 'monitor-bg-high';
                        daySummaryHtml = `<span class="day-clinic-count">${maxRegistered} 人</span>`;
                    } else if (maxRegistered > 5) {
                        bgColorClass = 'monitor-bg-medium';
                        daySummaryHtml = `<span class="day-clinic-count">${maxRegistered} 人</span>`;
                    } else {
                        bgColorClass = 'monitor-bg-low';
                        daySummaryHtml = `<span class="day-clinic-count">${maxRegistered} 人</span>`;
                    }
                }
                
                listContainer.innerHTML += `
                    <div class="calendar-day">
                        <div class="day-content ${bgColorClass}" onclick="window.showMonitoringDetailsForDay('${isoDate}')">
                            <span class="day-number">${day}</span>
                            ${daySummaryHtml}
                        </div>
                    </div>
                `;
            }
        }


        // --- "個案補助追蹤" 頁面的過濾函式 ---
        let currentCaseFilter = 'all'; // Keep track of the current filter
        function filterAndRenderCases(searchTerm = '', filterType = 'all') {
             currentCaseFilter = filterType; // Update current filter
             let filtered = allCasesData;
             searchTerm = searchTerm.toLowerCase();

            // 1. Filter by buttons
            // 重置所有按鈕樣式
            const medBtn = document.getElementById('medicationFilterBtn');
            const totalBtn = document.getElementById('totalFilterBtn');
            const allBtn = document.getElementById('allCasesFilterBtn');

            if (medBtn) medBtn.classList.replace('filter-btn-active', 'filter-btn-inactive');
            if (totalBtn) totalBtn.classList.replace('filter-btn-active', 'filter-btn-inactive');
            if (allBtn) allBtn.classList.replace('filter-btn-active', 'filter-btn-inactive');
            
            if (filterType === 'medication') {
                filtered = filtered.filter(item => (item['已使用藥費'] || 0) > 15000);
                if (medBtn) medBtn.classList.replace('filter-btn-inactive', 'filter-btn-active');
            } else if (filterType === 'total') {
                filtered = filtered.filter(item => (item['已使用總額'] || 0) > 35000);
                if (totalBtn) totalBtn.classList.replace('filter-btn-inactive', 'filter-btn-active');
            } else {
                // 'all' filter, do nothing
                if (allBtn) allBtn.classList.replace('filter-btn-inactive', 'filter-btn-active');
            }

            // 2. Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    (item['個案姓名']?.toLowerCase().includes(searchTerm)) || 
                    (item['個管']?.toLowerCase().includes(searchTerm)) || 
                    (String(item['病歷號'])?.toLowerCase().includes(searchTerm))
                );
            }

            // renderDashboard(filtered); // This was causing stats to change on filter
            renderCases(filtered);
        }
        
        /**
         * 顯示底部的快顯通知
         * @param {string} message - 要顯示的訊息
         */
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(function(){ toast.classList.remove('show'); }, 4000);
        }

        // --- 彈窗 (Modal) 相關的通用函式 ---

        /**
         * 關閉彈窗
         * @param {string} modalId - 彈窗的 ID
         */
        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };

        /**
         * 點擊彈窗外部遮罩時關閉彈窗
         */
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                window.closeModal(event.target.id);
            }
        };

        /**
         * 將函式掛載到 window 物件上，使其可以在 HTML 的 onclick 屬性中被呼叫
         */
        Object.assign(window, {
            /**
             * 顯示 "團隊會議" 詳情彈窗
             */
             showEventDetails: function(event) {
                document.getElementById('modalEventName').textContent = event['會議'] || 'N/A';
                // 變更: 使用 formatSimpleDate 格式化日期
                document.getElementById('modalDate').textContent = formatSimpleDate(event['日期']);
                document.getElementById('modalStartTime').textContent = event['開始時間'] || 'N/A';
                document.getElementById('modalEndTime').textContent = event['結束時間'] || 'N/A';
                document.getElementById('modalOrganizer').textContent = event['主辦單位'] || 'N/A';
                document.getElementById('modalContact').textContent = event['聯絡人'] || 'N/A';
                document.getElementById('eventModal').style.display = 'flex';
            },

            /**
             * 顯示 "個案補助追蹤" 詳情彈窗
             */
            showCaseDetails: function(caseItem) {
                document.getElementById('caseModalTitle').textContent = `個案詳細資料`;
                document.getElementById('caseModalCaseName').textContent = caseItem['個案姓名'] || 'N/A';
                document.getElementById('caseModalRecordNumber').textContent = caseItem['病歷號'] || 'N/A';
                document.getElementById('caseModalManagerDoctor').textContent = `${caseItem['個管'] || 'N/A'} / ${caseItem['主治醫師'] || 'N/A'}`;
                document.getElementById('caseModalTotalUsed').textContent = formatCurrency(caseItem['已使用總額']);
                document.getElementById('caseModalTotalRemaining').textContent = formatCurrency(caseItem['總額度餘額']); // FIX: 修正 caseImte 錯字 -> caseItem
                document.getElementById('caseModalMedicationUsed').textContent = formatCurrency(caseItem['已使用藥費']);
                document.getElementById('caseModalMedicationRemaining').textContent = formatCurrency(caseItem['藥費餘額']);
                document.getElementById('caseModalMedicationType').textContent = caseItem['藥物使用'] || 'N/A';
                document.getElementById('caseModalPillsRemaining').textContent = caseItem['可再開幾粒'] || 'N/A';
                document.getElementById('caseModal').style.display = 'flex';
            },

            /**
             * 在 "新增/編輯專案" 彈窗中填入成員選項
             * @param {string[]} leadNames - 預設選中的主要負責人
             * @param {string[]} teamNames - 預設選中的協同人員
             */
            populateMemberSelection: function(leadNames = [], teamNames = []) {
                const leadContainer = document.getElementById('projectLeadSelection');
                const teamContainer = document.getElementById('projectTeamSelection');
                leadContainer.innerHTML = ''; teamContainer.innerHTML = '';
                if (!allMembersData || allMembersData.length === 0) { leadContainer.innerHTML = teamContainer.innerHTML = '<p>無法載入成員列表。</p>'; return; }
                allMembersData.forEach(member => {
                    const name = member['姓名']?.trim(); if (!name) return;
                    const leadChecked = leadNames.includes(name) ? 'checked' : '';
                    const teamChecked = teamNames.includes(name) ? 'checked' : '';
                    leadContainer.innerHTML += `<div class="flex items-center"><input id="lead_${name}" value="${name}" type="checkbox" ${leadChecked} class="h-4 w-4"><label for="lead_${name}" class="ml-3">${name}</label></div>`;
                    teamContainer.innerHTML += `<div class="flex items-center"><input id="team_${name}" value="${name}" type="checkbox" ${teamChecked} class="h-4 w-4"><label for="team_${name}" class="ml-3">${name}</label></div>`;
                });
            },

            /**
             * 顯示 "團隊專案" 詳情彈窗
             */
            showProjectDetails: function(projectId) {
                const project = allProjectsData.find(p => p.ID === projectId); if (!project) return;
                document.getElementById('detailProjectName').textContent = project['專案名稱'];
                // 變更: 使用 formatSimpleDate 格式化日期
                document.getElementById('projectDetailContent').innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm"><p><strong>類型:</strong> ${project['任務類型']}</p><p><strong>所屬小組:</strong> ${project['所屬小組']}</p><p><strong>狀態:</strong> ${project['狀態']}</p><p><strong>優先級:</strong> ${project['優先級']}</p><p><strong>開始日期:</strong> ${formatSimpleDate(project['開始日期'])}</p><p><strong>截止日期:</strong> ${formatSimpleDate(project['截止日期'])}</p><p class="col-span-2"><strong>主要負責人:</strong> ${project['主要負責']}</p><p class="col-span-2"><strong>協同人員:</strong> ${project['協同負責']}</p><p class="col-span-2"><strong>備註:</strong> ${project['備註'] || '無'}</p></div>`;
                
                const checklistContainer = document.getElementById('detailProjectChecklist');
                checklistContainer.innerHTML = '';
                // 從本地快取讀取檢查點 (物件陣列)
                let checkpoints = Array.isArray(project['檢查點']) ? project['檢查點'] : [];

                if (checkpoints && checkpoints.length > 0) {
                     let checklistHtml = '<h4 class="text-lg font-semibold mb-2">檢查點</h4>';
                     checkpoints.forEach((item, itemIndex) => { 
                         checklistHtml += `<div class="flex items-center"><input type="checkbox" id="check_${projectId}_${itemIndex}" onchange="window.updateChecklistItemStatus('${projectId}', ${itemIndex}, this.checked)" class="h-4 w-4" ${item.completed ? 'checked' : ''}><label for="check_${projectId}_${itemIndex}" class="ml-3 ${item.completed ? 'line-through text-gray-500' : ''}">${item.text}</label></div>`; 
                     });
                    checklistContainer.innerHTML = checklistHtml;
                }
                
                // 顯示編輯和刪除按鈕
                const editBtn = document.getElementById('editProjectBtn');
                const deleteBtn = document.getElementById('deleteProjectBtn');
                editBtn.style.display = 'inline-block';
                deleteBtn.style.display = 'inline-block';
                editBtn.onclick = () => window.openEditProjectModal(projectId);
                deleteBtn.onclick = () => window.openDeleteConfirmModal(projectId, 'project'); // <--- 傳入 type

                document.getElementById('projectDetailModal').style.display = 'flex';
            },

            /**
             * 變更: 新增函式，顯示 "日曆點擊詳情" 彈窗
             * @param {string} isoDate - 'YYYY-MM-DD' 格式
             */
            showMonitoringDetailsForDay: function(isoDate) {
                const modal = document.getElementById('monitoringDayDetailModal');
                const title = document.getElementById('monitoringDayDetailTitle');
                const content = document.getElementById('monitoringDayDetailContent');
                
                const dateObj = new Date(isoDate + 'T00:00:00');
                const formattedDate = formatSimpleDate(isoDate); // e.g., "11/20 (週四)"
                title.textContent = `${formattedDate} 門診詳情`;

                // 找出 "所有" 門診資料中，符合這一天的項目
                // 故意使用 allMonitoringData (原始資料)，忽略 clinicFilter，
                // 這樣使用者點 11/20，就可以看到 Y798 和 Y795 (如果那天都有的話)
                const itemsForThisDay = allMonitoringData.filter(item => {
                    if (!item['日期']) return false;
                    return item['日期'].startsWith(isoDate);
                }).sort((a, b) => (a['門診'] || '').localeCompare(b['門診'])); // 簡單排序

                if (itemsForThisDay.length === 0) {
                    content.innerHTML = '<p class="text-gray-500">本日無（或無符合篩選的）門診資料。</p>';
                    modal.style.display = 'flex';
                    return;
                }

                //  --- 產生卡片 ---
                content.innerHTML = itemsForThisDay.map(item => {
                    const isClosed = item['是否停診'] === '是';
                    const registered = parseInt(item['已掛號人數'] || 0, 10);
                    const newCases = parseInt(item['新案'] || 0, 10);
                    let cardBorderColor = 'monitor-border-default';

                    if (isClosed) {
                        cardBorderColor = 'monitor-border-closed';
                    } else if (registered > 10) {
                        cardBorderColor = 'monitor-border-high';
                    } else if (registered > 5) {
                        cardBorderColor = 'monitor-border-medium';
                    } else {
                        cardBorderColor = 'monitor-border-low';
                    }
                    
                    return `
                        <div class="bg-white ${cardBorderColor} rounded-xl shadow-lg p-6 flex flex-col gap-4 cursor-pointer border border-gray-200 hover:shadow-xl transition-shadow" ondblclick="window.openEditMonitoringModal('${item.ID}')">
                            <div class="flex justify-between items-start gap-2">
                                <h3 class="text-xl font-bold text-link-title">${item['門診']}</h3>
                            </div>
                            
                            ${isClosed ? `
                                <div class="text-center p-4">
                                    <p class="text-2xl font-bold text-gray-500">本日停診</p>
                                </div>
                            ` : `
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div>
                                        <p class="text-3xl font-bold text-gray-800">${registered}</p>
                                        <p class="text-sm text-gray-500">已掛號人數</p>
                                    </div>
                                    <div>
                                        <p class="text-3xl font-bold text-gray-800">${newCases}</p>
                                        <p class="text-sm text-gray-500">新案</p>
                                    </div>
                                </div>
                            `}
                            
                            <div class="text-xs text-gray-400 pt-2 border-t mt-auto">
                                <p>上次更新: ${item['上次更新時間'] ? new Date(item['上次更新時間']).toLocaleString('zh-TW') : 'N/A'}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                
                modal.style.display = 'flex';
            },

            /**
             * 打開 "新增專案" 彈窗 (清空表單)
             */
            openAddProjectModal: function() {
                document.getElementById('addProjectForm').reset();
                document.getElementById('editProjectId').value = '';
                document.getElementById('projectModalTitle').textContent = '新增項目';
                document.getElementById('checklistItemContainer').innerHTML = '';
                window.populateMemberSelection();
                document.getElementById('addProjectModal').style.display = 'flex';
            },

            /**
             * 打開 "編輯專案" 彈窗 (填入現有資料)
             */
            openEditProjectModal: function(projectId) {
                const project = allProjectsData.find(p => p.ID === projectId);
                if (!project) { showToast('找不到專案資料'); return; }

                closeModal('projectDetailModal');
                const form = document.getElementById('addProjectForm');
                form.reset();

                document.getElementById('projectModalTitle').textContent = '編輯項目';
                document.getElementById('editProjectId').value = projectId;

                // 填入資料
                document.getElementById('projectName').value = project['專案名稱'] || '';
                document.getElementById('projectGroup').value = project['所屬小組'] || '院內';
                document.getElementById('projectType').value = project['任務類型'] || '任務';
                document.getElementById('projectDescription').value = project['備註'] || '';
                document.getElementById('projectStatus').value = project['狀態'] || '進行中';
                document.getElementById('projectPriority').value = project['優先級'] || '中';
                document.getElementById('startDate').value = toISODateString(project['開始日期'] || '');
                document.getElementById('endDate').value = toISODateString(project['截止日期'] || '');

                // 填入成員
                const leads = (project['主要負責'] || '').split(',').map(s => s.trim());
                const team = (project['協同負責'] || '').split(',').map(s => s.trim());
                window.populateMemberSelection(leads, team);

                // 填入檢查點
                const checklistContainer = document.getElementById('checklistItemContainer');
                checklistContainer.innerHTML = '';
                let checkpoints = Array.isArray(project['檢查點']) ? project['檢查點'] : [];
                
                if (checkpoints) {
                    checkpoints.forEach(item => addChecklistItemToForm(item));
                }

                document.getElementById('addProjectModal').style.display = 'flex';
            },

            /**
             * 變更: 執行刪除 (可重用)
             */
            openDeleteConfirmModal: function(id, type) {
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                if (type === 'project') {
                    confirmBtn.onclick = () => window.executeDeleteProject(id);
                } else if (type === 'monitoring') {
                    confirmBtn.onclick = () => window.executeDeleteMonitoringItem(id);
                }
                document.getElementById('deleteConfirmModal').style.display = 'flex';
            },
            
            // 重新命名 executeDelete 為 executeDeleteProject
            executeDeleteProject: async function(projectId) {
                closeModal('deleteConfirmModal');
                showToast('正在刪除...');
                const payload = { action: 'DELETE_PROJECT', id: projectId, sheetName: '團隊專案' };
                
                try {
                    await sendDataToAppsScript(payload);
                    // 即時更新前端快取
                    allProjectsData = allProjectsData.filter(p => p.ID !== projectId);
                    // 變更: 呼叫 applyProjectFilters
                    applyProjectFilters();
                    renderMembersList(allProjectsData);
                    closeModal('projectDetailModal');
                    showToast('專案已成功刪除！');
                } catch (error) {
                    showToast(`刪除失敗: ${error.message}`);
                }
            },

            // NEW: 執行刪除 (門診項目)
            executeDeleteMonitoringItem: async function(monitoringId) {
                closeModal('deleteConfirmModal');
                showToast('正在刪除...');
                const payload = { action: 'DELETE_MONITORING_ITEM', id: monitoringId, sheetName: '門診監測' };
                
                try {
                    await sendDataToAppsScript(payload);
                    // 即時更新前端快取
                    allMonitoringData = allMonitoringData.filter(m => m.ID !== monitoringId);
                    applyMonitoringFilters(); // 變更: 呼叫新的過濾函式
                    closeModal('addMonitoringModal'); // 關閉可能開啟的編輯視窗
                    showToast('門診項目已成功刪除！');
                } catch (error) {
                    showToast(`刪除失敗: ${error.message}`);
                }
            },

            // NEW: 打開 "新增門診" 彈窗 (清空表單)
            openAddMonitoringModal: function() {
                document.getElementById('addProjectForm').reset();
                document.getElementById('editMonitoringId').value = '';
                document.getElementById('monitoringModalTitle').textContent = '新增門診項目';
                
                // NEW: 手動重設停診按鈕
                document.getElementById('monitoringIsClosed').checked = false;
                document.getElementById('monitoringRegisteredCount').disabled = false;
                document.getElementById('monitoringNewCases').disabled = false;
                document.getElementById('monitoringDateError').classList.add('hidden');
                // 變更: 移除日期提示重設


                // 隱藏/移除可能存在的刪除按鈕
                const deleteBtn = document.getElementById('formDeleteMonitoringBtn');
                if (deleteBtn) {
                    deleteBtn.style.display = 'none';
                }

                document.getElementById('addMonitoringModal').style.display = 'flex';
            },

            // NEW: 在 "編輯門診" 彈窗中加入刪除按鈕
            openEditMonitoringModal: function(monitoringId) {
                const item = allMonitoringData.find(m => m.ID === monitoringId);
                if (!item) { showToast('找不到門診資料'); return; }

                const form = document.getElementById('addMonitoringForm');
                form.reset();

                document.getElementById('monitoringModalTitle').textContent = '編輯門診項目';
                document.getElementById('editMonitoringId').value = monitoringId;

                // 填入資料
                document.getElementById('monitoringItemName').value = item['門診'] || '';
                document.getElementById('monitoringDate').value = toISODateString(item['日期'] || '');
                document.getElementById('monitoringRegisteredCount').value = item['已掛號人數'] || 0;
                document.getElementById('monitoringNewCases').value = item['新案'] || 0;
                
                // NEW: Handle checkbox and disabled state
                const isClosed = item['是否停診'] === '是';
                const checkbox = document.getElementById('monitoringIsClosed');
                const countInput = document.getElementById('monitoringRegisteredCount');
                const newInput = document.getElementById('monitoringNewCases');
                
                checkbox.checked = isClosed;
                countInput.disabled = isClosed;
                newInput.disabled = isClosed;
                
                if (isClosed) {
                    countInput.value = '';
                    newInput.value = '';
                }
                
                document.getElementById('monitoringDateError').classList.add('hidden');

                // 變更: 移除日期提示更新

                // 檢查是否已有刪除按鈕
                let deleteBtn = document.getElementById('formDeleteMonitoringBtn');
                
                // 確保按鈕是可見的
                deleteBtn.style.display = 'inline-block';
                // 綁定刪除事件
                deleteBtn.onclick = () => window.openDeleteConfirmModal(monitoringId, 'monitoring');

                document.getElementById('addMonitoringModal').style.display = 'flex';
            },

            /**
             * 更新檢查點狀態 (在 "專案詳情" 彈窗中勾選)
             */
            updateChecklistItemStatus: async function(projectId, itemIndex, isChecked) {
                const projectIndex = allProjectsData.findIndex(p => p.ID === projectId);
                if (projectIndex === -1) return;

                let project = allProjectsData[projectIndex];
                let checkpoints = Array.isArray(project['檢查點']) ? [...project['檢查點']] : [];

                if (checkpoints[itemIndex]) {
                    // 1. 先在本地端更新
                    checkpoints[itemIndex] = { ...checkpoints[itemIndex], completed: isChecked };
                    project['檢查點'] = checkpoints; 
                    
                    const payload = {
                        action: 'UPDATE_PROJECT',
                        sheetName: '團隊專案', // 告訴後端要操作哪個 sheet
                        data: { ...project, '檢查點': JSON.stringify(checkpoints) } // 傳送 JSON 字串
                    };

                    try {
                        // 2. 傳送到後端
                        await sendDataToAppsScript(payload);
                        showToast('檢查點狀態已更新！');
                        // 3. 後端成功，正式更新本地快取 (project 物件已在上面更新)
                        allProjectsData[projectIndex] = project; 
                        // 變更: 呼叫 applyProjectFilters
                        applyProjectFilters();
                        
                        // 更新 UI 上的刪除線
                        const label = document.querySelector(`label[for='check_${projectId}_${itemIndex}']`);
                        if(label) {
                             if(isChecked) label.classList.add('line-through', 'text-gray-500');
                             else label.classList.remove('line-through', 'text-gray-500');
                        }
                    } catch (error) {
                        showToast(`更新失敗: ${error.message}`);
                        // 4. 儲存失敗，復原本地端的變更
                        checkpoints[itemIndex].completed = !isChecked;
                        project['檢查點'] = checkpoints;
                        allProjectsData[projectIndex] = project;

                        // 5. 同時復原 UI 上的勾選狀態
                        const checkbox = document.getElementById(`check_${projectId}_${itemIndex}`);
                        if (checkbox) checkbox.checked = !isChecked;
                        const label = document.querySelector(`label[for='check_${projectId}_${itemIndex}']`);
                        if(label) {
                             if(!isChecked) label.classList.add('line-through', 'text-gray-500');
                             else label.classList.remove('line-through', 'text-gray-500');
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
