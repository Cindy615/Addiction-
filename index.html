<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç™®é˜²æ²»ç§‘å„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fbfbf2;
            color: #1f2937;
        }
        .container-fluid {
            min-height: calc(100vh - 4rem);
        }
        /* Tab æŒ‰éˆ• (Active) */
        .tab-button.active {
            background-color: #5b6b51;
            color: white;
            box-shadow: 0 4px 6px rgba(91, 107, 81, 0.3);
        }
        /* Tab æŒ‰éˆ• (Inactive) */
        .tab-button {
            background-color: #c3b4a3;
            color: #0d3136;
            font-weight: 600;
        }
        .tab-button:hover {
            background-color: #a99a8a;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }
        .modal-content-lg {
            max-width: 800px;
        }
        /* iOS Style Day Modal Specifics */
        .ios-modal-content {
            background-color: #ffffff;
            border-radius: 1.5rem;
            padding: 0;
            max-width: 400px;
            width: 90%;
            height: 60vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        .ios-header {
            padding: 1.5rem;
            padding-bottom: 0.5rem;
            background-color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 10;
        }
        .ios-add-btn {
            background-color: #3f7585; /* æ£®ç¶ è‰² */
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 400;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .ios-add-btn:active {
            transform: scale(0.9);
        }
        .ios-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background-color: #fff;
        }
        .ios-empty-state {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8e8e93;
            font-size: 1rem;
        }

        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #0d3136;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        
        #password-screen, #dashboard-container { background-color: #fbfbf2; }
        aside.bg-white, #mainContent.bg-white, .modal-content, #password-screen > div { background-color: #FFFFFF; }

        .text-link-title { color: #0d3136; }
        .text-link-title:hover { color: #3f7585; }

         .input, .select-filter {
             border: 1px solid #c3b4a3;
             padding: 8px 12px;
             border-radius: 8px;
             background-color: #FFFFFF;
             height: 42px;
         }
         .input:focus, .select-filter:focus {
             outline: 2px solid transparent;
             outline-offset: 2px;
             border-color: #5b6b51;
             box-shadow: 0 0 0 2px rgba(91, 107, 81, 0.5);
         }
         .btn {
             padding: 10px 20px;
             border-radius: 8px;
             font-weight: 600;
             transition: all 0.2s;
         }
         
         .filter-btn {
             font-weight: 700;
             padding: 0.5rem 1rem;
             border-radius: 0.5rem;
             transition: all 0.2s;
         }
         .filter-btn-active {
             background-color: #5b6b51;
             color: white;
             box-shadow: 0 4px 6px rgba(91, 107, 81, 0.3);
         }
         .filter-btn-inactive {
             background-color: #FFFFFF;
             border: 1px solid #c3b4a3;
             color: #5b6b51;
         }
         .filter-btn-inactive:hover { background-color: #f7f5f2; }
         
        .btn-primary { background-color: #3f7585; color: white; }
        .btn-primary:hover { background-color: #2a5a6a; }
        .btn-secondary { background-color: #FFFFFF; border: 1px solid #c3b4a3; color: #5b6b51; }
        .btn-secondary:hover { background-color: #f7f5f2; }
        .btn-danger { background-color: #D05A6E; color: white; }
        .btn-danger:hover { background-color: #b84a5e; }
        .btn-warning { background-color: #c3b4a3; color: #0d3136; }
        .btn-warning:hover { background-color: #a99a8a; }
        .btn-special { background-color: #3f7585; color: white; }
        .btn-special:hover { background-color: #2a5a6a; }
        
        .btn-floating {
            background-color: #3f7585;
            color: white;
        }
        .btn-floating:hover {
            background-color: #2a5a6a;
        }

        /* Job Colors */
        .job-color-1, .job-color-2, .job-color-3, .job-color-4, .job-color-5, .job-color-default {
            background-color: #f7f5f2; 
            border-left: 4px solid #c3b4a3; 
            color: #0d3136; 
        }
        .job-color-1 { border-left-color: #5b6b51; } 
        .job-color-2 { border-left-color: #3f7585; } 
        .job-color-4 { border-left-color: #5b6b51; }
        .job-color-5 { border-left-color: #3f7585; }

        .priority-high { background-color: #D05A6E; color: white; }
        .priority-medium { background-color: #c3b4a3; color: #0d3136; }
        .priority-low { background-color: #5b6b51; color: white; }

        /* Project Status Colors */
        .status-inprogress { background-color: #3f7585; color: white; }
        .status-done { background-color: #5b6b51; color: white; }
        .status-done-late { background-color: #a99a8a; color: #0d3136; }
        .status-overdue { background-color: #D05A6E; color: white; }
        .status-planning { background-color: #c3b4a3; color: #0d3136; }
        .status-paused { background-color: #a99a8a; color: #0d3136; }

        .case-status-v { background-color: #5b6b51; color: white; }
        .case-status-n { background-color: #D05A6E; color: white; }
        .case-status-a { background-color: #c3b4a3; color: #0d3136; }
        .case-status-default { background-color: #a99a8a; color: #0d3136; }

        .case-bg-high { background-color: #f9ebee; }
        .case-bg-medium { background-color: #f5f2ef; }
        .case-bg-default { background-color: #FFFFFF; }

        /* Monitoring Borders */
        .monitor-border-l-level-1 { border-left-color: #22c55e; }
        .monitor-border-l-level-2 { border-left-color: #eab308; }
        .monitor-border-l-level-3 { border-left-color: #f43f5e; }
        .monitor-border-l-level-4 { border-left-color: #7f1d1d; }
        .monitor-border-l-closed { border-left-color: #9ca3af; }
        
        .badge-level-1 { background-color: #dcfce7; color: #15803d; } 
        .badge-level-2 { background-color: #fef9c3; color: #a16207; } 
        .badge-level-3 { background-color: #fee2e2; color: #b91c1c; } 
        .badge-level-4 { background-color: #7f1d1d; color: #ffffff; } 
        .badge-closed { background-color: #e5e7eb; color: #374151; } 

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day-header {
            font-weight: 600;
            color: #0d3136;
            text-align: center;
            padding: 8px 0;
            font-size: 0.875rem;
        }
        .calendar-day {
            min-height: 100px;
            padding: 4px;
            background-color: #f7f5f2;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #5b6b51;
        }
        .calendar-day-empty {
            min-height: 100px;
            background-color: transparent;
        }
        .day-content {
            padding: 8px;
            height: 100%;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background-color: #FFFFFF;
        }
        .day-content:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .day-number {
            font-weight: 600;
            align-self: flex-end;
        }
        
        /* Event Badges */
        .event-badge {
            color: white; 
            font-size: 0.75rem; 
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .event-type-activity { background-color: #7DB9DE; } 
        .event-type-meeting { background-color: #90B44B; } 
        .event-type-course { background-color: #E2943B; } 
        .event-type-supervision { background-color: #0089A7; }
        .event-type-other { background-color: #8B81C3; } 
        
        /* Monitoring Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .badge-container {
            display: flex;
            flex-wrap: wrap;
            align-content: flex-end;
        }

        .progress-bar-inner { background-color: #3f7585; }
        .checklist-item-wrapper { background-color: #f7f5f2; }
        .modal-close-btn { color: #c3b4a3; }
        .modal-close-btn:hover { color: #5b6b51; }
        
        .ios-body::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="p-6 md:p-10">
    
    <div id="connection-error-banner" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-[9999] shadow-lg">
        <div class="max-w-4xl mx-auto flex items-start">
            <svg class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div class="flex-1">
                <h3 class="font-bold text-lg">é€£ç·šç™¼ç”Ÿå•é¡Œ</h3>
                <p class="mt-1">ç³»çµ±ç„¡æ³•å¾ Google è©¦ç®—è¡¨è®€å–è³‡æ–™ã€‚</p>
                <div class="mt-3 bg-red-800 p-3 rounded text-sm">
                    <a id="debug-link" href="#" target="_blank" class="inline-block bg-white text-red-700 px-4 py-2 rounded font-bold hover:bg-gray-100 transition-colors">
                        ğŸ‘‰ é»æ­¤é–‹å•Ÿ API è¨ºæ–·é€£çµ
                    </a>
                </div>
                <button onclick="document.getElementById('connection-error-banner').classList.add('hidden')" class="mt-3 text-sm underline hover:text-red-200">é—œé–‰æç¤º</button>
            </div>
        </div>
    </div>

    <div id="password-screen" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-xl shadow-2xl text-center w-full max-w-sm">
            <img src="https://i.ibb.co/xSy5QZ10/LOGO-1.png" alt="Logo" class="w-auto h-20 mx-auto mb-4">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">è«‹è¼¸å…¥å¯†ç¢¼</h1>
            <p class="text-gray-500 mb-6">è«‹è¼¸å…¥å¯†ç¢¼ä»¥å­˜å–å„€è¡¨æ¿ã€‚</p>
            <form id="password-form">
                <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 text-center" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                <button type="submit" class="w-full btn btn-primary py-2 px-4 shadow-md">é€²å…¥</button>
                <p id="password-error" class="text-red-500 text-sm mt-4 h-5"></p>
            </form>
        </div>
    </div>

    <div id="dashboard-container" class="hidden max-w-full mx-auto">
        <div class="flex flex-col items-center mb-6 gap-4">
            <div class="flex items-center">
                <img src="https://i.ibb.co/xSy5QZ10/LOGO-1.png" alt="å¥‡ç¾é†«é™¢æˆç™®é˜²æ²»ç§‘ LOGO" class="w-auto h-16 shadow-lg">
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center">æˆç™®é˜²æ²»ç§‘å„€è¡¨æ¿</h1>

            <div class="flex flex-wrap items-center md:flex-row gap-4">
                <div class="flex gap-2 flex-wrap justify-center">
                    <button id="welcomeBtn" data-view="welcome" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">ä¸»é </button>
                    <button id="eventsBtn" data-view="events" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">åœ˜éšŠæ´»å‹•</button>
                    <button id="projectsBtn" data-view="projects" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">åœ˜éšŠå°ˆæ¡ˆ</button>
                    <button id="membersBtn" data-view="members" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">åœ˜éšŠæˆå“¡</button>
                    <button id="todosBtn" data-view="todos" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">å¾…è¾¦äº‹é …</button>
                    <button id="casesBtn" data-view="cases" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">å€‹æ¡ˆè£œåŠ©è¿½è¹¤</button>
                    <button id="monitoringBtn" data-view="monitoring" class="tab-button py-2 px-4 rounded-lg transition-all duration-200 shadow-md">é–€è¨ºç›£æ¸¬</button>
                </div>
            </div>
        </div>

        <div class="container-fluid max-w-full mx-auto">
            <div id="mainContent" class="w-full bg-white rounded-xl shadow-lg p-6 flex flex-col min-h-[calc(100vh-12rem)]">
                <div class="flex items-center justify-between mb-4">
                    <p id="lastUpdated" class="text-sm text-gray-500">ä¸Šæ¬¡æ›´æ–°ï¼šè¼‰å…¥ä¸­...</p>
                    <div id="loadingIndicator" class="hidden flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-sm text-gray-500">æ›´æ–°ä¸­...</span>
                    </div>
                </div>
                
                <div id="pageContainer" class="flex-1 overflow-y-auto relative">
                    <div class="text-center p-8 text-gray-500">è³‡æ–™è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-notification" class="toast"></div>

    <!-- Modal: æ–°å¢/ç·¨è¼¯æ´»å‹• -->
    <div id="addEventModal" class="modal">
        <div class="modal-content modal-content-lg p-8">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 id="eventModalTitle" class="text-2xl font-bold">æ–°å¢æ´»å‹•</h3>
                <button onclick="window.closeModal('addEventModal')" class="modal-close-btn text-3xl font-bold">&times;</button>
            </div>
            <form id="addEventForm" class="space-y-6">
                <input type="hidden" id="editEventId">
                <div>
                    <label for="eventName" class="block text-sm font-medium">æ´»å‹•åç¨± (å¿…å¡«)</label>
                    <input type="text" id="eventName" required class="mt-1 block w-full input">
                </div>
                <div>
                     <label for="eventType" class="block text-sm font-medium">é¡å‹ (å°‡ä»¥ä¸åŒé¡è‰²é¡¯ç¤º)</label>
                     <select id="eventType" class="mt-1 block w-full input">
                        <option value="æ´»å‹•">æ´»å‹• (è—è‰²ç³»)</option>
                        <option value="æœƒè­°">æœƒè­° (ç¶ è‰²ç³»)</option>
                        <option value="èª²ç¨‹">èª²ç¨‹ (æ©˜è‰²ç³»)</option>
                        <option value="ç£å°">ç£å° (è—ç¶ è‰²ç³»)</option>
                        <option value="å…¶ä»–">å…¶ä»– (ç´«è‰²ç³»)</option>
                     </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="eventDate" class="block text-sm font-medium">æ—¥æœŸ (å¿…å¡«)</label>
                        <input type="date" id="eventDate" required class="mt-1 block w-full input">
                    </div>
                    <div>
                        <label for="eventStartTime" class="block text-sm font-medium">é–‹å§‹æ™‚é–“</label>
                        <input type="time" id="eventStartTime" class="mt-1 block w-full input">
                    </div>
                    <div>
                        <label for="eventEndTime" class="block text-sm font-medium">çµæŸæ™‚é–“</label>
                        <input type="time" id="eventEndTime" class="mt-1 block w-full input">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="eventOrganizer" class="block text-sm font-medium">ä¸»è¾¦å–®ä½</label>
                        <select id="eventOrganizer" class="mt-1 block w-full input">
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="é™¢å…§">é™¢å…§</option>
                            <option value="é…’ç™®è¨ˆç•«">é…’ç™®è¨ˆç•«</option>
                            <option value="ç›£æ‰€è¨ˆç•«">ç›£æ‰€è¨ˆç•«</option>
                            <option value="è—¥ç™®æ•´åˆè¨ˆç•«1">è—¥ç™®æ•´åˆè¨ˆç•«1</option>
                            <option value="è—¥ç™®æ•´åˆè¨ˆç•«2">è—¥ç™®æ•´åˆè¨ˆç•«2</option>
                            <option value="ç¾æ²™å†¬è¨ˆç•«">ç¾æ²™å†¬è¨ˆç•«</option>
                        </select>
                    </div>
                    <div>
                        <label for="eventContact" class="block text-sm font-medium">è¯çµ¡äºº (å¯è¤‡é¸)</label>
                        <div id="eventContactSelection" class="mt-1 h-32 overflow-y-auto p-2 border rounded-md bg-gray-50 space-y-2">
                        </div>
                    </div>
                </div>
                <div>
                    <label for="eventNote" class="block text-sm font-medium">å‚™è¨»</label>
                    <textarea id="eventNote" rows="3" class="mt-1 block w-full input"></textarea>
                </div>
                <div class="flex justify-end gap-4 pt-4 border-t">
                    <button type="button" id="formDeleteEventBtn" class="btn btn-danger mr-auto" style="display: none;">åˆªé™¤</button>
                    <button type="button" onclick="window.closeModal('addEventModal')" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: iOS Style Day Detail -->
    <div id="eventDayDetailModal" class="modal" onclick="if(event.target === this) window.closeModal('eventDayDetailModal')">
        <div class="ios-modal-content" onclick="event.stopPropagation()">
            <div class="ios-header">
                <div>
                    <h2 class="text-2xl font-bold text-black" id="iosEventDateTitle">2026å¹´4æœˆ22æ—¥</h2>
                    <p class="text-gray-500 text-sm font-medium" id="iosEventWeekday">æ˜ŸæœŸä¸‰</p>
                </div>
                <button onclick="window.openAddEventModalWithDateFromIOS()" class="ios-add-btn">
                    +
                </button>
            </div>
            <div id="iosEventList" class="ios-body">
            </div>
        </div>
    </div>

    <!-- Modal: å°ˆæ¡ˆè©³æƒ… -->
    <div id="projectDetailModal" class="modal">
        <div class="modal-content modal-content-lg p-8">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 id="detailProjectName" class="text-2xl font-bold">å°ˆæ¡ˆè©³æƒ…</h3>
                <button onclick="window.closeModal('projectDetailModal')" class="modal-close-btn text-3xl font-bold">&times;</button>
            </div>
            <div id="detailProjectProgress" class="mb-6"></div>
            <div id="projectDetailContent" class="space-y-4"></div>
            <div id="detailProjectChecklist" class="mt-6 space-y-2"></div>
            <div class="flex justify-end gap-4 pt-6 border-t mt-6">
                <button id="deleteProjectBtn" class="btn btn-danger" style="display: none;">åˆªé™¤</button>
                <button id="editProjectBtn" class="btn btn-warning" style="display: none;">ç·¨è¼¯</button>
            </div>
        </div>
    </div>
    
    <!-- Modals: å…¶ä»–å½ˆçª— -->
    <div id="addProjectModal" class="modal"><div class="modal-content modal-content-lg p-8"><div class="flex justify-between items-center border-b pb-4 mb-6"><h3 id="projectModalTitle" class="text-2xl font-bold">æ–°å¢é …ç›®</h3><button onclick="window.closeModal('addProjectModal')" class="modal-close-btn text-3xl font-bold">&times;</button></div><form id="addProjectForm" class="space-y-6"><input type="hidden" id="editProjectId"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div><label for="projectName" class="block text-sm font-medium">é …ç›®åç¨± (å¿…å¡«)</label><input type="text" id="projectName" required class="mt-1 block w-full input"></div><div><label for="projectGroup" class="block text-sm font-medium">æ‰€å±¬å°çµ„ (å¿…å¡«)</label><select id="projectGroup" required class="mt-1 block w-full input"><option>é™¢å…§</option><option>é…’ç™®è¨ˆç•«</option><option>ç›£æ‰€è¨ˆç•«</option><option>è—¥ç™®æ•´åˆè¨ˆç•«1</option><option>è—¥ç™®æ•´åˆè¨ˆç•«2</option><option>ç¾æ²™å†¬è¨ˆç•«</option></select></div><div><label for="projectType" class="block text-sm font-medium">é¡å‹ (å¿…å¡«)</label><select id="projectType" required class="mt-1 block w-full input"><option>ä»»å‹™</option><option>å°ˆæ¡ˆ</option><option>ç ”ç©¶</option><option>æ¯”è³½</option></select></div></div><div><label for="projectDescription" class="block text-sm font-medium">é …ç›®å‚™è¨»èªªæ˜</label><textarea id="projectDescription" rows="3" class="mt-1 block w-full input" placeholder="è«‹è¼¸å…¥æ­¤é …ç›®çš„è©³ç´°èªªæ˜æˆ–å‚™è¨»..."></textarea></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-sm font-medium">ä¸»è¦è² è²¬äºº (å¯è¤‡é¸)</label><div id="projectLeadSelection" class="mt-1 h-32 overflow-y-auto p-2 border rounded-md bg-gray-50 space-y-2"></div></div><div><div class="flex justify-between items-center"><label class="block text-sm font-medium">å”åŒäººå“¡ (å¯è¤‡é¸)</label><div class="flex items-center"><input type="checkbox" id="selectAllTeam" class="h-4 w-4 rounded"><label for="selectAllTeam" class="ml-2 block text-sm">å…¨é¸</label></div></div><div id="projectTeamSelection" class="mt-1 h-32 overflow-y-auto p-2 border rounded-md bg-gray-50 space-y-2"></div></div></div><div><label class="block text-sm font-medium">æª¢æŸ¥é» (Checklist)</label><div class="flex items-center gap-2 mt-1"><input type="text" id="newChecklistItemInput" placeholder="æ–°å¢æª¢æŸ¥é»..." class="flex-1 block w-full input"><button type="button" id="addChecklistItemBtn" class="btn btn-special px-4 py-2">æ–°å¢</button></div><div id="checklistItemContainer" class="mt-2 space-y-2 h-24 overflow-y-auto p-2 border rounded-md"></div></div><div class="grid grid-cols-1 md:grid-cols-4 gap-6"><div><label for="projectStatus" class="block text-sm font-medium">ç‹€æ…‹ (å¿…å¡«)</label><select id="projectStatus" required class="mt-1 block w-full input"><option>è¦åŠƒä¸­</option><option>é€²è¡Œä¸­</option><option>å·²å®Œæˆ</option><option>æš«åœ</option><option>é€¾æœŸ</option></select></div><div><label for="projectPriority" class="block text-sm font-medium">å„ªå…ˆç´š</label><select id="projectPriority" class="mt-1 block w-full input"><option>ä½</option><option>ä¸­</option><option>é«˜</option></select></div><div><label for="startDate" class="block text-sm font-medium">é–‹å§‹æ—¥æœŸ (å¿…å¡«)</label><input type="date" id="startDate" required class="mt-1 block w-full input"></div><div><label for="endDate" class="block text-sm font-medium">æˆªæ­¢æ—¥æœŸ (å¿…å¡«)</label><input type="date" id="endDate" required class="mt-1 block w-full input"></div></div><div class="flex justify-end gap-4 pt-4 border-t"><button type="button" onclick="window.closeModal('addProjectModal')" class="btn btn-secondary">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">å„²å­˜</button></div></form></div></div>
    
    <div id="deleteConfirmModal" class="modal"><div class="modal-content p-8 text-center"><h3 class="text-xl font-bold mb-4">ç¢ºèªåˆªé™¤</h3><p class="text-gray-600 mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ<br>æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p><div class="flex justify-center gap-4"><button onclick="window.closeModal('deleteConfirmModal')" class="btn btn-secondary">å–æ¶ˆ</button><button id="confirmDeleteBtn" class="btn btn-danger">ç¢ºèªåˆªé™¤</button></div></div></div>

    <div id="addMonitoringModal" class="modal"><div class="modal-content modal-content-lg p-8"><div class="flex justify-between items-center border-b pb-4 mb-6"><h3 id="monitoringModalTitle" class="text-2xl font-bold">æ–°å¢/ç·¨è¼¯é–€è¨ºé …ç›®</h3><button onclick="window.closeModal('addMonitoringModal')" class="modal-close-btn text-3xl font-bold">&times;</button></div><form id="addMonitoringForm" class="space-y-6"><input type="hidden" id="editMonitoringId"><div><label for="monitoringItemName" class="block text-sm font-medium">é–€è¨º (å¿…å¡«)</label><select id="monitoringItemName" required class="mt-1 block w-full input"><option value="">è«‹é¸æ“‡ç­åˆ¥...</option><option value="Y798é…’ç™®(æ¨¹æ—)">Y798é…’ç™®(æ¨¹æ—)</option><option value="Y795è—¥ç™®(æ¨¹æ—)">Y795è—¥ç™®(æ¨¹æ—)</option><option value="779Wé…’ç™®(ç¸½é™¢)">779Wé…’ç™®(ç¸½é™¢)</option><option value="7790ç²¾ç¥ç§‘(ç¸½é™¢)">7790ç²¾ç¥ç§‘(ç¸½é™¢)</option><option value="7791ç²¾ç¥ç§‘(æ¨¹æ—)">7791ç²¾ç¥ç§‘(æ¨¹æ—)</option><option value="779Mç¾æ²™å†¬">779Mç¾æ²™å†¬</option></select></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div><label for="monitoringDate" class="block text-sm font-medium">æ—¥æœŸ (å¿…å¡«)</label><input type="date" id="monitoringDate" required class="mt-1 block w-full input"><p id="monitoringDateError" class="text-xs text-red-500 mt-1 hidden"></p></div><div><label for="monitoringRegisteredCount" class="block text-sm font-medium">å·²æ›è™Ÿäººæ•¸</label><input type="number" id="monitoringRegisteredCount" class="mt-1 block w-full input" placeholder="0"></div><div><label for="monitoringNewCases" class="block text-sm font-medium">æ–°æ¡ˆ</label><input type="number" id="monitoringNewCases" class="mt-1 block w-full input" placeholder="0"></div></div><div class="flex items-center"><input type="checkbox" id="monitoringIsClosed" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="monitoringIsClosed" class="ml-3 block text-sm font-medium text-gray-700">æ­¤ç­åˆ¥åœè¨º</label></div><div class="flex justify-end gap-4 pt-4 border-t"><button type="button" id="formDeleteMonitoringBtn" class="btn btn-danger mr-auto" style="display: none;">åˆªé™¤</button><button type="button" onclick="window.closeModal('addMonitoringModal')" class="btn btn-secondary">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">å„²å­˜</button></div></form></div></div>
    
    <div id="monitoringDayDetailModal" class="modal"><div class="modal-content modal-content-lg p-8"><div class="flex justify-between items-center border-b pb-4 mb-6"><h3 id="monitoringDayDetailTitle" class="text-2xl font-bold">é–€è¨ºè©³æƒ…</h3><button onclick="window.closeModal('monitoringDayDetailModal')" class="modal-close-btn text-3xl font-bold">&times;</button></div><div id="monitoringDayDetailContent" class="space-y-4 max-h-96 overflow-y-auto"><p>è¼‰å…¥ä¸­...</p></div></div></div>
    
    <div id="addTodoModal" class="modal"><div class="modal-content modal-content-lg p-8"><div class="flex justify-between items-center border-b pb-4 mb-6"><h3 id="todoModalTitle" class="text-2xl font-bold">æ–°å¢å¾…è¾¦äº‹é …</h3><button onclick="window.closeModal('addTodoModal')" class="modal-close-btn text-3xl font-bold">&times;</button></div><form id="addTodoForm" class="space-y-6"><input type="hidden" id="editTodoId"><div><label for="todoName" class="block text-sm font-medium">äº‹é …åç¨± (å¿…å¡«)</label><input type="text" id="todoName" required class="mt-1 block w-full input"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="todoStatus" class="block text-sm font-medium">ç‹€æ…‹</label><select id="todoStatus" class="mt-1 block w-full input"><option>å¾…è¾¦</option><option>é€²è¡Œä¸­</option><option>å®Œæˆ</option></select></div><div><label for="todoPriority" class="block text-sm font-medium">å„ªå…ˆç´š</label><select id="todoPriority" class="mt-1 block w-full input"><option>ä½</option><option>ä¸­</option><option>é«˜</option></select></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="todoAssigner" class="block text-sm font-medium">æŒ‡æ´¾äºº</label><select id="todoAssigner" class="mt-1 block w-full input"><option value="">è«‹é¸æ“‡...</option></select></div><div><label for="todoAssignee" class="block text-sm font-medium">è² è²¬äºº</label><select id="todoAssignee" class="mt-1 block w-full input"><option value="">è«‹é¸æ“‡...</option></select></div></div><div><label for="todoDueDate" class="block text-sm font-medium">æˆªæ­¢æ—¥æœŸ</label><input type="date" id="todoDueDate" class="mt-1 block w-full input"></div><div><label for="todoNote" class="block text-sm font-medium">å‚™è¨»</label><textarea id="todoNote" rows="3" class="mt-1 block w-full input"></textarea></div><div class="flex justify-end gap-4 pt-4 border-t"><button type="button" id="formDeleteTodoBtn" class="btn btn-danger mr-auto" style="display: none;">åˆªé™¤</button><button type="button" onclick="window.closeModal('addTodoModal')" class="btn btn-secondary">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">å„²å­˜</button></div></form></div></div>
    
    <div id="caseModal" class="modal"><div class="modal-content"><div class="flex justify-between items-center border-b pb-2 mb-4"><h3 id="caseModalTitle" class="text-2xl font-bold">å€‹æ¡ˆè©³æƒ…</h3><button onclick="window.closeModal('caseModal')" class="modal-close-btn text-3xl font-bold">&times;</button></div><div class="space-y-2"><p><strong>å€‹æ¡ˆå§“å:</strong> <span id="caseModalCaseName"></span></p><p><strong>èº«åˆ†åˆ¥:</strong> <span id="caseModalIdentity" class="px-2 py-0.5 rounded bg-indigo-100 text-indigo-800 text-sm font-bold"></span></p><p><strong>ç—…æ­·è™Ÿ:</strong> <span id="caseModalRecordNumber"></span></p><p><strong>å€‹ç®¡å¸« / ä¸»æ²»é†«å¸«:</strong> <span id="caseModalManagerDoctor"></span></p><div class="bg-gray-50 p-3 rounded-md border border-gray-200 mt-2"><p class="text-sm font-bold text-gray-700 mb-1">è¿‘æ³èªªæ˜ï¼š</p><p id="caseModalRecentStatus" class="text-sm text-gray-600 whitespace-pre-line">ç„¡</p></div><hr class="my-3"><p><strong>å·²ä½¿ç”¨ç¸½é¡:</strong> <span id="caseModalTotalUsed"></span></p><p><strong>ç¸½é¡é¤˜é¡:</strong> <span id="caseModalTotalRemaining"></span></p><hr class="my-3"><p><strong>å·²ä½¿ç”¨è—¥è²»:</strong> <span id="caseModalMedicationUsed"></span></p><p><strong>è—¥è²»é¤˜é¡:</strong> <span id="caseModalMedicationRemaining"></span></p><p><strong>è—¥ç‰©ç¨®é¡:</strong> <span id="caseModalMedicationType"></span></p><p><strong>å¯å†é–‹å¹¾ç²’:</strong> <span id="caseModalPillsRemaining"></span></p></div></div></div>

    <script>
        const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbw8KnXf6OByaQ_ZALEppaUo7K4YPceROQTcexEIcFBfPxzdVFCw9DOt_NZFYuI1924u/exec';
        
        let allCasesData = [], allEventsData = [], allMembersData = [], allProjectsData = [], allMonitoringData = [], allTodosData = [];
        let currentView = 'welcome';
        let currentIOSEventDate = '';
        window.currentCaseType = 'all';

        const jobTitleColors = { 'é†«å¸«': 'job-color-1', 'è‡¨åºŠå¿ƒç†å¸«': 'job-color-2', 'å€‹ç®¡å¸«': 'job-color-3', 'ç ”ç©¶åŠ©ç†': 'job-color-4', 'ç¤¾å·¥': 'job-color-5', 'default': 'job-color-default' };
        const priorityColors = { 'é«˜': 'priority-high', 'ä¸­': 'priority-medium', 'ä½': 'priority-low' };
        const eventTypeConfig = {
            'æ´»å‹•': { bg: 'event-type-activity', hex: '#7DB9DE' }, 
            'æœƒè­°': { bg: 'event-type-meeting', hex: '#90B44B' },  
            'èª²ç¨‹': { bg: 'event-type-course', hex: '#E2943B' },
            'ç£å°': { bg: 'event-type-supervision', hex: '#0089A7' },
            'å…¶ä»–': { bg: 'event-type-other', hex: '#8B81C3' },    
            'default': { bg: 'event-type-other', hex: '#8B81C3' } 
        };

        function formatCurrency(n) { return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(n); }
        function toISODateString(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr.split('T')[0] + 'T00:00:00');
                if (isNaN(date.getTime())) return '';
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) { console.error("toISODateString err:", dateStr, e); return ''; }
        }
        function formatSimpleDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr.split('T')[0] + 'T00:00:00');
                if (isNaN(date.getTime())) return 'ç„¡æ•ˆæ—¥æœŸ';
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                return `${month}/${day} (é€±${weekdays[date.getDay()]})`;
            } catch (e) { return 'æ—¥æœŸæ ¼å¼éŒ¯èª¤'; }
        }
        function formatLongDate(isoDateStr) {
             const date = new Date(isoDateStr + 'T00:00:00');
             return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        }
        function getWeekdayName(isoDateStr) {
            const date = new Date(isoDateStr + 'T00:00:00');
            return ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'][date.getDay()];
        }
        
        function formatTime(timeStr) {
            if (!timeStr) return '';
            const match = timeStr.match(/(\d{1,2}):(\d{2})/);
            if (match) {
                return `${match[1].padStart(2, '0')}:${match[2]}`;
            }
            return timeStr;
        }
        
        function getCalculatedProjectStatus(project) {
            let checkpoints = [];
            try { if (typeof project['æª¢æŸ¥é»'] === 'string' && project['æª¢æŸ¥é»']) checkpoints = JSON.parse(project['æª¢æŸ¥é»']); else if (Array.isArray(project['æª¢æŸ¥é»'])) checkpoints = project['æª¢æŸ¥é»']; } catch(e) {}
            const totalTasks = checkpoints.length;
            const completedTasks = checkpoints.filter(item => item.completed).length;
            const progress = (totalTasks > 0) ? (completedTasks / totalTasks) * 100 : 0;
            const endDate = new Date(project['æˆªæ­¢æ—¥æœŸ'] + 'T23:59:59');
            const today = new Date(); today.setHours(0,0,0,0);
            
            let status = project['ç‹€æ…‹'];
            let colorClass = 'status-inprogress';
            let isCompleted = false;

            if (status === 'å·²å®Œæˆ' || progress === 100) {
                isCompleted = true;
                colorClass = 'status-done';
                if (progress === 100 && status !== 'å·²å®Œæˆ') status = 'å·²å®Œæˆ';
                if (status === 'å·²å®Œæˆ' && endDate < today && progress < 100) {
                } else if (progress === 100 && endDate < today) {
                    status = 'å·²å®Œæˆä½†é€¾æœŸ';
                    colorClass = 'status-done-late';
                }
            } 
            else if (endDate < today) {
                status = 'é€¾æœŸ';
                colorClass = 'status-overdue';
            }
            else {
                if (status === 'è¦åŠƒä¸­') colorClass = 'status-planning';
                else if (status === 'æš«åœ') colorClass = 'status-paused';
            }
            
            return { status, colorClass, progress, isCompleted, totalTasks, completedTasks };
        }

        function renderWelcomePage() {
            const activeProjectsCount = allProjectsData.filter(p => {
                const s = getCalculatedProjectStatus(p);
                return !s.isCompleted;
            }).length;
            const pendingTodosCount = allTodosData.filter(t => t['ç‹€æ…‹'] !== 'å®Œæˆ').length;
            
            const today = new Date(); today.setHours(0,0,0,0);
            const nextWeek = new Date(today); nextWeek.setDate(today.getDate() + 7);
            const upcomingEventsCount = allEventsData.filter(e => {
                if (!e['æ—¥æœŸ']) return false;
                const d = new Date(e['æ—¥æœŸ'].split('T')[0] + 'T00:00:00');
                return d >= today && d <= nextWeek;
            }).length;

            document.getElementById('pageContainer').innerHTML = `
                <div class="space-y-6 pb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-xl shadow p-5 border-l-4 border-blue-500 flex items-center justify-between cursor-pointer hover:shadow-md transition-shadow" onclick="document.getElementById('projectsBtn').click()">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">é€²è¡Œä¸­çš„å°ˆæ¡ˆ</p>
                                <p class="text-3xl font-bold text-gray-800">${activeProjectsCount}</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow p-5 border-l-4 border-yellow-500 flex items-center justify-between cursor-pointer hover:shadow-md transition-shadow" onclick="document.getElementById('todosBtn').click()">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">å¾…è¾¦äº‹é …</p>
                                <p class="text-3xl font-bold text-gray-800">${pendingTodosCount}</p>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-full text-yellow-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow p-5 border-l-4 border-green-500 flex items-center justify-between cursor-pointer hover:shadow-md transition-shadow" onclick="document.getElementById('eventsBtn').click()">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">æœ¬é€±æ´»å‹•</p>
                                <p class="text-3xl font-bold text-gray-800">${upcomingEventsCount}</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full text-green-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-4">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-800 border-l-4 border-[#3f7585] pl-3">æœªä¾†ä¸€é€±é–€è¨ºç›£æ¸¬</h3>
                                <button onclick="document.getElementById('monitoringBtn').click()" class="text-sm text-blue-600 hover:underline">æŸ¥çœ‹å…¨éƒ¨</button>
                            </div>
                            <div id="welcomeMonitoringList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${renderWelcomeMonitoring()}
                            </div>
                            
                            <div class="pt-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-xl font-bold text-gray-800 border-l-4 border-[#3f7585] pl-3">é€²è¡Œä¸­çš„å°ˆæ¡ˆ</h3>
                                    <button onclick="document.getElementById('projectsBtn').click()" class="text-sm text-blue-600 hover:underline">æŸ¥çœ‹å…¨éƒ¨</button>
                                </div>
                                <div id="welcomeProjectList" class="space-y-4">
                                    ${renderWelcomeProjects()}
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="bg-white rounded-xl shadow p-4 border border-gray-100">
                                <div class="flex items-center justify-between mb-3 pb-2 border-b">
                                    <h4 class="font-bold text-gray-800">è¿‘æœŸæ´»å‹•</h4>
                                    <button onclick="window.openAddEventModal()" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-gray-600">+</button>
                                </div>
                                <div class="space-y-3 max-h-80 overflow-y-auto pr-1">
                                    ${renderWelcomeMiniEvents()}
                                </div>
                            </div>

                             <div class="bg-white rounded-xl shadow p-4 border border-gray-100">
                                <div class="flex items-center justify-between mb-3 pb-2 border-b">
                                    <h4 class="font-bold text-gray-800">ç·Šæ€¥/å¾…è¾¦äº‹é …</h4>
                                    <button onclick="window.openAddTodoModal()" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-gray-600">+</button>
                                </div>
                                <div class="space-y-2 max-h-60 overflow-y-auto pr-1">
                                     ${renderWelcomeMiniTodos()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function renderWelcomeMiniEvents() {
            const today = new Date(); today.setHours(0,0,0,0);
            const events = allEventsData.filter(e => {
                if (!e['æ—¥æœŸ']) return false;
                const d = new Date(e['æ—¥æœŸ'].split('T')[0] + 'T00:00:00');
                return d >= today;
            }).sort((a,b) => new Date(a['æ—¥æœŸ']) - new Date(b['æ—¥æœŸ'])).slice(0, 5);

            if (events.length === 0) return '<p class="text-sm text-gray-400 text-center py-4">è¿‘æœŸç„¡æ´»å‹•</p>';

            return events.map(e => {
                const d = new Date(e['æ—¥æœŸ'].split('T')[0] + 'T00:00:00');
                const isToday = d.getTime() === today.getTime();
                const type = e['é¡å‹'] || 'å…¶ä»–';
                const colorHex = eventTypeConfig[type] ? eventTypeConfig[type].hex : '#999';
                
                return `
                <div class="flex gap-3 items-start group cursor-pointer hover:bg-gray-50 p-1 rounded transition-colors" onclick='window.showEventEditFromIOS(${JSON.stringify(e).replace(/'/g, "&#39;")})'>
                    <div class="flex flex-col items-center min-w-[3rem] bg-gray-50 rounded border border-gray-100 p-1">
                        <span class="text-[10px] ${isToday ? 'text-red-500 font-bold' : 'text-gray-500'}">${d.getMonth()+1}/${d.getDate()}</span>
                        <span class="text-xs font-bold text-gray-800">${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold text-gray-800 truncate">${e['æ´»å‹•åç¨±']}</p>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="w-2 h-2 rounded-full" style="background-color: ${colorHex}"></span>
                            <span class="text-xs text-gray-500">${formatTime(e['é–‹å§‹æ™‚é–“'])}</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderWelcomeMiniTodos() {
            const urgentTodos = allTodosData.filter(t => t['ç‹€æ…‹'] !== 'å®Œæˆ')
                .sort((a,b) => {
                    const pA = a['å„ªå…ˆç´š'] === 'é«˜' ? 0 : 1;
                    const pB = b['å„ªå…ˆç´š'] === 'é«˜' ? 0 : 1;
                    if(pA !== pB) return pA - pB;
                    return new Date(a['æˆªæ­¢æ—¥æœŸ']||'9999-12-31') - new Date(b['æˆªæ­¢æ—¥æœŸ']||'9999-12-31');
                }).slice(0, 5);

            if (urgentTodos.length === 0) return '<p class="text-sm text-gray-400 text-center py-4">å¤ªæ£’äº†ï¼ç„¡å¾…è¾¦äº‹é …</p>';

            return urgentTodos.map(t => `
                <div class="flex items-start gap-2 border-b border-gray-50 last:border-0 pb-2 cursor-pointer hover:bg-gray-50 p-1 rounded" onclick="window.openEditTodoModal('${t.ID}')">
                    <div class="mt-1 h-2 w-2 rounded-full flex-shrink-0 ${t['å„ªå…ˆç´š']==='é«˜'?'bg-red-500':'bg-yellow-500'}"></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-800 truncate ${t['ç‹€æ…‹']==='å®Œæˆ'?'line-through text-gray-400':''}">${t['äº‹é …']}</p>
                        <p class="text-xs text-gray-400">${t['è² è²¬äºº'] || 'æœªæŒ‡å®š'} â€¢ ${formatSimpleDate(t['æˆªæ­¢æ—¥æœŸ'])}</p>
                    </div>
                </div>
            `).join('');
        }
        
        function renderWelcomeMonitoring() {
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const sevenDaysFromNow = new Date(today); sevenDaysFromNow.setDate(today.getDate() + 7); sevenDaysFromNow.setHours(23, 59, 59, 999);
            
            const upcoming = allMonitoringData.filter(item => {
                if (!item['æ—¥æœŸ']) return false;
                const d = new Date(item['æ—¥æœŸ'].split('T')[0] + 'T00:00:00');
                return d >= today && d <= sevenDaysFromNow;
            }).sort((a, b) => new Date(a['æ—¥æœŸ']) - new Date(b['æ—¥æœŸ']));
            
            if (upcoming.length === 0) return '<div class="col-span-full text-center p-4 text-gray-500 bg-gray-50 rounded-lg">æœªä¾†ä¸€é€±æ²’æœ‰æ’å®šçš„é–€è¨ºç›£æ¸¬é …ç›®ã€‚</div>';
            
            const groupedByDate = {};
            upcoming.forEach(item => {
                const dateStr = item['æ—¥æœŸ'].split('T')[0];
                if (!groupedByDate[dateStr]) groupedByDate[dateStr] = [];
                groupedByDate[dateStr].push(item);
            });
            
            let html = '';
            for (const [date, items] of Object.entries(groupedByDate)) {
                items.sort((a, b) => (a['é–€è¨º'] || '').localeCompare(b['é–€è¨º'] || ''));
                
                const dateObj = new Date(date + 'T00:00:00');
                const isToday = dateObj.getTime() === today.getTime();
                const cardBorder = isToday ? 'border-l-4 border-red-500 ring-2 ring-red-100' : 'border border-gray-100';
                const bgClass = isToday ? 'bg-red-50' : 'bg-white';
                
                const dateDisplay = formatSimpleDate(date);
                let listHtml = '';
                let dayTotal = 0;
                items.forEach(item => {
                    if (item['æ˜¯å¦åœè¨º'] !== 'æ˜¯') {
                        dayTotal += parseInt(item['å·²æ›è™Ÿäººæ•¸'] || 0, 10);
                    }
                });
                
                items.forEach(item => {
                    const isClosed = item['æ˜¯å¦åœè¨º'] === 'æ˜¯';
                    const reg = parseInt(item['å·²æ›è™Ÿäººæ•¸'] || 0, 10);
                    let borderClass = 'monitor-border-l-closed';
                    if (!isClosed) {
                        if (reg >= 16) borderClass = 'monitor-border-l-level-4';
                        else if (reg >= 11) borderClass = 'monitor-border-l-level-3';
                        else if (reg >= 6) borderClass = 'monitor-border-l-level-2';
                        else borderClass = 'monitor-border-l-level-1';
                    }
                    
                    const content = isClosed 
                        ? `<span class="text-gray-400 italic text-xs">åœè¨º</span>` 
                        : `<span class="font-bold text-gray-800 text-sm">${reg} äºº</span>`;
                        
                    listHtml += `
                        <div class="flex justify-between items-center p-2 rounded bg-white/60 border-l-4 ${borderClass} hover:bg-white transition-colors cursor-pointer mb-1 shadow-sm" onclick="window.openEditMonitoringModal('${item.ID}')">
                            <span class="text-sm font-medium text-gray-700 truncate mr-2">${item['é–€è¨º']}</span>
                            <div class="text-right whitespace-nowrap">${content}</div>
                        </div>
                    `;
                });
                
                html += `
                    <div class="${bgClass} ${cardBorder} rounded-xl shadow p-4 flex flex-col h-full transition-all">
                        <h4 class="font-bold text-lg text-gray-800 border-b border-gray-200/50 pb-2 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                ${isToday ? '<span class="text-red-500 mr-2 text-xs font-extrabold border border-red-500 px-1 rounded">TODAY</span>' : ''}
                                ${dateDisplay}
                            </div>
                            <span class="ml-2 bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded border border-blue-200 whitespace-nowrap">
                                ${dayTotal} äºº
                            </span>
                        </h4>
                        <div class="space-y-1 flex-1">
                            ${listHtml}
                        </div>
                    </div>
                `;
            }
            return html;
        }
        
        function renderWelcomeProjects() {
            const active = allProjectsData.map(p => ({ p, s: getCalculatedProjectStatus(p) })).filter(x => !x.s.isCompleted).sort((a, b) => new Date(a.p['æˆªæ­¢æ—¥æœŸ']) - new Date(b.p['æˆªæ­¢æ—¥æœŸ']));
            if (active.length === 0) return '<div class="text-center p-4 text-gray-500 bg-gray-50 rounded-lg">ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„å°ˆæ¡ˆã€‚</div>';
            
            return active.slice(0, 4).map(({ p, s }) => `<div class="bg-white rounded-xl shadow p-4 cursor-pointer border border-gray-200 hover:shadow-lg transition-shadow" onclick="window.showProjectDetails('${p.ID}')" ondblclick="window.openEditProjectModal('${p.ID}')"><div class="flex flex-col md:flex-row md:items-center gap-4"><div class="flex-1"><p class="text-lg font-bold text-link-title">${p['å°ˆæ¡ˆåç¨±']}</p><p class="text-sm text-gray-500"><strong>è² è²¬:</strong> ${p['ä¸»è¦è² è²¬'] || 'N/A'}</p><p class="text-sm text-gray-500"><strong>æˆªæ­¢:</strong> ${formatSimpleDate(p['æˆªæ­¢æ—¥æœŸ'])}</p></div><div class="w-full md:w-48"><div class="flex justify-between text-xs mb-1"><span class="font-semibold px-2 py-1 rounded ${s.colorClass}">${s.status}</span><span class="text-gray-600">${s.progress.toFixed(0)}%</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="progress-bar-inner h-2 rounded-full" style="width: ${s.progress}%"></div></div></div></div></div>`).join('');
        }
        
        function renderMembersPage() {
            const pageContainer = document.getElementById('pageContainer');
            
            const groupedMembers = {};
            const sortOrder = ['é†«å¸«', 'é…’ç™®è¨ˆç•«', 'ç›£æ‰€è¨ˆç•«', 'è—¥ç™®æ•´åˆè¨ˆç•«1', 'è—¥ç™®æ•´åˆè¨ˆç•«2', 'ç¾æ²™å†¬è¨ˆç•«', 'é™¢å…§', 'å…¶ä»–'];
            
            allMembersData.forEach(member => {
                let groupKey = 'å…¶ä»–';
                const title = (member['è·ç¨±'] || '').trim();
                const businessType = (member['æ¥­å‹™é¡åˆ¥'] || '').trim();

                if (title === 'é†«å¸«') {
                    groupKey = 'é†«å¸«';
                } else if (businessType) {
                    groupKey = businessType;
                } else {
                    groupKey = title || 'å…¶ä»–';
                }

                if (!groupedMembers[groupKey]) groupedMembers[groupKey] = [];
                groupedMembers[groupKey].push(member);
            });
            
            let html = `<h2 class="text-2xl font-bold text-gray-800 mb-6">åœ˜éšŠæˆå“¡åéŒ„</h2><div class="space-y-8">`;
            
            const sortedTitles = Object.keys(groupedMembers).sort((a, b) => {
                const idxA = sortOrder.indexOf(a);
                const idxB = sortOrder.indexOf(b);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                return a.localeCompare(b, 'zh-TW');
            });

            if (sortedTitles.length === 0) {
                html += `<div class="text-gray-500">ç›®å‰æ²’æœ‰æˆå“¡è³‡æ–™ã€‚</div>`;
            }
            
            sortedTitles.forEach(title => {
                const members = groupedMembers[title].sort((a, b) => (parseInt(a['æ’åº']) || 99) - (parseInt(b['æ’åº']) || 99));
                
                let colorClass = jobTitleColors[title] || 'job-color-default';
                
                if (colorClass === 'job-color-default') {
                    if (title.includes('é†«å¸«')) colorClass = 'job-color-1';
                    else if (title.includes('å¿ƒç†å¸«')) colorClass = 'job-color-2';
                    else if (title.includes('ç¤¾å·¥')) colorClass = 'job-color-5';
                    else if (title.includes('å€‹ç®¡')) colorClass = 'job-color-3';
                    else if (title.includes('é…’ç™®')) colorClass = 'job-color-2'; 
                    else if (title.includes('ç›£æ‰€')) colorClass = 'job-color-3';
                    else if (title.includes('è—¥ç™®')) colorClass = 'job-color-4';
                    else if (title.includes('ç¾æ²™å†¬')) colorClass = 'job-color-5';
                }
                
                html += `
                    <div>
                        <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4 flex items-center">
                            ${title} 
                            <span class="text-sm font-normal text-gray-500 ml-2 bg-gray-100 px-2 py-0.5 rounded-full">
                                ${members.length} äºº
                            </span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                `;
                
                members.forEach(member => {
                    const memberName = member['å§“å'] || '';
                    const activeProjects = allProjectsData.filter(p => {
                        const s = getCalculatedProjectStatus(p);
                        return !s.isCompleted && 
                        ((p['ä¸»è¦è² è²¬'] || '').includes(memberName) || 
                        (p['å”åŒè² è²¬'] || '').includes(memberName));
                    });

                    const note = member['å‚™è¨»'] || 'æš«ç„¡å‚™è¨»';
                    const jobTitle = member['è·ç¨±'] || '';
                    
                    html += `
                        <div class="bg-white rounded-xl shadow-md p-5 border-l-4 ${colorClass} hover:shadow-lg transition-all transform hover:-translate-y-1">
                            <div class="flex justify-between items-center mb-3">
                                <div>
                                    <h4 class="text-lg font-bold text-gray-900">${memberName}</h4>
                                    <p class="text-xs text-gray-500 font-medium">${jobTitle}</p>
                                </div>
                            </div>
                            
                            <div class="mb-3 min-h-[3rem]">
                                <p class="text-xs text-gray-500 font-bold mb-1.5">é€²è¡Œä¸­å°ˆæ¡ˆï¼š</p>
                                ${activeProjects.length > 0 ? 
                                    `<div class="flex flex-wrap gap-1.5">
                                        ${activeProjects.map(p => `<span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100 cursor-pointer hover:bg-blue-100 transition-colors" onclick="window.showProjectDetails('${p.ID}')" title="é»æ“ŠæŸ¥çœ‹å°ˆæ¡ˆè©³æƒ…">${p['å°ˆæ¡ˆåç¨±']}</span>`).join('')}
                                    </div>` : 
                                    `<p class="text-xs text-gray-400 italic">ç›®å‰ç„¡é€²è¡Œä¸­é …ç›®</p>`
                                }
                            </div>

                            <div class="pt-3 border-t border-gray-50">
                                <p class="text-xs text-gray-400 line-clamp-2" title="${note}">
                                    ${note === 'æš«ç„¡å‚™è¨»' ? '<span class="italic opacity-50">æš«ç„¡å‚™è¨»</span>' : note}
                                </p>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            html += `</div>`;
            pageContainer.innerHTML = html;
        }

        function renderEventsPage() {
            const pageContainer = document.getElementById('pageContainer');
            const now = new Date();
            const yearOptions = Array.from({length: 5}, (_, i) => now.getFullYear() - 2 + i).map(y => `<option value="${y}" ${y === now.getFullYear() ? 'selected' : ''}>${y} å¹´</option>`).join('');
            const monthOptions = Array.from({length: 12}, (_, i) => i + 1).map(m => `<option value="${m}" ${m === now.getMonth() + 1 ? 'selected' : ''}>${m} æœˆ</option>`).join('');

            pageContainer.innerHTML = `
                <div class="flex flex-col md:flex-row gap-4 mb-4 justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">åœ˜éšŠæ´»å‹•è¡Œäº‹æ›†</h2>
                    <div class="flex gap-2 items-center">
                        <button id="prevEventMonthBtn" class="btn btn-secondary px-3" title="ä¸Šå€‹æœˆ">&lt;</button>
                        <select id="eventYearSelect" class="select-filter">${yearOptions}</select>
                        <select id="eventMonthSelect" class="select-filter">${monthOptions}</select>
                        <button id="nextEventMonthBtn" class="btn btn-secondary px-3" title="ä¸‹å€‹æœˆ">&gt;</button>
                        <button onclick="window.openAddEventModal()" class="btn btn-primary ml-2 btn-floating">+ æ–°å¢æ´»å‹•</button>
                    </div>
                </div>
                <!-- æ¨™ç¤ºèªªæ˜ - ä½¿ç”¨æŒ‡å®šè‰²è™Ÿ -->
                <div class="flex gap-3 mb-4 text-xs text-gray-600 flex-wrap">
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-1" style="background-color: #7DB9DE;"></span> æ´»å‹•</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-1" style="background-color: #90B44B;"></span> æœƒè­°</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-1" style="background-color: #E2943B;"></span> èª²ç¨‹</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-1" style="background-color: #0089A7;"></span> ç£å°</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-1" style="background-color: #8B81C3;"></span> å…¶ä»–</div>
                </div>
                <div class="calendar-grid mb-2 hidden md:grid">
                    ${['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].map(d => `<div class="calendar-day-header">${d}</div>`).join('')}
                </div>
                <div id="eventCalendar" class="calendar-grid"></div>
            `;
            
            document.getElementById('eventYearSelect').addEventListener('change', updateEventCalendar);
            document.getElementById('eventMonthSelect').addEventListener('change', updateEventCalendar);
            document.getElementById('prevEventMonthBtn').addEventListener('click', () => changeEventMonth(-1));
            document.getElementById('nextEventMonthBtn').addEventListener('click', () => changeEventMonth(1));
            
            updateEventCalendar();
        }

        function changeEventMonth(offset) {
            const yearSel = document.getElementById('eventYearSelect');
            const monthSel = document.getElementById('eventMonthSelect');
            const d = new Date(parseInt(yearSel.value), parseInt(monthSel.value) - 1 + offset, 1);
            yearSel.value = d.getFullYear();
            monthSel.value = d.getMonth() + 1;
            updateEventCalendar();
        }

        function updateEventCalendar() {
            const year = parseInt(document.getElementById('eventYearSelect').value);
            const month = parseInt(document.getElementById('eventMonthSelect').value);
            const container = document.getElementById('eventCalendar');
            container.innerHTML = '';

            let firstDay = new Date(year, month - 1, 1).getDay();
            firstDay = (firstDay === 0) ? 6 : (firstDay - 1); 
            const daysInMonth = new Date(year, month, 0).getDate();

            for (let i = 0; i < firstDay; i++) container.innerHTML += `<div class="calendar-day-empty hidden md:block"></div>`;

            for (let day = 1; day <= daysInMonth; day++) {
                const isoDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const events = allEventsData.filter(e => e['æ—¥æœŸ'] && e['æ—¥æœŸ'].startsWith(isoDate));
                
                const badges = events.slice(0, 3).map(e => {
                    const type = e['é¡å‹'] || 'å…¶ä»–';
                    const colorClass = eventTypeConfig[type] ? eventTypeConfig[type].bg : eventTypeConfig['default'].bg;
                    // è®Šæ›´: ç§»é™¤æ™‚é–“é¡¯ç¤ºï¼Œåªä¿ç•™æ´»å‹•åç¨±
                    return `<span class="event-badge truncate ${colorClass}">${e['æ´»å‹•åç¨±']}</span>`;
                }).join('');
                
                const more = events.length > 3 ? `<span class="text-xs text-gray-500 pl-1">+${events.length - 3} æ›´å¤š</span>` : '';

                container.innerHTML += `
                    <div class="calendar-day">
                        <div class="day-content" onclick="window.showIOSDayDetail('${isoDate}')">
                            <span class="day-number">${day}</span>
                            <div class="flex flex-col w-full overflow-hidden mt-1">
                                ${badges}
                                ${more}
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        window.showIOSDayDetail = function(isoDate) {
            currentIOSEventDate = isoDate;
            document.getElementById('iosEventDateTitle').textContent = formatLongDate(isoDate);
            document.getElementById('iosEventWeekday').textContent = getWeekdayName(isoDate);
            
            const events = allEventsData.filter(e => e['æ—¥æœŸ'] && e['æ—¥æœŸ'].startsWith(isoDate)).sort((a,b) => (a['é–‹å§‹æ™‚é–“']||'').localeCompare(b['é–‹å§‹æ™‚é–“']||''));
            const listContainer = document.getElementById('iosEventList');
            if (events.length === 0) {
                listContainer.innerHTML = `<div class="ios-empty-state"><p>æ²’æœ‰é å®š</p></div>`;
            } else {
                listContainer.innerHTML = events.map(e => {
                    const eventJson = JSON.stringify(e).replace(/'/g, '&#39;');
                    const type = e['é¡å‹'] || 'å…¶ä»–';
                    const colorHex = eventTypeConfig[type] ? eventTypeConfig[type].hex : eventTypeConfig['default'].hex;
                    const startT = formatTime(e['é–‹å§‹æ™‚é–“']) || '--:--';
                    const endT = formatTime(e['çµæŸæ™‚é–“']) || '--:--';
                    
                    return `
                    <div class="mb-4 pb-4 border-b border-gray-100 last:border-0 cursor-pointer hover:bg-gray-50 p-2 rounded transition-colors flex gap-3" onclick='window.showEventEditFromIOS(${eventJson})'>
                        <div style="width: 4px; background-color: ${colorHex}; border-radius: 2px;"></div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <h4 class="font-bold text-gray-900 text-lg">${e['æ´»å‹•åç¨±']}</h4>
                                <span class="text-xs text-gray-500 px-2 py-1 bg-gray-100 rounded-full">${type}</span>
                            </div>
                            <div class="text-gray-500 text-sm flex gap-4">
                                <span>ğŸ•’ ${startT} - ${endT}</span>
                            </div>
                            ${e['ä¸»è¾¦å–®ä½'] ? `<div class="text-gray-400 text-xs mt-1">ğŸ‘¤ ${e['ä¸»è¾¦å–®ä½']}</div>` : ''}
                        </div>
                    </div>
                `}).join('');
            }
            document.getElementById('eventDayDetailModal').style.display = 'flex';
        }
        
        window.openAddEventModalWithDateFromIOS = function() {
             window.closeModal('eventDayDetailModal');
             window.openAddEventModal(currentIOSEventDate);
        }
        
        window.showEventEditFromIOS = function(eventData) {
            window.closeModal('eventDayDetailModal');
            window.openEditEventModal(eventData.ID);
        }

        function renderTodosPage() {
            const pageContainer = document.getElementById('pageContainer');
            pageContainer.innerHTML = `<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800">å¾…è¾¦äº‹é …åˆ—è¡¨</h2><div class="flex gap-2"><button onclick="window.filterTodos('all')" class="filter-btn filter-btn-active" id="filterAllTodos">å…¨éƒ¨</button><button onclick="window.filterTodos('pending')" class="filter-btn filter-btn-inactive" id="filterPendingTodos">å¾…è¾¦</button><button onclick="window.filterTodos('done')" class="filter-btn filter-btn-inactive" id="filterDoneTodos">å®Œæˆ</button></div></div><div id="todoList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div><button onclick="window.openAddTodoModal()" class="fixed bottom-12 right-12 w-16 h-16 rounded-full flex items-center justify-center text-4xl shadow-lg transition-all btn-floating">+</button>`;
            window.filterTodos('all');
        }
        window.filterTodos = function(filter) {
            document.getElementById('filterAllTodos').className = filter === 'all' ? 'filter-btn filter-btn-active' : 'filter-btn filter-btn-inactive';
            document.getElementById('filterPendingTodos').className = filter === 'pending' ? 'filter-btn filter-btn-active' : 'filter-btn filter-btn-inactive';
            document.getElementById('filterDoneTodos').className = filter === 'done' ? 'filter-btn filter-btn-active' : 'filter-btn filter-btn-inactive';
            let data = allTodosData;
            if (filter === 'pending') data = allTodosData.filter(t => t['ç‹€æ…‹'] !== 'å®Œæˆ');
            else if (filter === 'done') data = allTodosData.filter(t => t['ç‹€æ…‹'] === 'å®Œæˆ');
            const list = document.getElementById('todoList');
            if (data.length === 0) list.innerHTML = '<div class="col-span-full text-center p-8 text-gray-500">ç›®å‰æ²’æœ‰å¾…è¾¦äº‹é …ã€‚</div>';
            else list.innerHTML = data.sort((a,b) => (a['ç‹€æ…‹']===b['ç‹€æ…‹'] ? new Date(a['æˆªæ­¢æ—¥æœŸ']||'9999')-new Date(b['æˆªæ­¢æ—¥æœŸ']||'9999') : (a['ç‹€æ…‹']==='å®Œæˆ'?1:-1))).map(t => {
                const isDone = t['ç‹€æ…‹'] === 'å®Œæˆ';
                return `<div class="bg-white rounded-xl shadow p-4 border-l-4 ${isDone?'border-green-500':'border-yellow-500'} cursor-pointer hover:shadow-lg" onclick="window.openEditTodoModal('${t.ID}')"><div class="flex justify-between items-start mb-2"><h3 class="font-bold text-lg ${isDone?'line-through text-gray-500':'text-gray-800'}">${t['äº‹é …']}</h3><span class="text-xs px-2 py-1 rounded ${priorityColors[t['å„ªå…ˆç´š']]||'priority-medium'}">${t['å„ªå…ˆç´š']||'ä¸­'}</span></div><div class="text-sm text-gray-600 space-y-1"><p class="flex justify-between"><span>ç‹€æ…‹:</span> <span class="px-2 py-0.5 rounded text-xs ${isDone?'bg-green-100 text-green-800':'bg-yellow-100 text-yellow-800'}">${t['ç‹€æ…‹']}</span></p><p>è² è²¬äºº: ${t['è² è²¬äºº']||'æœªæŒ‡å®š'} ${t['æŒ‡æ´¾äºº']?`(ç”± ${t['æŒ‡æ´¾äºº']} æŒ‡æ´¾)`:''}</p><p>æˆªæ­¢: ${formatSimpleDate(t['æˆªæ­¢æ—¥æœŸ'])}</p></div></div>`;
            }).join('');
        };

        // NEW: Update case view to include manager breakdown
        // Removed duplicate updateCasesView function.
        // This version contains the logic for rendering stats and attaching listeners.
        function updateCasesView() {
            if (currentView !== 'cases') return;

            let totalCases = allCasesData.length;
            const managerCounts = {};

            allCasesData.forEach(item => {
                let manager = (item['å€‹ç®¡'] || 'æœªåˆ†é…').trim();
                if (!manager) manager = 'æœªåˆ†é…';
                managerCounts[manager] = (managerCounts[manager] || 0) + 1;
            });
            
            // Build the stats container HTML
            let statsHtml = `
                <div id="caseStatsContainer" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-4 mb-4">
                    <div class="bg-gray-800 text-white p-4 rounded-xl shadow">
                        <p class="text-xs opacity-75">ç¸½å€‹æ¡ˆæ•¸</p>
                        <p id="totalCases" class="text-2xl font-bold">${totalCases}</p>
                    </div>
            `;
            
            // Add cards for each manager, sorted by count
            Object.entries(managerCounts)
                .sort(([,a], [,b]) => b - a)
                .forEach(([manager, count]) => {
                    statsHtml += `
                        <div class="bg-white p-4 rounded-xl shadow border border-gray-100 cursor-pointer hover:shadow-md transition-all hover:bg-blue-50" onclick="window.filterByManager('${manager}')">
                            <div class="flex justify-between items-center">
                                <p class="text-xs text-gray-500 font-bold">${manager}</p>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                            </div>
                            <p class="text-2xl font-bold text-gray-800 mt-1">${count}</p>
                        </div>
                    `;
                });
            statsHtml += `</div>`;

            // Setup the page container content
             document.getElementById('pageContainer').innerHTML = `
                <div class="flex flex-col h-full">
                    ${statsHtml}
                    <div class="flex flex-col md:flex-row gap-2 mb-4">
                        <input type="text" id="searchInput" class="flex-1 w-full md:w-auto input" placeholder="æœå°‹å§“åã€å€‹ç®¡å¸«æˆ–ç—…æ­·è™Ÿ...">
                        <div class="flex gap-2">
                            <button id="allCasesFilterBtn" class="filter-btn filter-btn-active">å…¨éƒ¨å€‹æ¡ˆ</button>
                            <button id="medicationFilterBtn" class="filter-btn filter-btn-inactive">è—¥è²» > 15k</button>
                            <button id="totalFilterBtn" class="filter-btn filter-btn-inactive">ç¸½é¡ > 35k</button>
                        </div>
                    </div>
                    <div id="caseList" class="flex-1 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 overflow-y-auto">
                    </div>
                </div>
            `;

            const searchInput = document.getElementById('searchInput');
            // FIX: Changed currentCaseFilter to window.currentCaseType
            searchInput.addEventListener('input', (e) => filterAndRenderCases(e.target.value, window.currentCaseType));
            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    filterAndRenderCases(e.target.value, window.currentCaseType);
                    searchInput.blur(); // æ”¶èµ·éµç›¤
                }
            });
            document.getElementById('allCasesFilterBtn').addEventListener('click', () => filterAndRenderCases(searchInput.value, 'all'));
            document.getElementById('medicationFilterBtn').addEventListener('click', () => filterAndRenderCases(searchInput.value, 'medication'));
            document.getElementById('totalFilterBtn').addEventListener('click', () => filterAndRenderCases(searchInput.value, 'total'));

            filterAndRenderCases('', 'all');
        }

        // Keep renderCasesPage simple, it calls updateCasesView
        function renderCasesPage() { 
            updateCasesView(); 
        }
        
        window.filterByManager = (name) => {
            const searchInput = document.getElementById('searchInput');
            if(searchInput) {
                searchInput.value = name;
                // Trigger input event to refresh list
                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                // Optionally scroll to list
                document.getElementById('caseList').scrollIntoView({ behavior: 'smooth' });
                showToast(`å·²ç¯©é¸ï¼š${name}`);
            }
        }

        function renderProjectsPage() {
            const now = new Date();
            const yearOpts = [...new Set(allProjectsData.map(i=>i['æˆªæ­¢æ—¥æœŸ']?new Date(i['æˆªæ­¢æ—¥æœŸ']).getFullYear():null).filter(y=>y))].sort((a,b)=>b-a);
            if(!yearOpts.includes(now.getFullYear())) yearOpts.unshift(now.getFullYear());
            document.getElementById('pageContainer').innerHTML = `<div id="projectFilters" class="flex flex-col gap-4 mb-4"><div class="flex gap-2 flex-wrap"><button data-filter="all" class="project-group-btn filter-btn filter-btn-active">å…¨éƒ¨å°ˆæ¡ˆ</button><button data-filter="é™¢å…§" class="project-group-btn filter-btn filter-btn-inactive">é™¢å…§</button><button data-filter="é…’ç™®è¨ˆç•«" class="project-group-btn filter-btn filter-btn-inactive">é…’ç™®</button><button data-filter="ç›£æ‰€è¨ˆç•«" class="project-group-btn filter-btn filter-btn-inactive">ç›£æ‰€</button><button data-filter="ç¾æ²™å†¬è¨ˆç•«" class="project-group-btn filter-btn filter-btn-inactive">ç¾æ²™å†¬</button><button data-filter="è—¥ç™®æ•´åˆè¨ˆç•«1" class="project-group-btn filter-btn filter-btn-inactive">è—¥åˆ1</button><button data-filter="è—¥ç™®æ•´åˆè¨ˆç•«2" class="project-group-btn filter-btn filter-btn-inactive">è—¥åˆ2</button></div><div class="flex gap-2 ml-auto"><select id="projectYearFilterSelect" class="select-filter"><option value="all">æ‰€æœ‰å¹´ä»½</option>${yearOpts.map(y=>`<option value="${y}" ${y===now.getFullYear()?'selected':''}>${y} å¹´</option>`).join('')}</select><select id="projectMonthFilterSelect" class="select-filter"><option value="all">æ‰€æœ‰æœˆä»½</option>${Array.from({length:12},(_,i)=>i+1).map(m=>`<option value="${m}" ${m===now.getMonth()+1?'selected':''}>${m} æœˆ</option>`).join('')}</select></div></div><div id="projectList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div><button onclick="window.openAddProjectModal()" class="fixed bottom-12 right-12 w-16 h-16 rounded-full flex items-center justify-center text-4xl shadow-lg transition-all btn-floating">+</button>`;
            document.querySelectorAll('.project-group-btn').forEach(b => b.addEventListener('click', () => { document.querySelectorAll('.project-group-btn').forEach(x=>x.classList.replace('filter-btn-active','filter-btn-inactive')); b.classList.replace('filter-btn-inactive','filter-btn-active'); applyProjectFilters(); }));
            document.getElementById('projectYearFilterSelect').addEventListener('change', applyProjectFilters);
            document.getElementById('projectMonthFilterSelect').addEventListener('change', applyProjectFilters);
            applyProjectFilters();
        }
        function applyProjectFilters() {
            const g = document.querySelector('.project-group-btn.filter-btn-active').dataset.filter;
            const y = document.getElementById('projectYearFilterSelect').value;
            const m = document.getElementById('projectMonthFilterSelect').value;
            let d = allProjectsData;
            if (g !== 'all') d = d.filter(i => i['æ‰€å±¬å°çµ„'] === g);
            if (y !== 'all') d = d.filter(i => i['æˆªæ­¢æ—¥æœŸ'] && new Date(i['æˆªæ­¢æ—¥æœŸ']).getFullYear().toString() === y);
            if (m !== 'all') d = d.filter(i => { if(!i['æˆªæ­¢æ—¥æœŸ'])return false; const s = getCalculatedProjectStatus(i); return (new Date(i['æˆªæ­¢æ—¥æœŸ']).getMonth()+1).toString() === m || !s.isCompleted; });
            const list = document.getElementById('projectList');
            if(d.length===0) list.innerHTML='<div class="col-span-full text-center p-8 text-gray-500">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å°ˆæ¡ˆã€‚</div>';
            else list.innerHTML = d.sort((a,b)=>new Date(a['æˆªæ­¢æ—¥æœŸ'])-new Date(b['æˆªæ­¢æ—¥æœŸ'])).map(p=>{ const s=getCalculatedProjectStatus(p); return `<div class="bg-white rounded-xl shadow-lg p-6 flex flex-col gap-4 cursor-pointer border border-gray-200 hover:shadow-xl transition-shadow ${s.status==='é€¾æœŸ'?'border-red-500 border-2':''}" onclick="window.showProjectDetails('${p.ID}')" ondblclick="window.openEditProjectModal('${p.ID}')"><div class="flex justify-between items-start gap-2"><h3 class="text-xl font-bold text-link-title">${p['å°ˆæ¡ˆåç¨±']}</h3><span class="text-xs font-semibold px-2 py-1 rounded ${priorityColors[p['å„ªå…ˆç´š']]||'priority-medium'}">${p['å„ªå…ˆç´š']||'ä¸­'}</span></div><p class="text-sm text-gray-500">${p['æ‰€å±¬å°çµ„']} / ${p['ä»»å‹™é¡å‹']}</p><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="progress-bar-inner h-2.5 rounded-full" style="width: ${s.progress}%"></div></div><div class="flex justify-between text-sm"><span class="font-semibold px-2 py-1 rounded ${s.colorClass}">${s.status}</span><span>${s.completedTasks}/${s.totalTasks} å®Œæˆ</span></div><div class="text-sm text-gray-500 pt-4 border-t mt-auto"><p><strong>è² è²¬:</strong> ${p['ä¸»è¦è² è²¬']||'N/A'}</p><p><strong>æˆªæ­¢:</strong> ${formatSimpleDate(p['æˆªæ­¢æ—¥æœŸ'])}</p></div></div>`; }).join('');
        }

        window.onload = () => {
            const passwordScreen = document.getElementById('password-screen');
            const dashboardContainer = document.getElementById('dashboard-container');
            function init() {
                passwordScreen.style.display = 'none';
                dashboardContainer.classList.remove('hidden');
                loadInitialDashboardData();
                ['welcomeBtn', 'eventsBtn', 'projectsBtn', 'membersBtn', 'casesBtn', 'monitoringBtn', 'todosBtn'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.addEventListener('click', (e) => switchView(e.target.dataset.view));
                });
                setupForms();
            }
            if (sessionStorage.getItem('isLoggedIn') === 'true') init();
            else { passwordScreen.style.display = 'flex'; dashboardContainer.classList.add('hidden'); }
            document.getElementById('password-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (document.getElementById('password-input').value === 'AUD.0507') { sessionStorage.setItem('isLoggedIn', 'true'); init(); }
                else { document.getElementById('password-error').textContent = 'å¯†ç¢¼éŒ¯èª¤'; setTimeout(()=>document.getElementById('password-error').textContent='', 3000); }
            });
        };

        async function fetchData(sheet) {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            if(document.getElementById('debug-link')) document.getElementById('debug-link').href=`${appsScriptUrl}?action=GET_DATA&sheetName=${encodeURIComponent(sheet)}`;
            try {
                const res = await fetch(`${appsScriptUrl}?action=GET_DATA&sheetName=${encodeURIComponent(sheet)}&_t=${Date.now()}`);
                if(!res.ok) throw new Error(res.status);
                const json = await res.json();
                if(json.status === 'error') throw new Error(json.message);
                return json.data;
            } catch(e) { 
                console.error(e); 
                document.getElementById('connection-error-banner').classList.remove('hidden'); 
                document.getElementById('pageContainer').innerHTML = `<div class="text-center text-red-500 p-8">è³‡æ–™è¼‰å…¥å¤±æ•—: ${e.message}</div>`;
                return []; 
            } finally { document.getElementById('loadingIndicator').classList.add('hidden'); }
        }
        async function sendData(payload) {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            try {
                const res = await fetch(appsScriptUrl, { method: 'POST', body: JSON.stringify(payload), headers: {'Content-Type': 'text/plain;charset=utf-8'} });
                if(!res.ok) throw new Error(res.status);
                const json = await res.json();
                if(json.status === 'error') throw new Error(json.message);
                return json;
            } catch(e) { throw e; } finally { document.getElementById('loadingIndicator').classList.add('hidden'); }
        }
        
        async function loadInitialDashboardData() {
            document.getElementById('lastUpdated').textContent = 'æ›´æ–°ä¸­...';
            // UPDATE: Also fetch 'åœ˜éšŠæ´»å‹•' and 'å¾…è¾¦äº‹é …' initially to populate dashboard widgets
            const [m, p, mon, evts, todos] = await Promise.all([
                fetchData('åœ˜éšŠæˆå“¡'), 
                fetchData('åœ˜éšŠå°ˆæ¡ˆ'), 
                fetchData('é–€è¨ºç›£æ¸¬'),
                fetchData('åœ˜éšŠæ´»å‹•'),
                fetchData('å¾…è¾¦äº‹é …')
            ]);
            
            allMembersData = Array.isArray(m)?m:[]; 
            allProjectsData = Array.isArray(p)?p:[]; 
            allMonitoringData = Array.isArray(mon)?mon:[];
            allEventsData = Array.isArray(evts)?evts:[];
            allTodosData = Array.isArray(todos)?todos:[];

            renderWelcomePage(); 
            // Removed redundant sidebar render call
            document.getElementById('welcomeBtn').classList.add('active');
            document.getElementById('lastUpdated').textContent = `ä¸Šæ¬¡æ›´æ–°ï¼š${new Date().toLocaleTimeString('zh-TW')}`;
        }

        async function switchView(view) {
            currentView = view;
            document.querySelectorAll('.tab-button').forEach(b => b.classList.toggle('active', b.dataset.view === view));
            document.getElementById('pageContainer').innerHTML = '<div class="text-center p-8 text-gray-500">è¼‰å…¥ä¸­...</div>';
            
            // Removed sidebar toggle logic as sidebar is removed from HTML

            if(view === 'welcome') { renderWelcomePage(); } // Removed renderMembersList call
            else if(view === 'events') { if(!allEventsData.length) allEventsData = await fetchData('åœ˜éšŠæ´»å‹•'); renderEventsPage(); }
            else if(view === 'cases') { if(!allCasesData.length) allCasesData = await fetchData('é…’ç™®å€‹æ¡ˆè£œåŠ©ä½¿ç”¨è¿½è¹¤'); /* Handled by updateCasesView called immediately below */  updateCasesView(); }
            else if(view === 'projects') { if(!allProjectsData.length) allProjectsData = await fetchData('åœ˜éšŠå°ˆæ¡ˆ'); renderProjectsPage(); }
            else if(view === 'members') { renderMembersPage(); }
            else if(view === 'monitoring') { if(!allMonitoringData.length) allMonitoringData = await fetchData('é–€è¨ºç›£æ¸¬'); updateMonitoringView(); }
            else if(view === 'todos') { if(!allTodosData.length) allTodosData = await fetchData('å¾…è¾¦äº‹é …'); renderTodosPage(); }
        }

        window.populateEventContacts = (selectedNames = []) => {
            const container = document.getElementById('eventContactSelection');
            container.innerHTML = '';
            if (!allMembersData || allMembersData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm p-2">ç„¡æ³•è¼‰å…¥æˆå“¡åˆ—è¡¨ã€‚</p>';
                return;
            }
            const sortedMembers = [...allMembersData].sort((a, b) => (a['æ’åº'] || 99) - (b['æ’åº'] || 99));
            
            sortedMembers.forEach(member => {
                const name = member['å§“å'];
                if(!name) return;
                const isChecked = selectedNames.includes(name) ? 'checked' : '';
                container.innerHTML += `
                    <div class="flex items-center">
                        <input type="checkbox" id="contact_${name}" value="${name}" ${isChecked} class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="contact_${name}" class="ml-2 block text-sm text-gray-900">${name}</label>
                    </div>
                `;
            });
        };

        function addChecklistItemToForm(item = {text: '', completed: false}) {
            const input = document.getElementById('newChecklistItemInput');
            const text = (item.text || input.value).trim();
            if (text) {
                const container = document.getElementById('checklistItemContainer');
                const newItem = document.createElement('div');
                newItem.className = 'checklist-item-wrapper flex items-center justify-between bg-gray-100 p-2 rounded';
                newItem.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" class="h-4 w-4 mr-3" ${item.completed ? 'checked' : ''}>
                        <span class="checklist-item-text">${text}</span>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-700 font-bold">&times;</button>
                `;
                
                // Add event listener for auto-update logic on checkbox change
                const checkbox = newItem.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', () => {
                    const allCheckboxes = document.querySelectorAll('#checklistItemContainer input[type="checkbox"]');
                    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                    const statusSelect = document.getElementById('projectStatus');
                    
                    if (allChecked && allCheckboxes.length > 0 && (statusSelect.value === 'é€²è¡Œä¸­' || statusSelect.value === 'è¦åŠƒä¸­')) {
                        statusSelect.value = 'å·²å®Œæˆ';
                        // Optional visual feedback could be added here
                    }
                });

                newItem.querySelector('button').addEventListener('click', () => newItem.remove());
                container.appendChild(newItem);
                if (!item.text) input.value = '';
            }
        };

        function setupForms() {
            // Project
            document.getElementById('addProjectForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const btn = this.querySelector('button[type="submit"]'); btn.disabled=true; btn.textContent='å„²å­˜ä¸­...';
                const id = document.getElementById('editProjectId').value;
                
                // Get Checkpoints
                const checkpoints = Array.from(document.querySelectorAll('.checklist-item-wrapper')).map(d=>({
                    text: d.querySelector('.checklist-item-text').textContent, 
                    completed: d.querySelector('input').checked
                }));

                // Auto-update status logic
                let status = document.getElementById('projectStatus').value;
                // Only auto-complete if currently 'Processing' or 'Planning'
                if ((status === 'é€²è¡Œä¸­' || status === 'è¦åŠƒä¸­') && checkpoints.length > 0 && checkpoints.every(i => i.completed)) {
                    status = 'å·²å®Œæˆ';
                }

                const data = {
                    'ID': id || `proj_${Date.now()}`,
                    'å°ˆæ¡ˆåç¨±': document.getElementById('projectName').value,
                    'æ‰€å±¬å°çµ„': document.getElementById('projectGroup').value,
                    'ä»»å‹™é¡å‹': document.getElementById('projectType').value,
                    'å‚™è¨»': document.getElementById('projectDescription').value,
                    'ä¸»è¦è² è²¬': Array.from(document.querySelectorAll('#projectLeadSelection input:checked')).map(c=>c.value).join(', '),
                    'å”åŒè² è²¬': Array.from(document.querySelectorAll('#projectTeamSelection input:checked')).map(c=>c.value).join(', '),
                    'ç‹€æ…‹': status, // Use the potentially modified status
                    'å„ªå…ˆç´š': document.getElementById('projectPriority').value,
                    'é–‹å§‹æ—¥æœŸ': document.getElementById('startDate').value,
                    'æˆªæ­¢æ—¥æœŸ': document.getElementById('endDate').value,
                    'æª¢æŸ¥é»': JSON.stringify(checkpoints)
                };
                try {
                    await sendData({action: id?'UPDATE_PROJECT':'CREATE_PROJECT', sheetName:'åœ˜éšŠå°ˆæ¡ˆ', data});
                    if(id) { const idx = allProjectsData.findIndex(p=>p.ID===id); if(idx!==-1) allProjectsData[idx]=data; } else allProjectsData.push(data);
                    showToast('å°ˆæ¡ˆå·²å„²å­˜'); 
                    
                    // Update current view immediately
                    if(currentView === 'welcome') renderWelcomePage();
                    else if(currentView === 'projects') applyProjectFilters();
                    else if(currentView === 'members') renderMembersPage();
                    
                    window.closeModal('addProjectModal');
                } catch(e) { showToast('å¤±æ•—: '+e.message); } finally { btn.disabled=false; btn.textContent='å„²å­˜'; }
            });

            // Event
            document.getElementById('addEventForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const btn = this.querySelector('button[type="submit"]'); btn.disabled=true; btn.textContent='å„²å­˜ä¸­...';
                const id = document.getElementById('editEventId').value;
                const data = {
                    'ID': id || `evt_${Date.now()}`,
                    'æ´»å‹•åç¨±': document.getElementById('eventName').value,
                    'é¡å‹': document.getElementById('eventType').value,
                    'æ—¥æœŸ': document.getElementById('eventDate').value,
                    'é–‹å§‹æ™‚é–“': document.getElementById('eventStartTime').value,
                    'çµæŸæ™‚é–“': document.getElementById('eventEndTime').value,
                    'ä¸»è¾¦å–®ä½': document.getElementById('eventOrganizer').value,
                    'è¯çµ¡äºº': Array.from(document.querySelectorAll('#eventContactSelection input:checked')).map(c=>c.value).join(', '),
                    'å‚™è¨»': document.getElementById('eventNote').value,
                    'ä¸Šæ¬¡æ›´æ–°æ™‚é–“': new Date().toISOString()
                };
                try {
                    await sendData({action: id?'UPDATE_EVENT':'CREATE_EVENT', sheetName:'åœ˜éšŠæ´»å‹•', data});
                    if(id) { const idx = allEventsData.findIndex(x=>x.ID===id); if(idx!==-1) allEventsData[idx]=data; } else allEventsData.push(data);
                    showToast('æ´»å‹•å·²å„²å­˜'); 
                    
                    if(currentView === 'events') updateEventCalendar(); 
                    else if(currentView === 'welcome') renderWelcomePage();
                    
                    window.closeModal('addEventModal');
                } catch(e) { showToast('å¤±æ•—: '+e.message); } finally { btn.disabled=false; btn.textContent='å„²å­˜'; }
            });
            
            // Monitoring
            document.getElementById('addMonitoringForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const btn = this.querySelector('button[type="submit"]'); btn.disabled=true; btn.textContent='å„²å­˜ä¸­...';
                
                const id = document.getElementById('editMonitoringId').value;
                const isClosed = document.getElementById('monitoringIsClosed').checked;
                
                const data = {
                    'ID': id || `mon_${Date.now()}`,
                    'æ—¥æœŸ': document.getElementById('monitoringDate').value,
                    'é–€è¨º': document.getElementById('monitoringItemName').value,
                    'å·²æ›è™Ÿäººæ•¸': isClosed ? '' : (document.getElementById('monitoringRegisteredCount').value || 0),
                    'æ–°æ¡ˆ': isClosed ? '' : (document.getElementById('monitoringNewCases').value || 0),
                    'æ˜¯å¦åœè¨º': isClosed ? 'æ˜¯' : 'å¦',
                    'ä¸Šæ¬¡æ›´æ–°æ™‚é–“': new Date().toISOString()
                };
                
                try {
                    await sendData({action: id?'UPDATE_MONITORING_ITEM':'CREATE_MONITORING_ITEM', sheetName:'é–€è¨ºç›£æ¸¬', data});
                    if(id) { const idx = allMonitoringData.findIndex(m=>m.ID===id); if(idx!==-1) allMonitoringData[idx]=data; } else allMonitoringData.push(data);
                    showToast('é–€è¨ºè³‡æ–™å·²å„²å­˜'); 
                    
                    if(currentView === 'monitoring') updateMonitoringView(); 
                    else if(currentView === 'welcome') renderWelcomePage();
                    
                    window.closeModal('addMonitoringModal');
                } catch(e) { showToast('å¤±æ•—: '+e.message); } finally { btn.disabled=false; btn.textContent='å„²å­˜'; }
            });

            // Todo (è£œå›ç¼ºå¤±çš„å¾…è¾¦äº‹é …ç›£è½å™¨)
            document.getElementById('addTodoForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const btn = this.querySelector('button[type="submit"]'); btn.disabled=true; btn.textContent='å„²å­˜ä¸­...';
                const id = document.getElementById('editTodoId').value;
                const data = {
                    'ID': id || `todo_${Date.now()}`,
                    'äº‹é …': document.getElementById('todoName').value,
                    'ç‹€æ…‹': document.getElementById('todoStatus').value,
                    'å„ªå…ˆç´š': document.getElementById('todoPriority').value,
                    'æˆªæ­¢æ—¥æœŸ': document.getElementById('todoDueDate').value,
                    'è² è²¬äºº': document.getElementById('todoAssignee').value,
                    'æŒ‡æ´¾äºº': document.getElementById('todoAssigner').value,
                    'å‚™è¨»': document.getElementById('todoNote').value,
                    'ä¸Šæ¬¡æ›´æ–°æ™‚é–“': new Date().toISOString()
                };
                try {
                    await sendData({action: id?'UPDATE_TODO':'CREATE_TODO', sheetName:'å¾…è¾¦äº‹é …', data});
                    if(id) { const idx = allTodosData.findIndex(t=>t.ID===id); if(idx!==-1) allTodosData[idx]=data; } else allTodosData.push(data);
                    showToast('å¾…è¾¦äº‹é …å·²å„²å­˜'); 
                    
                    if(currentView === 'todos') renderTodosPage(); 
                    else if(currentView === 'welcome') renderWelcomePage();
                    
                    window.closeModal('addTodoModal');
                } catch(e) { showToast('å¤±æ•—: '+e.message); } finally { btn.disabled=false; btn.textContent='å„²å­˜'; }
            });

            // Wiring
            document.getElementById('selectAllTeam').addEventListener('change', e=>{ document.querySelectorAll('#projectTeamSelection input').forEach(c=>c.checked=e.target.checked) });
            document.getElementById('addChecklistItemBtn').addEventListener('click', ()=>addChecklistItemToForm());
            document.getElementById('newChecklistItemInput').addEventListener('keypress', e=>{if(e.key==='Enter'){e.preventDefault();addChecklistItemToForm()}});
            
            // Delete Handlers
            document.getElementById('deleteConfirmModal').addEventListener('click', e=>{ if(e.target.id==='deleteConfirmModal') window.closeModal('deleteConfirmModal') });
            document.getElementById('monitoringIsClosed').addEventListener('change', function() {
                const isClosed = this.checked;
                document.getElementById('monitoringRegisteredCount').disabled = isClosed;
                document.getElementById('monitoringNewCases').disabled = isClosed;
                if (isClosed) { document.getElementById('monitoringRegisteredCount').value=''; document.getElementById('monitoringNewCases').value=''; }
            });
        }

        // --- Shared & Helpers ---
        window.closeModal = id => document.getElementById(id).style.display = 'none';
        function showToast(msg) { const t=document.getElementById('toast-notification'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
        // renderMembersList function removed as it's no longer needed
        
        // This is the correct definition of filterCases
        function filterCases(type) {
            if(type) window.currentCaseType = type;
            const t = window.currentCaseType || 'all';
            const term = document.getElementById('searchInput').value.toLowerCase();
            
            const allBtn = document.getElementById('allCasesFilterBtn');
            const medBtn = document.getElementById('medicationFilterBtn');
            const totalBtn = document.getElementById('totalFilterBtn');

            if (allBtn) allBtn.className = t==='all'?'filter-btn filter-btn-active':'filter-btn filter-btn-inactive';
            if (medBtn) medBtn.className = t==='medication'?'filter-btn filter-btn-active':'filter-btn filter-btn-inactive';
            if (totalBtn) totalBtn.className = t==='total'?'filter-btn filter-btn-active':'filter-btn filter-btn-inactive';
            
            // Helper to safely convert any value to lower case string
            const safeStr = (val) => String(val || '').toLowerCase();

            const filtered = allCasesData.filter(c => {
                if(t==='medication' && (parseFloat(c['å·²ä½¿ç”¨è—¥è²»'])||0) <= 15000) return false;
                if(t==='total' && (parseFloat(c['å·²ä½¿ç”¨ç¸½é¡'])||0) <= 35000) return false;
                
                // Using safeStr prevents crash if value is a number (e.g. record number 12345)
                return !term || 
                       safeStr(c['å€‹æ¡ˆå§“å']).includes(term) || 
                       safeStr(c['ç—…æ­·è™Ÿ']).includes(term) ||
                       safeStr(c['å€‹ç®¡']).includes(term);
            }).sort((a,b)=>(parseFloat(b['å·²ä½¿ç”¨ç¸½é¡'])||0)-(parseFloat(a['å·²ä½¿ç”¨ç¸½é¡'])||0));
            
            const list = document.getElementById('caseList');
            if(!filtered.length) list.innerHTML = '<p class="col-span-full text-center text-gray-500">ç„¡è³‡æ–™</p>';
            else list.innerHTML = filtered.map(item => {
                const totalUsed = parseFloat(item['å·²ä½¿ç”¨ç¸½é¡'] || 0);
                const medicationUsed = parseFloat(item['å·²ä½¿ç”¨è—¥è²»'] || 0);
                
                let bgClass = 'bg-white';
                if (totalUsed > 35000) bgClass = 'bg-red-50';
                else if (medicationUsed > 15000) bgClass = 'bg-orange-50';

                const rawStatus = item['ç‹€æ…‹'] || item['è¨»è¨˜'] || item['è¨»è¨˜ç‹€æ…‹'];
                const status = rawStatus ? rawStatus.toString().trim().toUpperCase() : '';
                let statusHtml = '';
                if (status === 'V') {
                    // å‹¾å‹¾æ”¹å› #5b6b51
                    statusHtml = `<div class="w-8 h-8 rounded-md flex items-center justify-center text-white" style="background-color: #5b6b51;"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></div>`;
                } else if (status) {
                     statusHtml = `<div class="w-8 h-8 bg-gray-400 rounded-md flex items-center justify-center text-white font-bold">${status}</div>`;
                }

                const identityHtml = item['èº«åˆ†åˆ¥'] ? `<span class="inline-block px-2 py-0.5 rounded bg-blue-100 text-blue-800 text-xs font-bold mb-1">${item['èº«åˆ†åˆ¥']}</span>` : '';

                const medType = item['è—¥ç‰©ç¨®é¡'] || item['è—¥ç‰©ä½¿ç”¨'] || 'ç„¡';
                // è—¥ç‰©æ•¸é‡ç„¡æ¢ä»¶å»å°æ•¸é»
                const rawPills = parseFloat(item['å¯å†é–‹å¹¾ç²’']);
                const pills = isNaN(rawPills) ? (item['å¯å†é–‹å¹¾ç²’'] || 'N/A') : Math.floor(rawPills);

                return `
                <div class="${bgClass} rounded-xl shadow-sm p-5 border border-gray-100 cursor-pointer hover:shadow-md transition-all" onclick='window.showCaseDetails(${JSON.stringify(item)})'>
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 mb-1">${item['å€‹æ¡ˆå§“å']}</h3>
                            ${identityHtml}
                        </div>
                        ${statusHtml}
                    </div>
                    
                    <p class="text-gray-500 text-sm mb-4">${item['å€‹ç®¡'] || ''} / ${item['ä¸»æ²»é†«å¸«'] || ''}</p>
                    
                    <div class="border-t border-gray-200/50 pt-3 space-y-1">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500">è—¥ç‰©ç¨®é¡:</span>
                            <span class="font-bold text-gray-800">${medType}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500 text-sm">å¯å†é–‹å¹¾ç²’:</span>
                            <span class="text-xl font-bold text-gray-800">${pills}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        // Aliased function for filtering
        function filterAndRenderCases(term, type) { filterCases(type); }
        
        window.updateMonitoringView = () => { 
            const pageContainer = document.getElementById('pageContainer');
            const now = new Date();
            const yearOpts = Array.from({length:5},(_,i)=>now.getFullYear()-2+i).map(y=>`<option value="${y}" ${y===now.getFullYear()?'selected':''}>${y} å¹´</option>`).join('');
            const monthOpts = Array.from({length:12},(_,i)=>i+1).map(m=>`<option value="${m}" ${m===now.getMonth()+1?'selected':''}>${m} æœˆ</option>`).join('');
            
            pageContainer.innerHTML = `
                <div id="monitoringFilters" class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="flex gap-2 flex-wrap">
                        <button data-filter="all" class="monitoring-filter-btn filter-btn filter-btn-active">å…¨éƒ¨é–€è¨º</button>
                        <button data-filter="Y798" class="monitoring-filter-btn filter-btn filter-btn-inactive">Y798é…’ç™®(æ¨¹æ—)</button>
                        <button data-filter="Y795" class="monitoring-filter-btn filter-btn filter-btn-inactive">Y795è—¥ç™®(æ¨¹æ—)</button>
                        <button data-filter="779W" class="monitoring-filter-btn filter-btn filter-btn-inactive">779Wé…’ç™®(ç¸½é™¢)</button>
                        <button data-filter="7790" class="monitoring-filter-btn filter-btn filter-btn-inactive">7790ç²¾ç¥ç§‘(ç¸½é™¢)</button>
                        <button data-filter="7791" class="monitoring-filter-btn filter-btn filter-btn-inactive">7791ç²¾ç¥ç§‘(æ¨¹æ—)</button>
                        <button data-filter="779M" class="monitoring-filter-btn filter-btn filter-btn-inactive">779Mç¾æ²™å†¬</button>
                    </div>
                    <div class="flex gap-2 ml-auto items-center">
                        <button id="prevMonthBtn" class="btn btn-secondary px-3" title="ä¸Šå€‹æœˆ">&lt;</button>
                        <select id="monitoringYearFilterSelect" class="monitoring-filter-select select-filter">${yearOpts}</select>
                        <select id="monitoringMonthFilterSelect" class="monitoring-filter-select select-filter">${monthOpts}</select>
                        <button id="nextMonthBtn" class="btn btn-secondary px-3" title="ä¸‹å€‹æœˆ">&gt;</button>
                    </div>
                </div>
                
                <div id="monitoringCalendarHeader" class="calendar-grid mb-2 hidden md:grid">
                    ${['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].map(d=>`<div class="calendar-day-header">${d}</div>`).join('')}
                </div>
                <div id="monitoringCalendar" class="calendar-grid"></div>

                <div class="mt-6 p-4 bg-white rounded-lg border border-gray-200 shadow-sm inline-block min-w-[300px]">
                    <h4 class="font-bold text-gray-800 mb-3 text-sm border-b pb-2">é–€è¨ºæ›è™Ÿäººæ•¸å£…å¡ç¨‹åº¦åˆ†é¡ï¼š</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                        <div class="flex items-center"><span class="badge badge-level-1 w-6 h-6 mr-2 !m-0"></span><span class="text-gray-600">ç¶ è‰²ï¼ˆæ­£å¸¸ï¼‰ï¼š0â€“5 äºº</span></div>
                        <div class="flex items-center"><span class="badge badge-level-2 w-6 h-6 mr-2 !m-0"></span><span class="text-gray-600">é»ƒè‰²ï¼ˆç¨å¤šï¼‰ï¼š6â€“10 äºº</span></div>
                        <div class="flex items-center"><span class="badge badge-level-3 w-6 h-6 mr-2 !m-0"></span><span class="text-gray-600">ç´…è‰²ï¼ˆå£…å¡ï¼‰ï¼š11â€“15 äºº</span></div>
                        <div class="flex items-center"><span class="badge badge-level-4 w-6 h-6 mr-2 !m-0"></span><span class="text-gray-600">æ·±ç´…è‰²ï¼ˆæ¥µåº¦å£…å¡ï¼‰ï¼š16 äººä»¥ä¸Š</span></div>
                    </div>
                </div>

                <button id="addMonitoringItemBtn" onclick="window.openAddMonitoringModal()" class="fixed bottom-12 right-12 w-16 h-16 rounded-full flex items-center justify-center text-4xl shadow-lg transition-all btn-floating">+</button>
            `;
            
            document.querySelectorAll('.monitoring-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.monitoring-filter-btn').forEach(b => b.classList.replace('filter-btn-active', 'filter-btn-inactive'));
                    btn.classList.replace('filter-btn-inactive', 'filter-btn-active');
                    applyMonitoringFilters();
                });
            });
            document.querySelectorAll('.monitoring-filter-select').forEach(s => s.addEventListener('change', applyMonitoringFilters));
            document.getElementById('prevMonthBtn').addEventListener('click', () => changeMonitoringMonth(-1));
            document.getElementById('nextMonthBtn').addEventListener('click', () => changeMonitoringMonth(1));
            
            applyMonitoringFilters();
        }

        window.changeMonitoringMonth = (offset) => {
            const yearSelect = document.getElementById('monitoringYearFilterSelect');
            const monthSelect = document.getElementById('monitoringMonthFilterSelect');
            const newDate = new Date(parseInt(yearSelect.value), parseInt(monthSelect.value) - 1 + offset, 1);
            
            yearSelect.value = newDate.getFullYear();
            monthSelect.value = newDate.getMonth() + 1;
            applyMonitoringFilters();
        }

        window.applyMonitoringFilters = () => {
            const clinicFilter = document.querySelector('.monitoring-filter-btn.filter-btn-active').dataset.filter;
            const year = parseInt(document.getElementById('monitoringYearFilterSelect').value);
            const month = parseInt(document.getElementById('monitoringMonthFilterSelect').value);
            
            let filteredData = allMonitoringData;
            if (clinicFilter !== 'all') {
                filteredData = filteredData.filter(item => item['é–€è¨º'] && item['é–€è¨º'].startsWith(clinicFilter));
            }
            
            renderMonitoringCalendar(year, month, filteredData);
        }

        window.renderMonitoringCalendar = (year, month, data) => {
            const container = document.getElementById('monitoringCalendar');
            container.innerHTML = '';
            
            let firstDay = new Date(year, month - 1, 1).getDay(); firstDay = (firstDay === 0) ? 6 : (firstDay - 1);
            const daysInMonth = new Date(year, month, 0).getDate();

            for (let i = 0; i < firstDay; i++) container.innerHTML += `<div class="calendar-day-empty hidden md:block"></div>`;

            for (let day = 1; day <= daysInMonth; day++) {
                const isoDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const itemsForThisDay = data.filter(item => item['æ—¥æœŸ'] && item['æ—¥æœŸ'].startsWith(isoDate));

                let dailyTotal = 0;
                itemsForThisDay.forEach(item => {
                    if (item['æ˜¯å¦åœè¨º'] !== 'æ˜¯') {
                        dailyTotal += parseInt(item['å·²æ›è™Ÿäººæ•¸'] || 0, 10);
                    }
                });

                const badgesHtml = itemsForThisDay.map(item => {
                    const registered = parseInt(item['å·²æ›è™Ÿäººæ•¸'] || 0, 10);
                    let badgeClass = '';
                    if (item['æ˜¯å¦åœè¨º'] === 'æ˜¯') badgeClass = 'badge-closed';
                    else if (registered >= 16) badgeClass = 'badge-level-4';
                    else if (registered >= 11) badgeClass = 'badge-level-3';
                    else if (registered >= 6) badgeClass = 'badge-level-2';
                    else badgeClass = 'badge-level-1';

                    let badgeText = 'è¨º';
                    if (item['æ˜¯å¦åœè¨º'] === 'æ˜¯') badgeText = 'åœ';
                    else if (item['é–€è¨º'].includes('é…’')) badgeText = 'é…’';
                    else if (item['é–€è¨º'].includes('è—¥')) badgeText = 'è—¥';
                    else if (item['é–€è¨º'].includes('ç²¾ç¥')) badgeText = 'ç²¾';
                    
                    return `<span class="badge ${badgeClass}">${badgeText}</span>`;
                }).join('');
                
                const totalDisplay = dailyTotal > 0 
                    ? `<span class="text-xs font-bold text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded ml-1">${dailyTotal}äºº</span>` 
                    : '';
                
                container.innerHTML += `
                    <div class="calendar-day">
                        <div class="day-content" onclick="window.showMonitoringDetailsForDay('${isoDate}')">
                            <div class="flex justify-between items-start mb-1">
                                <span class="day-number">${day}</span>
                                ${totalDisplay}
                            </div>
                            <div class="badge-container">${badgesHtml}</div>
                        </div>
                    </div>
                `;
            }
        }

        window.showMonitoringDetailsForDay = (isoDate) => {
            const modal = document.getElementById('monitoringDayDetailModal');
            document.getElementById('monitoringDayDetailTitle').textContent = `${formatSimpleDate(isoDate)} é–€è¨ºè©³æƒ…`;
            const content = document.getElementById('monitoringDayDetailContent');
            
            const items = allMonitoringData.filter(i => i['æ—¥æœŸ'] && i['æ—¥æœŸ'].startsWith(isoDate)).sort((a,b)=>(a['é–€è¨º']||'').localeCompare(b['é–€è¨º']));
            
            if(items.length === 0) { content.innerHTML = '<p class="text-gray-500">ç„¡é–€è¨ºè³‡æ–™</p>'; }
            else {
                content.innerHTML = items.map(item => {
                    const isClosed = item['æ˜¯å¦åœè¨º'] === 'æ˜¯';
                    const reg = parseInt(item['å·²æ›è™Ÿäººæ•¸'] || 0);
                    let border = isClosed ? 'monitor-border-closed' : (reg>=16?'monitor-border-level-4':(reg>=11?'monitor-border-level-3':(reg>=6?'monitor-border-level-2':'monitor-border-level-1')));
                    return `
                    <div class="bg-white ${border} rounded-xl shadow-lg p-6 mb-4 cursor-pointer border border-gray-200 hover:shadow-xl transition-shadow" onclick="window.closeModal('monitoringDayDetailModal');window.openEditMonitoringModal('${item.ID}')">
                        <div class="flex justify-between items-start gap-2 mb-2"><h3 class="text-xl font-bold text-link-title flex items-center gap-2">${item['é–€è¨º']} <span class="text-xs text-blue-500">âœï¸</span></h3></div>
                        ${isClosed ? `<div class="text-center p-2"><p class="text-xl font-bold text-gray-500">æœ¬æ—¥åœè¨º</p></div>` : 
                        `<div class="grid grid-cols-2 gap-4 text-center"><div><p class="text-2xl font-bold text-gray-800">${reg}</p><p class="text-xs text-gray-500">å·²æ›è™Ÿ</p></div><div><p class="text-2xl font-bold text-gray-800">${item['æ–°æ¡ˆ']||0}</p><p class="text-xs text-gray-500">æ–°æ¡ˆ</p></div></div>`}
                    </div>`;
                }).join('');
            }
            modal.style.display = 'flex';
        }

        window.openAddMonitoringModal = () => { document.getElementById('addMonitoringForm').reset(); document.getElementById('editMonitoringId').value=''; document.getElementById('monitoringModalTitle').textContent='æ–°å¢é–€è¨ºé …ç›®'; document.getElementById('monitoringIsClosed').checked=false; document.getElementById('monitoringRegisteredCount').disabled=false; document.getElementById('monitoringNewCases').disabled=false; document.getElementById('formDeleteMonitoringBtn').style.display='none'; document.getElementById('addMonitoringModal').style.display='flex'; }
        
        window.openEditMonitoringModal = (id) => {
            const item = allMonitoringData.find(m=>m.ID===id); if(!item)return;
            document.getElementById('addMonitoringForm').reset(); document.getElementById('editMonitoringId').value=id; document.getElementById('monitoringModalTitle').textContent='ç·¨è¼¯é–€è¨ºé …ç›®';
            document.getElementById('monitoringItemName').value = item['é–€è¨º']; document.getElementById('monitoringDate').value = toISODateString(item['æ—¥æœŸ']); document.getElementById('monitoringRegisteredCount').value = item['å·²æ›è™Ÿäººæ•¸']; document.getElementById('monitoringNewCases').value = item['æ–°æ¡ˆ'];
            const isClosed = item['æ˜¯å¦åœè¨º']==='æ˜¯';
            document.getElementById('monitoringIsClosed').checked = isClosed;
            document.getElementById('monitoringRegisteredCount').disabled = isClosed; document.getElementById('monitoringNewCases').disabled = isClosed;
            
            const del = document.getElementById('formDeleteMonitoringBtn'); del.style.display='inline-block'; del.onclick=()=>window.openDeleteConfirmModal(id, 'monitoring');
            document.getElementById('addMonitoringModal').style.display='flex';
        }
        
        window.executeDeleteMonitoringItem = async (id) => { 
            window.closeModal('deleteConfirmModal');
            showToast('æ­£åœ¨åˆªé™¤...');
            try { 
                await sendData({action:'DELETE_MONITORING_ITEM', sheetName:'é–€è¨ºç›£æ¸¬', id}); 
                allMonitoringData=allMonitoringData.filter(m=>m.ID!==id); 
                window.closeModal('addMonitoringModal'); 
                window.closeModal('monitoringDayDetailModal');
                showToast('å·²åˆªé™¤'); 
                if(currentView === 'monitoring') updateMonitoringView();
                else if(currentView === 'welcome') renderWelcomePage();
            } catch(e){
                showToast('å¤±æ•—');
            } 
        }

        window.openAddProjectModal = () => {
            document.getElementById('addProjectForm').reset(); document.getElementById('editProjectId').value=''; document.getElementById('projectModalTitle').textContent='æ–°å¢é …ç›®'; document.getElementById('checklistItemContainer').innerHTML=''; window.populateMemberSelection(); document.getElementById('addProjectModal').style.display='flex';
        }
        window.openEditProjectModal = (id) => {
            const p = allProjectsData.find(x=>x.ID===id); if(!p)return;
            document.getElementById('addProjectForm').reset(); document.getElementById('editProjectId').value=id; document.getElementById('projectModalTitle').textContent='ç·¨è¼¯é …ç›®';
            document.getElementById('projectName').value = p['å°ˆæ¡ˆåç¨±']; document.getElementById('projectGroup').value = p['æ‰€å±¬å°çµ„']; document.getElementById('projectType').value = p['ä»»å‹™é¡å‹']; document.getElementById('projectDescription').value = p['å‚™è¨»']; document.getElementById('projectStatus').value = p['ç‹€æ…‹']; document.getElementById('projectPriority').value = p['å„ªå…ˆç´š']; document.getElementById('startDate').value = toISODateString(p['é–‹å§‹æ—¥æœŸ']); document.getElementById('endDate').value = toISODateString(p['æˆªæ­¢æ—¥æœŸ']);
            window.populateMemberSelection((p['ä¸»è¦è² è²¬']||'').split(', '),(p['å”åŒè² è²¬']||'').split(', '));
            const c = document.getElementById('checklistItemContainer'); c.innerHTML='';
            try { JSON.parse(p['æª¢æŸ¥é»']||'[]').forEach(addChecklistItemToForm); } catch(e){}
            document.getElementById('addProjectModal').style.display='flex';
        }
        window.populateMemberSelection = (leads=[], teams=[]) => {
            const l=document.getElementById('projectLeadSelection'), t=document.getElementById('projectTeamSelection'); l.innerHTML=t.innerHTML='';
            allMembersData.forEach(m=>{ const n=m['å§“å']; l.innerHTML+=`<div><input type="checkbox" value="${n}" ${leads.includes(n)?'checked':''}><span class="ml-2">${n}</span></div>`; t.innerHTML+=`<div><input type="checkbox" value="${n}" ${teams.includes(n)?'checked':''}><span class="ml-2">${n}</span></div>`; });
        }
        window.showProjectDetails = (id) => {
             const p = allProjectsData.find(x=>x.ID===id); if(!p) return;
             document.getElementById('detailProjectName').textContent = p['å°ˆæ¡ˆåç¨±'];
             const s = getCalculatedProjectStatus(p);
             document.getElementById('detailProjectProgress').innerHTML = `<div class="flex justify-between mb-1 text-sm text-gray-700"><span>å®Œæˆé€²åº¦</span><span>${Math.round(s.progress)}%</span></div><div class="w-full bg-gray-200 h-4 rounded-full"><div class="bg-blue-600 h-4 rounded-full" style="width:${s.progress}%"></div></div>`;
             document.getElementById('projectDetailContent').innerHTML = `<p>ç‹€æ…‹: ${p['ç‹€æ…‹']}</p><p>æ—¥æœŸ: ${formatSimpleDate(p['é–‹å§‹æ—¥æœŸ'])} - ${formatSimpleDate(p['æˆªæ­¢æ—¥æœŸ'])}</p><p>è² è²¬: ${p['ä¸»è¦è² è²¬']}</p><p>å‚™è¨»: ${p['å‚™è¨»']||'ç„¡'}</p>`;
             const c = document.getElementById('detailProjectChecklist'); c.innerHTML = '<h4>æª¢æŸ¥é»</h4>';
             try { JSON.parse(p['æª¢æŸ¥é»']||'[]').forEach(i => c.innerHTML+=`<div class="flex items-center gap-2"><input type="checkbox" disabled ${i.completed?'checked':''}><span class="${i.completed?'line-through text-gray-500':''}">${i.text}</span></div>`); } catch(e){}
             const edit = document.getElementById('editProjectBtn'); edit.style.display='inline-block'; edit.onclick=()=>window.openEditProjectModal(id);
             const del = document.getElementById('deleteProjectBtn'); del.style.display='inline-block'; del.onclick=()=>window.openDeleteConfirmModal(id, 'project');
             document.getElementById('projectDetailModal').style.display='flex';
        }
        window.executeDeleteProject = async (id) => { 
            window.closeModal('deleteConfirmModal');
            showToast('æ­£åœ¨åˆªé™¤...');
            try { 
                await sendData({action:'DELETE_PROJECT', sheetName:'åœ˜éšŠå°ˆæ¡ˆ', id}); 
                allProjectsData=allProjectsData.filter(x=>x.ID!==id); 
                window.closeModal('projectDetailModal');
                window.closeModal('addProjectModal');
                showToast('å·²åˆªé™¤'); 
                applyProjectFilters();
                if(currentView === 'welcome') renderWelcomePage();
                else if(currentView === 'members') renderMembersPage();
            } catch(e){
                showToast('å¤±æ•—');
            } 
        }

        window.openAddEventModal = function(date = '') {
            document.getElementById('addEventForm').reset();
            document.getElementById('editEventId').value = '';
            document.getElementById('eventModalTitle').textContent = 'æ–°å¢æ´»å‹•';
            document.getElementById('eventDate').value = date || toISODateString(new Date().toISOString());
            window.populateEventContacts([]);
            document.getElementById('formDeleteEventBtn').style.display = 'none';
            document.getElementById('addEventModal').style.display = 'flex';
        }
        window.openEditEventModal = function(id) {
            const e = allEventsData.find(x=>x.ID===id); if(!e) return;
            document.getElementById('addEventForm').reset();
            document.getElementById('editEventId').value = id;
            document.getElementById('eventModalTitle').textContent = 'ç·¨è¼¯æ´»å‹•';
            document.getElementById('eventName').value = e['æ´»å‹•åç¨±'];
            document.getElementById('eventType').value = e['é¡å‹'] || 'æ´»å‹•';
            document.getElementById('eventDate').value = toISODateString(e['æ—¥æœŸ']);
            document.getElementById('eventStartTime').value = formatTime(e['é–‹å§‹æ™‚é–“']) || '';
            document.getElementById('eventEndTime').value = formatTime(e['çµæŸæ™‚é–“']) || '';
            
            document.getElementById('eventOrganizer').value = e['ä¸»è¾¦å–®ä½'] || '';
            document.getElementById('eventNote').value = e['å‚™è¨»'] || '';
            const contacts = (e['è¯çµ¡äºº'] || '').split(',').map(s => s.trim());
            window.populateEventContacts(contacts);
            const del = document.getElementById('formDeleteEventBtn');
            del.style.display = 'inline-block';
            del.onclick = () => window.openDeleteConfirmModal(id, 'event');
            document.getElementById('addEventModal').style.display = 'flex';
        }
        window.executeDeleteEvent = async function(id) {
            window.closeModal('deleteConfirmModal');
            showToast('æ­£åœ¨åˆªé™¤...');
            try { 
                await sendData({action:'DELETE_EVENT', sheetName:'åœ˜éšŠæ´»å‹•', id}); 
                allEventsData = allEventsData.filter(x=>x.ID!==id); 
                window.closeModal('addEventModal'); 
                showToast('å·²åˆªé™¤'); 
                if(currentView === 'events') updateEventCalendar(); 
                else if(currentView === 'welcome') renderWelcomePage();
            } catch(e) { 
                showToast('åˆªé™¤å¤±æ•—'); 
            }
        }
        
        window.openDeleteConfirmModal = (id, type) => {
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            if (type === 'project') {
                confirmBtn.onclick = () => window.executeDeleteProject(id);
            } else if (type === 'monitoring') {
                confirmBtn.onclick = () => window.executeDeleteMonitoringItem(id);
            } else if (type === 'todo') {
                confirmBtn.onclick = () => window.executeDeleteTodo(id);
            } else if (type === 'event') {
                confirmBtn.onclick = () => window.executeDeleteEvent(id);
            }
            document.getElementById('deleteConfirmModal').style.display = 'flex';
        }

        window.executeDeleteTodo = async (todoId) => {
            window.closeModal('deleteConfirmModal');
            showToast('æ­£åœ¨åˆªé™¤...');
            const payload = { action: 'DELETE_TODO', id: todoId, sheetName: 'å¾…è¾¦äº‹é …' };
            try {
                await sendData(payload);
                allTodosData = allTodosData.filter(t => t.ID !== todoId);
                renderTodosPage(); 
                window.closeModal('addTodoModal');
                showToast('å¾…è¾¦äº‹é …å·²æˆåŠŸåˆªé™¤ï¼');
            } catch (error) {
                showToast(`åˆªé™¤å¤±æ•—: ${error.message}`);
            }
        }

        window.showCaseDetails = (item) => { 
             document.getElementById('caseModalCaseName').textContent = item['å€‹æ¡ˆå§“å'] || 'ç„¡è³‡æ–™';
             document.getElementById('caseModalIdentity').textContent = item['èº«åˆ†åˆ¥'] || '';
             document.getElementById('caseModalRecordNumber').textContent = item['ç—…æ­·è™Ÿ'] || 'ç„¡';
             document.getElementById('caseModalManagerDoctor').textContent = `${item['å€‹ç®¡'] || 'æœªåˆ†é…'} / ${item['ä¸»æ²»é†«å¸«'] || 'æœªåˆ†é…'}`;
             document.getElementById('caseModalRecentStatus').textContent = item['è¿‘æ³èªªæ˜'] || 'ç„¡';
             
             document.getElementById('caseModalTotalUsed').textContent = formatCurrency(item['å·²ä½¿ç”¨ç¸½é¡'] || 0);
             // è¨ˆç®—ç¸½é¡é¤˜é¡: é è¨­ä¸Šé™ 35000 (å¯æ ¹æ“šéœ€æ±‚èª¿æ•´) - å·²ä½¿ç”¨
             const totalLimit = 35000;
             const totalUsed = parseFloat(item['å·²ä½¿ç”¨ç¸½é¡'] || 0);
             document.getElementById('caseModalTotalRemaining').textContent = formatCurrency(totalLimit - totalUsed);
             
             document.getElementById('caseModalMedicationUsed').textContent = formatCurrency(item['å·²ä½¿ç”¨è—¥è²»'] || 0);
             // è¨ˆç®—è—¥è²»é¤˜é¡: é è¨­ä¸Šé™ 15000 - å·²ä½¿ç”¨
             const medLimit = 15000;
             const medUsed = parseFloat(item['å·²ä½¿ç”¨è—¥è²»'] || 0);
             document.getElementById('caseModalMedicationRemaining').textContent = formatCurrency(medLimit - medUsed);
             
             document.getElementById('caseModalMedicationType').textContent = item['è—¥ç‰©ç¨®é¡'] || item['è—¥ç‰©ä½¿ç”¨'] || 'ç„¡';
             const pills = parseFloat(item['å¯å†é–‹å¹¾ç²’']);
             document.getElementById('caseModalPillsRemaining').textContent = isNaN(pills) ? (item['å¯å†é–‹å¹¾ç²’'] || 'N/A') : Math.floor(pills);
             
             document.getElementById('caseModal').style.display = 'flex'; 
        }

        // ============================================
        // MEMBER PAGE LOGIC START
        // ============================================
        function renderMembersPage() {
            const pageContainer = document.getElementById('pageContainer');
            
            // Group members by job title
            const groupedMembers = {};
            // Define desired sort order
            const sortOrder = ['é†«å¸«', 'é…’ç™®è¨ˆç•«', 'ç›£æ‰€è¨ˆç•«', 'è—¥ç™®æ•´åˆè¨ˆç•«1', 'è—¥ç™®æ•´åˆè¨ˆç•«2', 'ç¾æ²™å†¬è¨ˆç•«', 'é™¢å…§', 'å…¶ä»–'];
            
            allMembersData.forEach(member => {
                let groupKey = 'å…¶ä»–';
                const title = (member['è·ç¨±'] || '').trim();
                const businessType = (member['æ¥­å‹™é¡åˆ¥'] || '').trim(); // Ensure safe string access

                if (title === 'é†«å¸«') {
                    groupKey = 'é†«å¸«';
                } else if (businessType) {
                    groupKey = businessType;
                } else {
                    // Fallback to title or 'å…¶ä»–' if businessType is missing
                    groupKey = title || 'å…¶ä»–';
                }

                if (!groupedMembers[groupKey]) groupedMembers[groupKey] = [];
                groupedMembers[groupKey].push(member);
            });
            
            // Generate HTML
            let html = `<h2 class="text-2xl font-bold text-gray-800 mb-6">åœ˜éšŠæˆå“¡åéŒ„</h2><div class="space-y-8">`;
            
            // Sort keys
            const sortedTitles = Object.keys(groupedMembers).sort((a, b) => {
                const idxA = sortOrder.indexOf(a);
                const idxB = sortOrder.indexOf(b);
                
                // If both are in the sort list, compare indices
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                
                // If one is in the list, it comes first
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                
                // If neither is in the list, sort alphabetically
                return a.localeCompare(b, 'zh-TW');
            });

            if (sortedTitles.length === 0) {
                html += `<div class="text-gray-500">ç›®å‰æ²’æœ‰æˆå“¡è³‡æ–™ã€‚</div>`;
            }
            
            sortedTitles.forEach(title => {
                const members = groupedMembers[title].sort((a, b) => (parseInt(a['æ’åº']) || 99) - (parseInt(b['æ’åº']) || 99));
                
                // Determine color class based on group name
                let colorClass = jobTitleColors[title] || 'job-color-default';
                
                // Fallback color logic for new business categories
                if (colorClass === 'job-color-default') {
                    if (title.includes('é†«å¸«')) colorClass = 'job-color-1';
                    else if (title.includes('å¿ƒç†å¸«')) colorClass = 'job-color-2';
                    else if (title.includes('ç¤¾å·¥')) colorClass = 'job-color-5';
                    else if (title.includes('å€‹ç®¡')) colorClass = 'job-color-3';
                    else if (title.includes('é…’ç™®')) colorClass = 'job-color-2'; 
                    else if (title.includes('ç›£æ‰€')) colorClass = 'job-color-3';
                    else if (title.includes('è—¥ç™®')) colorClass = 'job-color-4';
                    else if (title.includes('ç¾æ²™å†¬')) colorClass = 'job-color-5';
                }
                
                html += `
                    <div>
                        <h3 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4 flex items-center">
                            ${title} 
                            <span class="text-sm font-normal text-gray-500 ml-2 bg-gray-100 px-2 py-0.5 rounded-full">
                                ${members.length} äºº
                            </span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                `;
                
                members.forEach(member => {
                    const memberName = member['å§“å'] || '';
                    // Find active projects for this member (using corrected status check)
                    const activeProjects = allProjectsData.filter(p => {
                        const s = getCalculatedProjectStatus(p);
                        return !s.isCompleted && 
                        ((p['ä¸»è¦è² è²¬'] || '').includes(memberName) || 
                        (p['å”åŒè² è²¬'] || '').includes(memberName));
                    });

                    const note = member['å‚™è¨»'] || 'æš«ç„¡å‚™è¨»';
                    const jobTitle = member['è·ç¨±'] || '';
                    
                    html += `
                        <div class="bg-white rounded-xl shadow-md p-5 border-l-4 ${colorClass} hover:shadow-lg transition-all transform hover:-translate-y-1">
                            <div class="flex justify-between items-center mb-3">
                                <div>
                                    <h4 class="text-lg font-bold text-gray-900">${memberName}</h4>
                                    <p class="text-xs text-gray-500 font-medium">${jobTitle}</p>
                                </div>
                            </div>
                            
                            <div class="mb-3 min-h-[3rem]">
                                <p class="text-xs text-gray-500 font-bold mb-1.5">é€²è¡Œä¸­å°ˆæ¡ˆï¼š</p>
                                ${activeProjects.length > 0 ? 
                                    `<div class="flex flex-wrap gap-1.5">
                                        ${activeProjects.map(p => `<span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100 cursor-pointer hover:bg-blue-100 transition-colors" onclick="window.showProjectDetails('${p.ID}')" title="é»æ“ŠæŸ¥çœ‹å°ˆæ¡ˆè©³æƒ…">${p['å°ˆæ¡ˆåç¨±']}</span>`).join('')}
                                    </div>` : 
                                    `<p class="text-xs text-gray-400 italic">ç›®å‰ç„¡é€²è¡Œä¸­é …ç›®</p>`
                                }
                            </div>

                            <div class="pt-3 border-t border-gray-50">
                                <p class="text-xs text-gray-400 line-clamp-2" title="${note}">
                                    ${note === 'æš«ç„¡å‚™è¨»' ? '<span class="italic opacity-50">æš«ç„¡å‚™è¨»</span>' : note}
                                </p>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            html += `</div>`;
            pageContainer.innerHTML = html;
        }
        // ============================================
        // MEMBER PAGE LOGIC END
        // ============================================

    </script>
</body>
</html>
